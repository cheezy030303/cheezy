/**
 * 設定ファイル
 * 実際の使用時には、このファイルの値を更新してください
 */

/**
 * アプリケーション全体の設定を返す
 */
function getConfig() {
  // スプレッドシートIDを取得
  const spreadsheetId = '1d_7Tq1m5TLoejzaTAW3woPGv4KSf4_ONIyL3ufFPwhI';
  
  // メールアドレスシートから動的に社員データを取得
  const employeeData = getEmployeeDataFromSheet(spreadsheetId);
  
  return {
    // ============================================
    // カレンダー設定
    // ============================================
    
    // 会社の共有カレンダーのID（メールアドレスシートから動的取得）
    CALENDAR_ID: employeeData.CALENDAR_ID,
    
    // 過去何日分のイベントを取得するか（現在は使用していません。前日のみをチェックします）
    LOOKBACK_DAYS: 7,
    
    // ============================================
    // マーケティング部メンバー設定（メールアドレスシートから動的取得）
    // ============================================
    
    // マーケティング部のメンバーのメールアドレスリスト（BC列から取得）
    MARKETING_TEAM: employeeData.MARKETING_TEAM,
    
    // パートメンバーのメールアドレスリスト（IJ列から取得）
    PART_TIMER_TEAM: employeeData.PART_TIMER_TEAM,
    
    // メールアドレスから担当者名へのマッピング（メールアドレスシートから動的生成）
    EMAIL_TO_NAME: employeeData.EMAIL_TO_NAME,
    
    // メールアドレスからチャットワークIDへのマッピング（A、D、H列から取得）
    EMAIL_TO_CHATWORK_ID: employeeData.EMAIL_TO_CHATWORK_ID,
    
    // 担当者から除外したいメールアドレス（例: 代理カレンダー）
    EXCLUDED_RESPONSIBLE_EMAILS: [
      'ibi-h@mirai-kirei.jp'
    ],
    
    // イベントタイトルに含まれていたら除外したいキーワード
    EXCLUDED_TITLE_KEYWORDS: [
      'あんこプロジェクト'
    ],
    
    // ============================================
    // MKシステム設定
    // ============================================
    
    MK_SYSTEM: {
      // MKシステムのAPIエンドポイント
      API_ENDPOINT: 'https://mk-system.example.com/api/meetings',
      
      // APIキーまたは認証トークン
      // 注意: 本番環境ではScript Propertiesを使用することを推奨
      API_KEY: 'your-api-key-here',
      
      // 認証方法のタイプ（'bearer' または 'apikey'）
      AUTH_TYPE: 'bearer',
      
      // 追加のリクエストヘッダー
      ADDITIONAL_HEADERS: {
        // 'X-Custom-Header': 'value',
      },
      
      // 追加フィールド（MKシステムが要求する場合）
      ADDITIONAL_FIELDS: {
        // 'department': 'マーケティング部',
        // 'category': 'クライアントミーティング',
        // 'status': 'scheduled',
      },
      
      // フィールドマッピング（カレンダーのデータをMKシステムのフィールド名に変換）
      // 空のオブジェクトの場合は、デフォルトのフィールド名を使用します
      // MKシステムのAPI仕様に合わせて調整してください
      FIELD_MAPPING: {
        // 例:
        // 'date': 'meeting_date',
        // 'client_name': 'client',
        // 'responsible_person': 'responsible',
        // 'title': 'title',
        // 'description': 'notes',
      }
    },
    
    // MKシステムの手動登録状況を管理しているスプレッドシート
    MK_REGISTRATION_SHEET: {
      // MKシステムで登録済みの議事録を記録しているスプレッドシートのID
      SPREADSHEET_ID: '',
      // GASがアクセスできる同一スプレッドシート内に手動貼り付けする場合のシート名
      LOCAL_SHEET_NAME: 'MK登録済み一覧',
      // 外部スプレッドシートを参照する場合のシート名
      SHEET_NAME: 'MK議事録',
      // ヘッダー名（MK登録済み一覧シート側）の指定
      DATE_COLUMN: '実施日',        // MK登録済み一覧シートのC列
      EMPLOYEE_NAME_COLUMN: '従業員名',  // MK登録済み一覧シートのN列
      CLIENT_NAME_COLUMN: '顧客名',    // MK登録済み一覧シートのO列（チャットワークリマインド用）
      // ステータス欄に表示する値（例: 済）
      STATUS_VALUE: '済'
    },
    
    // ============================================
    // スプレッドシート設定
    // ============================================
    
    // スプレッドシートID（空の場合は自動的に新しいスプレッドシートを作成）
    // 既存のスプレッドシートを使用する場合、URLからIDを取得してください
    // 例: https://docs.google.com/spreadsheets/d/[SPREADSHEET_ID]/edit
    SPREADSHEET_ID: '1d_7Tq1m5TLoejzaTAW3woPGv4KSf4_ONIyL3ufFPwhI',
    
    // スプレッドシート名（新規作成時に使用）
    SPREADSHEET_NAME: '議事録一覧',
    
    // スプレッドシートのシート名
    SHEET_NAME: '議事録',
    // MKシステムへの登録状況を表示する列のヘッダー
    REGISTRATION_STATUS_HEADER: 'MK登録状況',
    // 担当者メールアドレス列のヘッダー
    RESPONSIBLE_EMAIL_HEADER: '担当者メールアドレス',
    // 参加者列のヘッダー
    PARTICIPANT_HEADER: '参加者',
    // 場所列のヘッダー
    LOCATION_HEADER: '場所',
    
    // チャットワーク連携設定
    CHATWORK: {
      ENABLED: true, // trueにするとリマインド送信を有効化
      // API_TOKEN と ROOM_ID はスクリプトプロパティから取得
      REMINDER_TEMPLATE: "お疲れ様です。\n\n議事録のアップが確認できておりません。\n\nまた、対応完了しているのに、こちらのチャットで連絡が入っている場合は、\n\n見落としの可能性もありますので、恐れ入りますが、ご連絡いただけますと幸いです。\n\n※議事録不要の場合にも、お手数ですがその旨お伝えください。\n\n----------------------------------------------------------------------------\n\n%DETAILS%\n\n------------------------------------------------------------------"
    },
    
    // ============================================
    // その他の設定
    // ============================================
    
    // タイムゾーン
    TIMEZONE: 'Asia/Tokyo',
    
    // ログ出力レベル（'INFO', 'WARNING', 'ERROR'）
    LOG_LEVEL: 'INFO',
    
    // テストモード（trueの場合、実際にMKシステムに登録しない）
    TEST_MODE: false
  };
}

/**
 * セキュアな設定（Script Propertiesを使用）
 * APIキーなどの機密情報はScript Propertiesに保存することを推奨
 */
function getSecureConfig() {
  const properties = PropertiesService.getScriptProperties();
  
  return {
    MK_SYSTEM: {
      API_ENDPOINT: properties.getProperty('MK_API_ENDPOINT') || getConfig().MK_SYSTEM.API_ENDPOINT,
      API_KEY: properties.getProperty('MK_API_KEY') || getConfig().MK_SYSTEM.API_KEY,
    }
  };
}

/**
 * Script Propertiesの設定方法：
 * 
 * 1. GASエディタで「プロジェクトの設定」→「スクリプト プロパティ」を開く
 * 2. 以下のプロパティを追加：
 *    - MK_API_ENDPOINT: MKシステムのAPIエンドポイント
 *    - MK_API_KEY: MKシステムのAPIキー
 *    - CHATWORK_API_TOKEN: チャットワークのAPIトークン
 *    - CHATWORK_ROOM_ID: チャットワークのルームID（例: 138351493）
 */

/**
 * メールアドレスシートから社員データを動的に取得
 * @param {String} spreadsheetId - スプレッドシートID
 * @return {Object} 社員データオブジェクト
 */
function getEmployeeDataFromSheet(spreadsheetId) {
  try {
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    const emailSheet = spreadsheet.getSheetByName('メールアドレス');
    
    if (!emailSheet) {
      Logger.log('メールアドレスシートが見つかりません');
      return getDefaultEmployeeData();
    }
    
    const lastRow = emailSheet.getLastRow();
    if (lastRow <= 1) {
      Logger.log('メールアドレスシートにデータがありません');
      return getDefaultEmployeeData();
    }
    
    const dataRange = emailSheet.getRange(2, 1, lastRow - 1, 10).getValues(); // A-J列を取得
    
    const marketingTeam = [];
    const otherEmployees = [];
    const partTimers = [];
    const emailToName = {};
    const emailToChatworkId = {};
    const allCalendarIds = [];
    
    dataRange.forEach(row => {
      // A列: マーケティング部のチャットワークID, BC列: マーケティング部社員
      const marketingChatworkId = row[0] ? row[0].toString().trim() : '';
      const marketingName = row[1] ? row[1].toString().trim() : '';
      const marketingEmail = row[2] ? row[2].toString().trim() : '';
      if (marketingName && marketingEmail) {
        marketingTeam.push(marketingEmail);
        emailToName[marketingEmail] = marketingName;
        if (marketingChatworkId) {
          emailToChatworkId[marketingEmail] = marketingChatworkId;
        }
        allCalendarIds.push(marketingEmail);
      }
      
      // D列: その他社員のチャットワークID, EF列: マーケティング部以外の社員
      const otherChatworkId = row[3] ? row[3].toString().trim() : '';
      const otherName = row[4] ? row[4].toString().trim() : '';
      const otherEmail = row[5] ? row[5].toString().trim() : '';
      if (otherName && otherEmail) {
        otherEmployees.push(otherEmail);
        emailToName[otherEmail] = otherName;
        if (otherChatworkId) {
          emailToChatworkId[otherEmail] = otherChatworkId;
        }
        allCalendarIds.push(otherEmail);
      }
      
      // H列: パートのチャットワークID, IJ列: パート
      const partChatworkId = row[7] ? row[7].toString().trim() : '';
      const partName = row[8] ? row[8].toString().trim() : '';
      const partEmail = row[9] ? row[9].toString().trim() : '';
      if (partName && partEmail) {
        partTimers.push(partEmail);
        emailToName[partEmail] = partName;
        if (partChatworkId) {
          emailToChatworkId[partEmail] = partChatworkId;
        }
        allCalendarIds.push(partEmail);
      }
    });
    
    Logger.log(`メールアドレスシートから取得: マーケティング部${marketingTeam.length}名, その他社員${otherEmployees.length}名, パート${partTimers.length}名`);
    
    return {
      CALENDAR_ID: allCalendarIds,
      MARKETING_TEAM: marketingTeam,
      PART_TIMER_TEAM: partTimers,
      EMAIL_TO_NAME: emailToName,
      EMAIL_TO_CHATWORK_ID: emailToChatworkId,
      OTHER_EMPLOYEES: otherEmployees
    };
    
  } catch (error) {
    Logger.log(`メールアドレスシート読み取りエラー: ${error.toString()}`);
    return getDefaultEmployeeData();
  }
}

/**
 * デフォルトの社員データ（エラー時のフォールバック）
 * @return {Object} デフォルト社員データ
 */
function getDefaultEmployeeData() {
  Logger.log('デフォルトの社員データを使用します');
  return {
    CALENDAR_ID: [],
    MARKETING_TEAM: [],
    PART_TIMER_TEAM: [],
    EMAIL_TO_NAME: {},
    EMAIL_TO_CHATWORK_ID: {},
    OTHER_EMPLOYEES: []
  };
}

/**
 * チャットワーク設定をスクリプトプロパティから取得
 */
function getChatworkConfig() {
  const properties = PropertiesService.getScriptProperties();
  const config = getConfig();
  
  return {
    ENABLED: config.CHATWORK.ENABLED,
    API_TOKEN: properties.getProperty('CHATWORK_API_TOKEN'),
    ROOM_ID: properties.getProperty('CHATWORK_ROOM_ID'),
    REMINDER_TEMPLATE: config.CHATWORK.REMINDER_TEMPLATE
  };
}

