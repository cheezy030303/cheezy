/**



 * åºƒå‘Šé‹ç”¨ãƒ‡ãƒ¼ã‚¿è‡ªå‹•åˆ†æã‚·ã‚¹ãƒ†ãƒ 

 * 

 * CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å–ã‚Šè¾¼ã¿ã€

 * CPAã€CTRã€CPCã®é–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã«Chatworkã«é€šçŸ¥ã—ã¾ã™

 * 

 * ã€åˆ—ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã€‘

 * ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | CSVåˆ—å                    | ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ—å

 * ------------|---------------------------|--------------------

 * 0           | Image                     | Image

 * 1           | Content Title             | Content Title

 * 2           | ID                        | ID

 * 3           | Amount Spent              | é…ä¿¡é‡‘é¡

 * 4           | Impressions               | Impressions

 * 5           | Avg. CPC                  | Avg. CPC

 * 6           | Clicks                    | Clicks

 * 7           | CTR                       | CTR

 * 8           | Conversions (Click)       | Conversions (Click)

 * 9           | Conversion Rate (Click)   | Conversion Rate

 * 10          | CPA (Click)               | CPA(å††)

 */

// Chatwork APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ«ãƒ¼ãƒ IDã®è¨­å®š

const CHATWORK_API_TOKEN = PropertiesService.getScriptProperties().getProperty('CHATWORK_API_TOKEN');

const CHATWORK_ROOM_ID = PropertiesService.getScriptProperties().getProperty('CHATWORK_ROOM_ID');

const CSV_FOLDER_ID = PropertiesService.getScriptProperties().getProperty('CSV_FOLDER_ID') || '1077Nlpr7Zgm7U0N-PeBB-k1Hhw4Xczoq';

// KPIåŸºæº–å€¤ã®è¨­å®šï¼ˆåºƒå‘ŠKPIè¡¨ã«åŸºã¥ãï¼‰

const KPI_STANDARDS = {

  CTR: {

    healthy: { min: 1.0, color: '#00FF00', label: 'å¥åº·' },      // ç·‘ï¼š1.0%ä»¥ä¸Š

    warning: { min: 0.4, max: 0.99, color: '#FFFF00', label: 'è¦æ³¨æ„' },  // é»„è‰²ï¼š0.4ï½0.9%

    danger: { max: 0.3, color: '#FF0000', label: 'ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³' }          // èµ¤ï¼š0.3%ä»¥ä¸‹

  },

  CPC: {

    healthy: { max: 90, color: '#00FF00', label: 'å¥åº·' },       // ç·‘ï¼šï½Â¥90

    warning: { min: 91, max: 129, color: '#FFFF00', label: 'è¦æ³¨æ„' },    // é»„è‰²ï¼šÂ¥91ï½Â¥129

    danger: { min: 130, color: '#FF0000', label: 'ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³' }          // èµ¤ï¼šÂ¥130ä»¥ä¸Š

  },

  CPA: {

    healthy: { max: 3000, color: '#00FF00', label: 'å¥åº·' },     // ç·‘ï¼šï½Â¥3,000

    warning: { min: 3001, max: 7499, color: '#FFFF00', label: 'è¦æ³¨æ„' }, // é»„è‰²ï¼šÂ¥3,001ï½Â¥7,499

    danger: { min: 7500, color: '#FF0000', label: 'ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³' }         // èµ¤ï¼šÂ¥7,500ä»¥ä¸Š

  }

};

const AMOUNT_SPENT_ADJUSTMENT_RATE = 1.1 / 0.8;

// æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

const IMPROVEMENT_ACTIONS = {

  CTR: {

    healthy: 'èˆˆå‘³ã‚’å¼·ãå¼•ã‘ã¦ã„ã‚‹ã€‚è¨´æ±‚è»¸ã‚’æ‹¡å¼µã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«é…ä¿¡ã€‚',

    warning: 'åå¿œãŒéˆåŒ–ã€‚ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« or ã‚³ãƒ”ãƒ¼ãŒå¼±ã„å¯èƒ½æ€§ã€‚CTAãƒ»ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ãƒ»è¨´æ±‚ã‚’ãƒ†ã‚¹ãƒˆã€‚',

    danger: 'èˆˆå‘³å–šèµ·ã§ããšã€‚åºƒå‘ŠãŒã‚¹ãƒ«ãƒ¼ã•ã‚Œã¦ã„ã‚‹ã€‚è¨´æ±‚ãƒ»æ§‹æˆã‚’å…¨é¢ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã€‚'

  },

  CPC: {

    healthy: 'åŠ¹ç‡çš„ãªé…ä¿¡ã€‚ã‚³ã‚¹ãƒ‘è‰¯å¥½ã€‚åŠ¹æœçš„ãªåºƒå‘Šã‚»ãƒƒãƒˆã‚’æ‹¡å¤§ã€‚',

    warning: 'ç²¾åº¦ä½ä¸‹ã¾ãŸã¯ç«¶åˆå¢—åŠ ã€‚å¹´é½¢ãƒ»èˆˆå‘³ãƒ»æ™‚é–“å¸¯ã‚’è¦‹ç›´ã—ã€‚',

    danger: 'ç„¡é§„ã‚¯ãƒªãƒƒã‚¯å¤šç™ºã§éåŠ¹ç‡ã€‚è¨´æ±‚è§’åº¦ãƒ»å…¥æœ­æˆ¦ç•¥ã‚’å†æ§‹ç¯‰ã€‚'

  },

  CPA: {

    healthy: 'åˆ©ç›Šãƒ¢ãƒ‡ãƒ«æˆç«‹ãƒ©ã‚¤ãƒ³ã€‚LPã¨åºƒå‘Šã®æ•´åˆæ€§ã‚’ç¶­æŒã€‚',

    warning: 'ã‚®ãƒªæˆç«‹ã€‚LTVä¾å­˜åº¦é«˜ã€‚LPæ”¹å–„ãƒ»ä¿¡é ¼è¦ç´ è¿½åŠ ã€‚',

    danger: 'åºƒå‘Šè²»å›åä¸èƒ½ãƒ©ã‚¤ãƒ³ã€‚ã‚ªãƒ•ã‚¡ãƒ¼ã¨LPã‚’å†è¨­è¨ˆã€‚'

  }

};

// å–å¾—ã—ãŸã„CSVåˆ—ã®ã‚¿ã‚¤ãƒˆãƒ«å

const CSV_COLUMN_TITLES = [

  'Image',                      // 0 - ç”»åƒ

  'Content Title',              // 1 - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒˆãƒ«

  'ID',                         // 2 - ID

  'Amount Spent',               // 3 - ä½¿ç”¨é‡‘é¡

  'Impressions',                // 4 - ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°

  'Avg. CPC',                   // 5 - å¹³å‡CPC

  'Clicks',                     // 6 - ã‚¯ãƒªãƒƒã‚¯æ•°

  'CTR',                        // 7 - ã‚¯ãƒªãƒƒã‚¯ç‡

  'Conversions (Click)',        // 8 - ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•°

  'Conversion Rate (Click)',    // 9 - ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡

  'CPA (Click)'                 // 10 - CPA

];

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼å

const SHEET_HEADER_TITLES = [

  'ç”»åƒè¡¨ç¤º',                   // 0 - ç”»åƒè¡¨ç¤ºï¼ˆIMAGEé–¢æ•°ï¼‰

  'ãƒ†ã‚­ã‚¹ãƒˆ',                   // 1 - Content Title

  'é…ä¿¡é‡‘é¡',                   // 2 - Amount Spent

  'Imp',                        // 3 - Impressions

  'CPC',                        // 4 - Avg. CPC

  'Clicks',                     // 5 - Clicks

  'CTR',                        // 6 - CTR

  'CV',                         // 7 - Conversions (Click)

  'CVR',                        // 8 - Conversion Rate (Click)

  'CPA(å††)'                     // 9 - CPA

];

// CSVãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ¥åå€™è£œï¼ˆã‚­ãƒ¼ã¯ä¸Šè¨˜CSV_COLUMN_TITLESã®æ­£è¦åç§°ï¼‰

const CSV_COLUMN_ALIASES = {

  'Image': ['ç”»åƒURL', 'image', 'img', 'Image URL', 'Thumbnail'],

  'Content Title': ['ãƒ†ã‚­ã‚¹ãƒˆ', 'Title', 'ContentTitle', 'Headline', 'Ad Title'],

  'ID': ['åºƒå‘ŠID', 'Campaign ID', 'Content ID', 'Ad ID'],

  'Amount Spent': ['é…ä¿¡é‡‘é¡', 'Cost', 'Spend', 'AmountSpent', 'Amount Spent (JPY)', 'Cost (JPY)', 'è²»ç”¨'],

  'Impressions': ['Imp', 'Impr', 'Impressions (Number)', 'è¡¨ç¤ºå›æ•°', 'Impressions.', 'Impression'],

  'Avg. CPC': ['CPC', 'Average CPC', 'Avg CPC', 'Avg. CPC (JPY)', 'å¹³å‡CPC', 'Cost Per Click'],

  'Clicks': ['Click', 'ç·ã‚¯ãƒªãƒƒã‚¯æ•°', 'Clicks (Number)', 'ã‚¯ãƒªãƒƒã‚¯æ•°'],

  'CTR': ['Click Through Rate', 'Click-Through Rate', 'CTR (%)', 'CTR(%)', 'ã‚¯ãƒªãƒƒã‚¯ç‡'],

  'Conversions (Click)': ['Conversions', 'CV', 'Conversion', 'Conversions (Number)', 'ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³'],

  'Conversion Rate (Click)': ['Conversion Rate', 'CVR', 'Conv. Rate', 'Conversion Rate (%)', 'CVR (%)', 'ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡'],

  'CPA (Click)': ['CPA', 'CPA(å††)', 'Cost Per Action', 'CPA (Click) (JPY)', 'CPA(JPY)', 'ç²å¾—å˜ä¾¡']

};

/**

 * ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®åˆæœŸè¨­å®šé–¢æ•°

 */

function setupProperties() {

  const ui = SpreadsheetApp.getUi();

  

  // Chatwork APIãƒˆãƒ¼ã‚¯ãƒ³ã®è¨­å®š

  const apiTokenResponse = ui.prompt(

    'Chatwork APIãƒˆãƒ¼ã‚¯ãƒ³ã®è¨­å®š',

    'Chatwork APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',

    ui.ButtonSet.OK_CANCEL

  );

  

  if (apiTokenResponse.getSelectedButton() == ui.Button.OK) {

    PropertiesService.getScriptProperties().setProperty('CHATWORK_API_TOKEN', apiTokenResponse.getResponseText());

  }

  

  // Chatworkãƒ«ãƒ¼ãƒ IDã®è¨­å®š

  const roomIdResponse = ui.prompt(

    'Chatworkãƒ«ãƒ¼ãƒ IDã®è¨­å®š',

    'Chatworkãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',

    ui.ButtonSet.OK_CANCEL

  );

  

  if (roomIdResponse.getSelectedButton() == ui.Button.OK) {

    PropertiesService.getScriptProperties().setProperty('CHATWORK_ROOM_ID', roomIdResponse.getResponseText());

  }

  

  // CSVãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDã®è¨­å®š

  const folderIdResponse = ui.prompt(

    'CSVãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDã®è¨­å®š',

    'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹Google Driveãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',

    ui.ButtonSet.OK_CANCEL

  );

  

  if (folderIdResponse.getSelectedButton() == ui.Button.OK) {

    PropertiesService.getScriptProperties().setProperty('CSV_FOLDER_ID', folderIdResponse.getResponseText());

  }

  

  ui.alert('è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼');

}

/**
 
 * æ˜¨æ—¥ã®CSVã‚’å–ã‚Šè¾¼ã¿â†’åˆ†æï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã«æ—¥ä»˜ãŒå«ã¾ã‚Œã‚‹æƒ³å®šï¼‰
 
 * å„ªå…ˆãƒ‘ã‚¿ãƒ¼ãƒ³: yyyyMMdd / yyyy-MM-dd / yyyy_MM_dd ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«å«ã‚€CSV
 
 */
function importYesterdayCsvAndAnalyze() {
 
  try {
 
    if (!CSV_FOLDER_ID) {
 
      Logger.log('CSVãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
 
      return;
 
    }
 
    
 
    const folder = DriveApp.getFolderById(CSV_FOLDER_ID);
 
    const files = folder.getFilesByType(MimeType.CSV);
 
    const { ymd, y_m_d, y_m_d_underscore } = getYesterdayDateStrings_();
 
    
 
    const candidates = [];
 
    while (files.hasNext()) {
 
      const f = files.next();
 
      const name = f.getName();
 
      if (name.includes(ymd) || name.includes(y_m_d) || name.includes(y_m_d_underscore)) {
 
        candidates.push(f);
 
      }
 
    }
 
    
 
    if (candidates.length === 0) {
 
      Logger.log('æ˜¨æ—¥ã®æ—¥ä»˜ã«ä¸€è‡´ã™ã‚‹CSVãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
 
      return;
 
    }
 
    
 
    // æœ€çµ‚æ›´æ–°ãŒæœ€æ–°ã®ã‚‚ã®ã‚’æ¡ç”¨
 
    const targetFile = candidates.sort((a, b) => b.getLastUpdated() - a.getLastUpdated())[0];
 
    Logger.log('æ˜¨æ—¥ã®CSVã¨ã—ã¦å–ã‚Šè¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«: ' + targetFile.getName());
 
    
 
    // æ—¢ã«å‡¦ç†æ¸ˆã¿ã‹ã‚’ç¢ºèª
 
    const processed = getProcessedFiles();
 
    if (processed.includes(targetFile.getId())) {
 
      Logger.log('æ—¢ã«å‡¦ç†æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ' + targetFile.getName());
 
      return;
 
    }
 
    
 
    // importCSVToSheet(targetFile);
 
    markFileAsProcessed(targetFile.getId(), targetFile.getName());
 
    generatePeriodSummaries();
 
  } catch (error) {
 
    Logger.log('æ˜¨æ—¥CSVå–ã‚Šè¾¼ã¿å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼: ' + error.toString());
 
    sendErrorNotification(error);
 
  }
 
}
 
/**
 
 * æ—¥æ¬¡ï¼ˆæŒ‡å®šæ™‚åˆ» JSTï¼‰ã§æ˜¨æ—¥CSVâ†’åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 
 * æ—¢å­˜ã®æ™‚é™ãƒˆãƒªã‚¬ãƒ¼ã¯æ®‹ã—ã€åŒåã®ã‚‚ã®ã®ã¿é‡è¤‡ä½œæˆã‚’å›é¿
 
 */
function setupDailyYesterdayTrigger(hourJst) {
 
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 7æ™‚(JST)
 
  const hour = typeof hourJst === 'number' && hourJst >= 0 && hourJst <= 23 ? hourJst : 7;
 
  
 
  // æ—¢å­˜ã§åŒã˜ãƒãƒ³ãƒ‰ãƒ©ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¦é‡è¤‡å›é¿
 
  const triggers = ScriptApp.getProjectTriggers();
 
  triggers.forEach(t => {
 
    if (t.getHandlerFunction && t.getHandlerFunction() === 'runDailyYesterdayJob') {
 
      ScriptApp.deleteTrigger(t);
 
    }
 
  });
 
  
 
  ScriptApp.newTrigger('runDailyYesterdayJob')
 
    .timeBased()
 
    .atHour(hour)       // JSTåŸºæº–ã§å®Ÿè¡Œ
 
    .everyDays(1)
 
    .create();
 
  
 
  const ui = SpreadsheetApp.getUi && SpreadsheetApp.getUi();
 
  if (ui) {
 
    ui.alert(`æ—¥æ¬¡ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆæ¯æ—¥ ${hour}:00 JST ã«å®Ÿè¡Œï¼‰`);
 
  }
 
}
 
/**
 
 * ãƒˆãƒªã‚¬ãƒ¼å®Ÿè¡Œé–¢æ•°ï¼ˆæ˜¨æ—¥ã®CSVâ†’åˆ†æï¼‰
 
 */
function runDailyYesterdayJob() {
 
  importYesterdayCsvAndAnalyze();
 
}
 
/**
 
 * æ˜¨æ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ï¼ˆJSTï¼‰ã‚’è¤‡æ•°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§è¿”ã™
 
 */
function getYesterdayDateStrings_() {
 
  const tz = 'JST';
 
  const now = new Date();
 
  // JSTã®æ˜¨æ—¥ã«èª¿æ•´
 
  const jstNowStr = Utilities.formatDate(now, tz, "yyyy/MM/dd HH:mm:ss");
 
  const jstNow = new Date(jstNowStr);
 
  const yesterday = new Date(jstNow.getTime() - 24 * 60 * 60 * 1000);
 
  
 
  const ymd = Utilities.formatDate(yesterday, tz, "yyyyMMdd");
 
  const y_m_d = Utilities.formatDate(yesterday, tz, "yyyy-MM-dd");
 
  const y_m_d_underscore = Utilities.formatDate(yesterday, tz, "yyyy_MM_dd");
 
  return { ymd, y_m_d, y_m_d_underscore };
 
}
 
function collectPeriodData_() {

  const configs = [

    {

      label: 'å‰æ—¥',

      fileNames: [

        'CRå‰æ—¥.CSV', 'CRå‰æ—¥.csv',

        'CRåˆ¥å‰æ—¥.CSV', 'CRåˆ¥å‰æ—¥.csv',

        'CRå‰æ—¥ãƒ‡ãƒ¼ã‚¿.CSV', 'CRå‰æ—¥ãƒ‡ãƒ¼ã‚¿.csv'

      ]

    },

    {

      label: 'ç›´è¿‘3æ—¥é–“',

      fileNames: [

        'CRç›´è¿‘3æ—¥é–“.CSV', 'CRç›´è¿‘3æ—¥é–“.csv',

        'CRç›´è¿‘ï¼“æ—¥é–“.CSV', 'CRç›´è¿‘ï¼“æ—¥é–“.csv',

        'CRç›´è¿‘ä¸‰æ—¥é–“.CSV', 'CRç›´è¿‘ä¸‰æ—¥é–“.csv'

      ]

    },

    {

      label: '1ã‚«æœˆå‰',

      fileNames: [

        'CRï¼‘ã‚«æœˆå‰.CSV', 'CRï¼‘ã‚«æœˆå‰.csv',

        'CR1ã‚«æœˆå‰.CSV', 'CR1ã‚«æœˆå‰.csv',

        'CR1ãƒ¶æœˆå‰.CSV', 'CR1ãƒ¶æœˆå‰.csv',

        'CRï¼‘ãƒ¶æœˆå‰.CSV', 'CRï¼‘ãƒ¶æœˆå‰.csv'

      ]

    }

  ];


  const summaries = [];

  const rawBlocks = [];


  configs.forEach(config => {

    const csvData = loadCsvDataByNames_(config.fileNames);

    if (!csvData) {

      const fileNamesText = Array.isArray(config.fileNames) ? config.fileNames.join(', ') : 'ä¸æ˜';

      summaries.push({

        label: config.label,

        error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ' + fileNamesText

      });

      rawBlocks.push({

        label: config.label,

        error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'

      });

      return;

    }


    rawBlocks.push({

      label: config.label,

      data: csvData

    });


    const metrics = computeSummaryMetrics_(csvData);

    if (!metrics) {

      const fileNamesText = Array.isArray(config.fileNames) ? config.fileNames.join(', ') : 'ä¸æ˜';

      summaries.push({

        label: config.label,

        error: 'æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“: ' + fileNamesText

      });

      return;

    }


    summaries.push({

      label: config.label,

      ...metrics

    });

  });


  return { summaries, rawBlocks };

}

/**

 * æŒ‡å®š3æœŸé–“ï¼ˆå‰æ—¥ãƒ»ç›´è¿‘3æ—¥é–“ãƒ»1ã‚«æœˆå‰ï¼‰ã®CSVã‚’é›†è¨ˆã—ã¦è¡¨ã‚’ä½œæˆ

 */
function generatePeriodSummaries() {

  try {

    const { summaries, rawBlocks } = collectPeriodData_();

    renderPeriodSummarySheet_(summaries);
    renderPeriodRawDataSheet_(rawBlocks);
    renderAdDataSheetFromRawBlocks_(rawBlocks);
    analyzeData();
 
  } catch (error) {
 
    Logger.log('æœŸé–“åˆ¥ã‚µãƒãƒªãƒ¼ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼: ' + error.toString());
 
    sendErrorNotification(error);
 
    throw error;
 
  }
 
}

function refreshAdDataFromPeriodCsvs() {

  try {

    const { rawBlocks } = collectPeriodData_();

    renderAdDataSheetFromRawBlocks_(rawBlocks);

  } catch (error) {

    Logger.log('åºƒå‘Šãƒ‡ãƒ¼ã‚¿å†æ§‹ç¯‰ã§ã‚¨ãƒ©ãƒ¼: ' + error.toString());

    sendErrorNotification(error);

    throw error;

  }

}
 
function loadCsvDataByNames_(fileNames) {
 
  if (!CSV_FOLDER_ID) {
 
    Logger.log('CSVãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
 
    return null;
 
  }
 
  const candidates = Array.isArray(fileNames) ? fileNames : [fileNames];
 
  
 
  try {
 
    const folder = DriveApp.getFolderById(CSV_FOLDER_ID);
 
    for (const fileName of candidates) {

      const iterator = folder.getFilesByName(fileName);
 
      const files = [];
 
      while (iterator.hasNext()) {
 
        files.push(iterator.next());

      }
 
      if (files.length === 0) {

        Logger.log(`å€™è£œãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ${fileName}`);

        continue;

      }
 
      const targetFile = files.sort((a, b) => b.getLastUpdated() - a.getLastUpdated())[0];

      Logger.log(`èª­ã¿è¾¼ã¿å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ${targetFile.getName()}`);

      const csvContent = targetFile.getBlob().getDataAsString('UTF-8');

      if (!csvContent || csvContent.trim() === '') {

        Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™: ' + fileName);

        continue;

      }
 
      const csvData = Utilities.parseCsv(csvContent);

      if (!csvData || csvData.length === 0) {

        Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“: ' + fileName);

        continue;

      }
 
      return csvData;

    }
 
  } catch (error) {
 
    Logger.log('CSVèª­ã¿è¾¼ã¿å¤±æ•—: ' + error.toString());
 
    throw error;
 
  }
 
}
 
function transformCsvDataToAdRows_(csvData, contextLabel) {

  if (!csvData || csvData.length === 0) {

    return { rows: [], imageUrls: [] };

  }

  const headerRow = csvData[0];

  if (!headerRow || headerRow.length === 0 || headerRow.join('').trim() === '') {

    throw new Error(`${contextLabel ? `[${contextLabel}] ` : ''}CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒç©ºã§ã™`);

  }

  const columnIndices = findColumnIndices(headerRow, CSV_COLUMN_TITLES);

  const notFoundColumns = CSV_COLUMN_TITLES.filter((title, index) => columnIndices[index] === -1);

  if (notFoundColumns.length > 0) {

    Logger.log(`${contextLabel ? `[${contextLabel}] ` : ''}è­¦å‘Š: ä»¥ä¸‹ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ${notFoundColumns.join(', ')}`);

  }

  const rowsToInsert = [];

  const imageUrls = [];

  for (let i = 1; i < csvData.length; i++) {

    const row = csvData[i];

    if (!row || row.length === 0) {

      continue;

    }

    const rowContent = row.join('').trim();

    if (rowContent === '') {

      continue;

    }

    const extractedData = columnIndices.map(colIndex => {

      if (colIndex !== -1 && colIndex < row.length) {

        const value = row[colIndex];

        return value !== null && value !== undefined ? String(value).trim() : '';

      }

      return '';

    });

    const hasValidData = extractedData.some(cell => cell !== '');

    if (!hasValidData || extractedData.length === 0) {

      continue;

    }

    const imageUrl = extractedData[0] || '';

    const contentTitle = extractedData[1] || '';

    const rawAmount = cleanNumericValue(extractedData[3]) || 0;

    if (rawAmount <= 0) {

      continue;

    }

    const adjustedAmount = rawAmount * AMOUNT_SPENT_ADJUSTMENT_RATE;

    const impressions = extractedData[4] || '';

    const avgCpc = extractedData[5] || '';

    const clicks = extractedData[6] || '';

    const ctr = extractedData[7] || '';

    const conversions = extractedData[8] || '';

    const conversionRate = extractedData[9] || '';

    const cpa = extractedData[10] || '';

    rowsToInsert.push([

      '',

      contentTitle,

      adjustedAmount,

      impressions,

      avgCpc,

      clicks,

      ctr,

      conversions,

      conversionRate,

      cpa

    ]);

    imageUrls.push(imageUrl);

  }

  return { rows: rowsToInsert, imageUrls };

}

function computeSummaryMetrics_(csvData) {
 
  if (!csvData || csvData.length <= 1) {
 
    return null;
 
  }
 
  
 
  const headerRow = csvData[0];
 
  const columnIndices = findColumnIndices(headerRow, CSV_COLUMN_TITLES);
 
  const idxAmount = columnIndices[CSV_COLUMN_TITLES.indexOf('Amount Spent')];
 
  const idxImpressions = columnIndices[CSV_COLUMN_TITLES.indexOf('Impressions')];
 
  const idxClicks = columnIndices[CSV_COLUMN_TITLES.indexOf('Clicks')];
 
  const idxConversions = columnIndices[CSV_COLUMN_TITLES.indexOf('Conversions (Click)')];
 
  
 
  if ([idxAmount, idxImpressions, idxClicks, idxConversions].some(idx => idx === -1)) {
 
    Logger.log('å¿…è¦ãªåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
 
    return null;
 
  }
 
  
 
  let totalCost = 0;
 
  let totalImpressions = 0;
 
  let totalClicks = 0;
 
  let totalConversions = 0;
 
  let rowCount = 0;
 
  
 
  for (let i = 1; i < csvData.length; i++) {
 
    const row = csvData[i];
 
    if (!row || row.join('').trim() === '') {
 
      continue;
 
    }
 
    
 
    const cost = cleanNumericValue(row[idxAmount]) || 0;
 
    const impressions = cleanNumericValue(row[idxImpressions]) || 0;
 
    const clicks = cleanNumericValue(row[idxClicks]) || 0;
 
    const conversions = cleanNumericValue(row[idxConversions]) || 0;
 
    
 
    totalCost += cost;
 
    totalImpressions += impressions;
 
    totalClicks += clicks;
 
    totalConversions += conversions;
 
    rowCount++;
 
  }
 
  
 
  if (rowCount === 0) {
 
    return null;
 
  }
 
  
 
  const avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : 0;
 
  const avgCPC = totalClicks > 0 ? (totalCost / totalClicks) : 0;
 
  const avgCPA = totalConversions > 0 ? (totalCost / totalConversions) : 0;
 
  
 
  return {
 
    totalRows: rowCount,
 
    totalClicks,
 
    totalImpressions,
 
    totalCost,
 
    totalConversions,
 
    avgCTR,
 
    avgCPC,
 
    avgCPA
 
  };
 
}
 
function renderPeriodSummarySheet_(summaries) {
 
  const ss = SpreadsheetApp.getActiveSpreadsheet();
 
  let sheet = ss.getSheetByName('æœŸé–“åˆ¥ã‚µãƒãƒªãƒ¼');
 
  if (!sheet) {
 
    sheet = ss.insertSheet('æœŸé–“åˆ¥ã‚µãƒãƒªãƒ¼');
 
  } else {
 
    sheet.clear();
 
  }
 
  
 
  let currentRow = 1;
 
  summaries.forEach((summary, index) => {

    const titleRange = sheet.getRange(currentRow, 1, 1, 3);

    titleRange.merge();

    titleRange.setValue(`â–  ${summary.label}`);

    titleRange.setFontWeight('bold').setFontSize(12).setBackground('#D9E1F2');

    currentRow += 1;

    const headerRange = sheet.getRange(currentRow, 1, 1, 3);

    headerRange.setValues([['é …ç›®', 'å€¤', 'å‚™è€ƒ']]);

    headerRange.setBackground('#4A86E8').setFontColor('#FFFFFF').setFontWeight('bold').setHorizontalAlignment('center');

    currentRow += 1;

    if (summary.error) {

      sheet.getRange(currentRow, 1, 1, 3).setValues([[ 'ãƒ‡ãƒ¼ã‚¿å–å¾—', '-', summary.error ]]);

      currentRow += 1;

    } else {

      const rows = [

        ['ç·åºƒå‘Šæ•°', formatNumber_(summary.totalRows), ''],

        ['ç·ã‚¯ãƒªãƒƒã‚¯æ•°', formatNumber_(summary.totalClicks), ''],

        ['ç·ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°', formatNumber_(summary.totalImpressions), ''],

        ['ç·ã‚³ã‚¹ãƒˆ', formatCurrency_(summary.totalCost), ''],

        ['ç·ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•°', formatNumber_(summary.totalConversions), ''],

        ['å¹³å‡CTR', formatPercent_(summary.avgCTR), ''],

        ['å¹³å‡CPC', formatCurrency_(summary.avgCPC), ''],

        ['å¹³å‡CPA', formatCurrency_(summary.avgCPA), '']

      ];

      sheet.getRange(currentRow, 1, rows.length, 3).setValues(rows);

      currentRow += rows.length;

    }

    if (index < summaries.length - 1) {

      currentRow += 1;

    }

  });
 
  sheet.autoResizeColumns(1, 3);
 
}

function renderPeriodRawDataSheet_(rawBlocks) {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let sheet = ss.getSheetByName('æœŸé–“åˆ¥ãƒ‡ãƒ¼ã‚¿');

  if (!sheet) {

    sheet = ss.insertSheet('æœŸé–“åˆ¥ãƒ‡ãƒ¼ã‚¿');

  } else {

    sheet.clear();

  }


  let currentRow = 1;

  rawBlocks.forEach(block => {

    const titleRange = sheet.getRange(currentRow, 1, 1, 1);

    titleRange.setValue(`â–  ${block.label}`);

    titleRange.setFontWeight('bold').setFontSize(12).setBackground('#D9E1F2');

    currentRow += 1;


    if (block.error) {

      sheet.getRange(currentRow, 1).setValue(block.error);

      currentRow += 2;

      return;

    }


    const data = block.data;

    if (data && data.length > 0) {

      const rowCount = data.length;

      const columnCount = data[0].length;

      sheet.getRange(currentRow, 1, rowCount, columnCount).setValues(data);

      currentRow += rowCount + 1;

    } else {

      sheet.getRange(currentRow, 1).setValue('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

      currentRow += 2;

    }

  });


  const maxColumns = sheet.getMaxColumns();

  if (maxColumns > 0) {

    sheet.autoResizeColumns(1, maxColumns);

  }

}
 
function renderAdDataSheetFromRawBlocks_(rawBlocks) {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let dataSheet = ss.getSheetByName('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

  if (!dataSheet) {

    dataSheet = ss.insertSheet('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

    if (SHEET_HEADER_TITLES && SHEET_HEADER_TITLES.length > 0) {

      dataSheet.appendRow(SHEET_HEADER_TITLES);

    } else {

      throw new Error('ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');

    }

    const headerRange = dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length);

    headerRange.setBackground('#4A86E8');

    headerRange.setFontColor('#FFFFFF');

    headerRange.setFontWeight('bold');

    headerRange.setHorizontalAlignment('center');

  } else {

    const currentHeaders = dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length).getValues()[0];

    const headersMatch = currentHeaders.every((header, index) => header === SHEET_HEADER_TITLES[index]);

    if (!headersMatch) {

      dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length).setValues([SHEET_HEADER_TITLES]);

    }

    const lastRow = dataSheet.getLastRow();

    if (lastRow > 1) {

      dataSheet.getRange(2, 1, lastRow - 1, dataSheet.getLastColumn()).clearContent();

      dataSheet.getRange(2, 1, lastRow - 1, dataSheet.getLastColumn()).setBackground(null);

    }

  }

  if (!rawBlocks || rawBlocks.length === 0) {

    Logger.log('æœŸé–“åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åºƒå‘Šãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸ');

    return;

  }

  let currentRow = 2;

  const headingStartColumn = 1;

  const headingWidth = SHEET_HEADER_TITLES.length;

  rawBlocks.forEach(block => {

    const label = block && block.label ? block.label : '';

    const headingText = block && block.error

      ? `æœŸé–“ï¼š${label}ï¼ˆ${block.error}ï¼‰`

      : `æœŸé–“ï¼š${label}`;

    const headingBackground = block && block.error ? '#F4CCCC' : '#D9E1F2';

    dataSheet.getRange(currentRow, 1, 1, dataSheet.getMaxColumns()).breakApart();

    const headingRange = dataSheet.getRange(currentRow, headingStartColumn, 1, headingWidth);

    headingRange.merge()

      .setValue(headingText)

      .setFontWeight('bold')

      .setFontColor('#000000')

      .setBackground(headingBackground)

      .setHorizontalAlignment('left');

    currentRow += 1;

    if (block && block.error) {

      currentRow += 1;

      return;

    }

    if (!block || !block.data) {

      currentRow += 1;

      return;

    }

    try {

      const { rows, imageUrls } = transformCsvDataToAdRows_(block.data, label);

      if (!rows || rows.length === 0) {

        dataSheet.getRange(currentRow, 1, 1, dataSheet.getMaxColumns()).breakApart();

        dataSheet.getRange(currentRow, headingStartColumn, 1, headingWidth)

          .merge()

          .setValue(`æœŸé–“ï¼š${label}ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰`)

          .setFontWeight('bold')

          .setFontColor('#000000')

          .setBackground('#F4CCCC')

          .setHorizontalAlignment('left');

        currentRow += 2;

        return;

      }

      const targetRange = dataSheet.getRange(currentRow, headingStartColumn, rows.length, SHEET_HEADER_TITLES.length);

      targetRange.setValues(rowsToInsert);

      applyMetricFormulas_(dataSheet, currentRow, rows.length);

      const imageFormulas = rows.map((_, index) => {

        const imageUrl = imageUrls[index] || '';

        if (imageUrl && imageUrl.trim() !== '') {

          const safeUrl = imageUrl.replace(/"/g, '""');

          return [`=IF(LEN("${safeUrl}"), IMAGE("${safeUrl}", 1), "")`];

        }

        return [''];

      });

      dataSheet.getRange(currentRow, headingStartColumn, rows.length, 1).setFormulas(imageFormulas);

      currentRow += rows.length + 1;

    } catch (error) {

      Logger.log(`[${label}] ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã«å¤±æ•—: ` + error.toString());

    }

  });

  for (let col = headingStartColumn; col < headingStartColumn + SHEET_HEADER_TITLES.length; col++) {

    dataSheet.autoResizeColumn(col);

  }

  dataSheet.setColumnWidth(1, 120);

  dataSheet.setColumnWidth(2, 220);

  for (let col = 3; col <= SHEET_HEADER_TITLES.length; col++) {

    dataSheet.setColumnWidth(col, 90);

  }

}

function formatNumber_(value) {
 
  return Number(value || 0).toLocaleString();
 
}
 
function formatCurrency_(value) {
 
  return 'Â¥' + Number(value || 0).toLocaleString();
 
}
 
function formatCurrencyWithDecimals_(value) {

  const num = Number(value || 0);

  return 'Â¥' + num.toLocaleString('ja-JP', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

}
 
function formatPercent_(value) {
 
  return Number(value || 0).toFixed(2) + '%';
 
}
 
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æ—¥æ¬¡é–¢é€£é …ç›®ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½è¨˜ï¼‰
// æ—¢å­˜ onOpen ã«è¿½è¨˜ã™ã‚‹ãŸã‚ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’å†è¿½åŠ ï¼ˆonOpen è‡ªä½“ã¯æ—¢å­˜å®šç¾©ã®ãŸã‚ä¸Šæ›¸ãã›ãšï¼‰
function onOpen_addDailyMenu_() {
 
  const ui = SpreadsheetApp.getUi();
 
  ui.createMenu('æ—¥æ¬¡ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³')
 
    .addItem('æ˜¨æ—¥ã®CSVã‚’å–ã‚Šè¾¼ã¿â†’åˆ†æ', 'importYesterdayCsvAndAnalyze')
 
    .addItem('æ—¥æ¬¡ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šï¼ˆ07:00 JSTï¼‰', 'setupDailyYesterdayTrigger')

    .addItem('æœŸé–“åˆ¥ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°', 'generatePeriodSummaries')

    .addItem('åºƒå‘Šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæœŸé–“CSVï¼‰', 'refreshAdDataFromPeriodCsvs')
 
    .addToUi();
 
}
 
// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ ã‚’ç¢ºå®Ÿã«å‘¼ã¶ãŸã‚ã®ãƒˆãƒªã‚¬ãƒ¼
function onOpen_e2eDailyMenuInit_() {
 
  try {
 
    onOpen_addDailyMenu_();
 
  } catch (e) {
 
    Logger.log('æ—¥æ¬¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ ã«å¤±æ•—: ' + e.toString());
 
  }
 
}

/**

 * ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 

 */

function onOpen() {

  const ui = SpreadsheetApp.getUi();

  ui.createMenu('åºƒå‘Šé‹ç”¨DX')

    .addItem('åˆæœŸè¨­å®š', 'setupProperties')

    .addItem('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•å–ã‚Šè¾¼ã¿', 'manualImportCSV')

    .addItem('ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å®Ÿè¡Œ', 'analyzeData')

    .addItem('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ', 'generateWeeklyReport')

    .addSeparator()

    .addItem('ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š', 'setupTriggers')

    .addItem('ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤', 'deleteTriggers')

    .addSeparator()

    .addItem('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ç¢ºèª', 'debugCheckData')

    .addItem('ğŸ”§ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿®æ­£', 'fixHeaders')

    .addSeparator()

    .addItem('æ˜¨æ—¥ã®CSVã‚’å–ã‚Šè¾¼ã¿â†’åˆ†æ', 'importYesterdayCsvAndAnalyze')

    .addItem('æ—¥æ¬¡ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šï¼ˆ07:00 JSTï¼‰', 'setupDailyYesterdayTrigger')

    .addItem('æœŸé–“åˆ¥ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°', 'generatePeriodSummaries')

    .addItem('åºƒå‘Šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæœŸé–“CSVï¼‰', 'refreshAdDataFromPeriodCsvs')

    .addToUi();

}

/**

 * ãƒ‡ãƒãƒƒã‚°: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª

 */

function debugCheckData() {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const dataSheet = ss.getSheetByName('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

  

  if (!dataSheet) {

    SpreadsheetApp.getUi().alert('ã€Œåºƒå‘Šãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    return;

  }

  

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—

  const headers = dataSheet.getRange(1, 1, 1, dataSheet.getLastColumn()).getValues()[0];

  Logger.log('=== ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ ===');

  headers.forEach((header, index) => {

    Logger.log(`åˆ—${index + 1} (${String.fromCharCode(65 + index)}): "${header}"`);

  });

  

  // ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®3è¡Œã‚’å–å¾—

  if (dataSheet.getLastRow() > 1) {

    const dataRows = Math.min(3, dataSheet.getLastRow() - 1);

    const data = dataSheet.getRange(2, 1, dataRows, dataSheet.getLastColumn()).getValues();

    

    Logger.log('\n=== ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®3è¡Œï¼‰ ===');

    data.forEach((row, rowIndex) => {

      Logger.log(`\nè¡Œ${rowIndex + 2}:`);

      row.forEach((cell, colIndex) => {

        if (cell !== '') {

          Logger.log(`  ${headers[colIndex]}: "${cell}" (å‹: ${typeof cell})`);

        }

      });

    });

  }

  

  // æœŸå¾…ã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã®æ¯”è¼ƒ

  Logger.log('\n=== æœŸå¾…ã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã®æ¯”è¼ƒ ===');

  SHEET_HEADER_TITLES.forEach((expected, index) => {

    const actual = headers[index] || '(ãªã—)';

    const match = actual === expected ? 'âœ“' : 'âœ—';

    Logger.log(`${match} [${index}] æœŸå¾…: "${expected}" / å®Ÿéš›: "${actual}"`);

  });

  

  SpreadsheetApp.getUi().alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚\n\nã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€â†’ã€Œå®Ÿè¡Œæ•°ã€ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚');

}

/**

 * ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ­£ã—ã„å½¢å¼ã«ä¿®æ­£

 */

function fixHeaders() {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const dataSheet = ss.getSheetByName('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

  

  if (!dataSheet) {

    SpreadsheetApp.getUi().alert('ã€Œåºƒå‘Šãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    return;

  }

  

  // ç¾åœ¨ã®åˆ—æ•°ã‚’ç¢ºèª
  const currentColumns = dataSheet.getLastColumn();
  const expectedColumns = SHEET_HEADER_TITLES.length;
  
  // ç”»åƒè¡¨ç¤ºåˆ—ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆåˆ—BãŒã€Œç”»åƒè¡¨ç¤ºã€ã§ãªã„å ´åˆï¼‰ã€åˆ—ã‚’æŒ¿å…¥
  const currentHeaders = dataSheet.getRange(1, 1, 1, Math.max(currentColumns, expectedColumns)).getValues()[0];
  const needsImageColumn = currentHeaders[1] !== 'ç”»åƒè¡¨ç¤º';
  
  if (needsImageColumn && currentColumns >= 1) {
    // åˆ—Bï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2ï¼‰ã«æ–°ã—ã„åˆ—ã‚’æŒ¿å…¥
    dataSheet.insertColumnBefore(2);
    Logger.log('ç”»åƒè¡¨ç¤ºåˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  }
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
  dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length).setValues([SHEET_HEADER_TITLES]);

  

  // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨

  const headerRange = dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length);

  headerRange.setBackground('#4A86E8');

  headerRange.setFontColor('#FFFFFF');

  headerRange.setFontWeight('bold');

  headerRange.setHorizontalAlignment('center');

  
  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ç”»åƒè¡¨ç¤ºåˆ—ã«IMAGEé–¢æ•°ã®å¼ã‚’è¨­å®š
  const lastRow = dataSheet.getLastRow();
  if (lastRow > 1) {
    const imageColumnRange = dataSheet.getRange(2, 2, lastRow - 1, 1);
    const formulas = [];
    for (let i = 2; i <= lastRow; i++) {
      formulas.push([`=IF(A${i}<>"", IMAGE(A${i}, 1), "")`]);
    }
    imageColumnRange.setFormulas(formulas);
    Logger.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç”»åƒè¡¨ç¤ºåˆ—ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  }
  
  // ç”»åƒè¡¨ç¤ºåˆ—ï¼ˆåˆ—Bï¼‰ã®å¹…ã‚’é©åˆ‡ãªã‚µã‚¤ã‚ºã«è¨­å®š
  dataSheet.setColumnWidth(2, 120);

  // ä½™åˆ†ãªåˆ—ã‚’å‰Šé™¤ï¼ˆæœŸå¾…ã•ã‚Œã‚‹åˆ—æ•°ã‚ˆã‚Šå¤šã„å ´åˆï¼‰

  const finalColumns = dataSheet.getLastColumn();

  if (finalColumns > SHEET_HEADER_TITLES.length) {

    dataSheet.deleteColumns(SHEET_HEADER_TITLES.length + 1, finalColumns - SHEET_HEADER_TITLES.length);

  }

  

  SpreadsheetApp.getUi().alert(`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼\n\n${SHEET_HEADER_TITLES.length}åˆ—ã«è¨­å®šã—ã¾ã—ãŸã€‚\nç”»åƒè¡¨ç¤ºåˆ—ã‚‚è¿½åŠ ã—ã¾ã—ãŸã€‚`);

}

/**

 * å®šæœŸå®Ÿè¡Œç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š

 */

function setupTriggers() {

  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤

  deleteTriggers();

  

  // 1æ™‚é–“ã”ã¨ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯

  ScriptApp.newTrigger('checkNewCSVFiles')

    .timeBased()

    .everyHours(1)

    .create();

  

  SpreadsheetApp.getUi().alert('ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚1æ™‚é–“ã”ã¨ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚');

}

/**

 * ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤

 */

function deleteTriggers() {

  const triggers = ScriptApp.getProjectTriggers();

  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));

}

/**

 * æ–°ã—ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å–ã‚Šè¾¼ã¿

 */

function checkNewCSVFiles() {

  try {

    if (!CSV_FOLDER_ID) {

      Logger.log('CSVãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');

      return;

    }

    

    const folder = DriveApp.getFolderById(CSV_FOLDER_ID);

    const files = folder.getFilesByType(MimeType.CSV);

    

    // å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’å–å¾—

    const processedFiles = getProcessedFiles();

    

    let newFilesProcessed = false;

    

    while (files.hasNext()) {

      const file = files.next();

      const fileId = file.getId();

      

      // æœªå‡¦ç†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡¦ç†

      if (!processedFiles.includes(fileId)) {

        Logger.log('æ–°ã—ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º: ' + file.getName());

        markFileAsProcessed(fileId, file.getName());

        newFilesProcessed = true;

      }

    }

    

    if (newFilesProcessed) {

      generatePeriodSummaries();

    }

    

  } catch (error) {

    Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ' + error.toString());

    sendErrorNotification(error);

  }

}


/**
 * é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆCPNåˆ¥é€²æ— / CRåˆ¥é€²æ—ã‚’é€±ã”ã¨ã«è¡¨ç¤ºï¼‰
 * CSVãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã€ŒCPNåˆ¥é€²æ—ã€ã‹ã€ŒCRåˆ¥é€²æ—ã€ã‚’åˆ¤æ–­ã—ã€é€±ã®æœŸé–“ã‚‚æŠ½å‡ºã—ã¾ã™ã€‚
 */
function generateWeeklyReport() {
  try {
    const fallbackId = '1QnBZuFKND26CYaX2Y79BjDTyyERKD-6F';
    const folderIds = [];
    if (CSV_FOLDER_ID) folderIds.push(CSV_FOLDER_ID);
    if (!folderIds.includes(fallbackId)) folderIds.push(fallbackId);
    
    /** @type {{file:GoogleAppsScript.Drive.File, name:string, type:'CPN'|'CR', start:Date, end:Date}[]} */
    const fileList = [];
    /** @type {{file:GoogleAppsScript.Drive.File, name:string}[]} */
    const monthlyFiles = [];
    const allNames = [];
    
    folderIds.forEach(folderId => {
      try {
        const folder = DriveApp.getFolderById(folderId);
        const files = folder.getFilesByType(MimeType.CSV);
        while (files.hasNext()) {
          const f = files.next();
          const name = f.getName();
          allNames.push(`${name} (folder:${folderId})`);
          const monthMatch = name.match(/(\d{1,2})æœˆ.*\.csv$/i);
          if (monthMatch) {
            monthlyFiles.push({ file: f, name });
            continue;
          }
          // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã€ŒCPNåˆ¥é€²æ—ã€ã‹ã€ŒCRåˆ¥é€²æ—ã€ã‚’åˆ¤æ–­
          const isCPN = /CPNåˆ¥é€²æ—/i.test(name);
          const isCR = /CRåˆ¥é€²æ—/i.test(name);
          if (!isCPN && !isCR) continue;
          
          const parsed = parseWeekFromFilename_(name);
          if (parsed) {
            fileList.push({
              file: f,
              name: name,
              type: isCPN ? 'CPN' : 'CR',
              start: parsed.start,
              end: parsed.end
            });
          }
        }
      } catch (folderErr) {
        Logger.log(`é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ: ãƒ•ã‚©ãƒ«ãƒ€å–å¾—ã«å¤±æ•— ${folderId}: ${folderErr}`);
      }
    });
    
    if (fileList.length === 0 && monthlyFiles.length === 0) {
      const nameList = allNames.length > 0 ? '- ' + allNames.join('\n- ') : '(ãªã—)';
      SpreadsheetApp.getUi().alert('CPNåˆ¥é€²æ—ã¾ãŸã¯CRåˆ¥é€²æ—ã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\næ¤œå‡ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å:\n' + nameList);
      return;
    }

    // é€±ã®çµ‚äº†æ—¥é™é †ã§ã‚½ãƒ¼ãƒˆ
    fileList.sort((a, b) => {
      if (a.end.getTime() !== b.end.getTime()) {
        return b.end.getTime() - a.end.getTime();
      }
      // åŒã˜é€±ã®å ´åˆã¯ã€CPNã‚’å…ˆã«
      if (a.type !== b.type) {
        return a.type === 'CPN' ? -1 : 1;
      }
      return 0;
    });

    // å‡ºåŠ›
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ');
    if (!sheet) sheet = ss.insertSheet('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ');
    sheet.clear();
    const colARangeAll = sheet.getRange(1, 1, sheet.getMaxRows(), 1);
    colARangeAll.setBorder(false, false, false, false, false, false);

    let rowCursor = 1;
    rowCursor += 3;
    const startCol = 2; // Båˆ—ã‹ã‚‰é–‹å§‹ï¼ˆAåˆ—ã¯ç©ºæ¬„ï¼‰
    
    // é€±ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const weekGroups = new Map();
    fileList.forEach(item => {
      const weekKey = `${formatMd_(item.start)}~${formatMd_(item.end)}`;
      if (!weekGroups.has(weekKey)) {
        weekGroups.set(weekKey, { start: item.start, end: item.end, cpn: [], cr: [] });
      }
      const group = weekGroups.get(weekKey);
      if (item.type === 'CPN') {
        group.cpn.push(item);
      } else {
        group.cr.push(item);
      }
    });

    // é€±ã®çµ‚äº†æ—¥æ˜‡é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é€±ã‹ã‚‰æ–°ã—ã„é€±ã¸ï¼‰
    const sortedWeeks = Array.from(weekGroups.entries()).sort((a, b) => 
      a[1].end.getTime() - b[1].end.getTime()
    );

    // CPNåˆ¥é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡ºåŠ›
    rowCursor = renderMonthlySummary_(sheet, rowCursor, startCol, monthlyFiles) + 1;
    rowCursor = renderWeeklySummary_(sheet, rowCursor, startCol, sortedWeeks) + 1;
    for (const [weekKey, group] of sortedWeeks) {
      if (group.cpn.length === 0) continue;
      
      const weekLabel = `${formatMd_(group.start)}~${formatMd_(group.end)}`;
      sheet.getRange(rowCursor, startCol, 1, 2).merge().setValue(`â–¼Outbrain CPNåˆ¥é€²æ— (${weekLabel})`)
        .setBackground('#a4c2f4').setFontColor('#000000').setFontWeight('bold');
      rowCursor++;
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼
      const tableHeaderRow = rowCursor;
      sheet.getRange(rowCursor, startCol, 1, 14).setValues([[
        'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³', 'é…ä¿¡é‡‘é¡', 'CPC', 'Imp', 'CPM', 'Click', 'CTR', 'CV', 'CVR', 'CAC', 'LPé·ç§»æ•°', 'LPé·ç§»ç‡', 'ãŠã‚„ã¤è¨ºæ–­', 'ãŠã‚„ã¤è¨ºæ–­ç‡'
      ]]).setBackground('#000000').setFontColor('#FFFFFF').setFontWeight('bold').setHorizontalAlignment('center');
      rowCursor++;
      
      // å„CPNãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
        const campaignMap = new Map();
      for (const item of group.cpn) {
        const csv = item.file.getBlob().getDataAsString('UTF-8');
        const rows = Utilities.parseCsv(csv);
        if (!rows || rows.length < 2) continue;
        
        const header = rows[0];
        const headerNormalized = header.map(normalizeHeader_);
        const idxCampaignName = header.findIndex(h => {
          if (!h) return false;
          const normalized = h.trim().toLowerCase().replace(/\s+/g, ' ');
          return normalized === 'campaign name';
        });
        const indices = findColumnIndices(header, CSV_COLUMN_TITLES);
        const idxCost = indices[3];
        const idxImp = indices[4];
        const idxClick = indices[6];
        const idxConv = indices[8];
        const idxLpTransitions = findColumnIndexByKeywords_(headerNormalized, [
          '01 lp gohobi conversions (click)',
          'lp gohobi conversions (click)',
          'lp conversions (click)',
          'lp transitions',
          'lpé·ç§»æ•°'
        ]);
        
        // Totalè¡Œã‹ã‚‰LPé·ç§»æ•°ã‚’å–å¾—
        let totalLpTransitions = 0;
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];
          if (!row || row.length === 0) continue;
          const campaignNameRaw = idxCampaignName >= 0 ? String(row[idxCampaignName] || '') : '';
          const campaignName = campaignNameRaw.trim().toLowerCase();
          if (campaignName === 'total' || campaignName === 'åˆè¨ˆ') {
            totalLpTransitions = cleanNumericValue(idxLpTransitions >= 0 ? row[idxLpTransitions] : null) || 0;
            break;
          }
        }
        
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];
          if (!row || row.length === 0) continue;
          
          const campaignNameRaw = idxCampaignName >= 0 ? String(row[idxCampaignName] || '') : '';
          const campaignName = campaignNameRaw.trim();
          if (!campaignName || campaignName.toLowerCase() === 'total' || campaignName.toLowerCase() === 'åˆè¨ˆ') continue;
          
          const costRaw = cleanNumericValue(idxCost >= 0 ? row[idxCost] : null) || 0;
          const cost = costRaw * AMOUNT_SPENT_ADJUSTMENT_RATE;
          const imp = cleanNumericValue(idxImp >= 0 ? row[idxImp] : null) || 0;
          const click = cleanNumericValue(idxClick >= 0 ? row[idxClick] : null) || 0;
          const conv = cleanNumericValue(idxConv >= 0 ? row[idxConv] : null) || 0;
          const lpTransitions = cleanNumericValue(idxLpTransitions >= 0 ? row[idxLpTransitions] : null) || 0;
          
          if (!campaignMap.has(campaignName)) {
            campaignMap.set(campaignName, { cost: 0, imp: 0, click: 0, conv: 0, lpTransitions: 0 });
          }
          const agg = campaignMap.get(campaignName);
          agg.cost += cost;
          agg.imp += imp;
          agg.click += click;
          agg.conv += conv;
          agg.lpTransitions += lpTransitions;
        }
        
        // Totalè¡Œã®LPé·ç§»æ•°ã‚’ä¿å­˜ï¼ˆå„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®é›†è¨ˆã«ä½¿ç”¨ï¼‰
        if (totalLpTransitions > 0 && campaignMap.size > 0) {
          // Totalè¡Œã®LPé·ç§»æ•°ã‚’å„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã«æ¯”ä¾‹é…åˆ†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          // ã“ã“ã§ã¯Totalè¡Œã®å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ãŸã‚ã€é›†è¨ˆå€¤ã‚’ä½¿ç”¨
        }
      }
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡ºåŠ›
      const campaigns = Array.from(campaignMap.entries())
        .filter(([name, data]) => data.cost > 0)
        .sort((a, b) => b[1].cost - a[1].cost);
      if (campaigns.length > 0) {
        const values = campaigns.map(([name, data]) => {
          const cpc = data.click > 0 ? data.cost / data.click : 0;
          const cpm = data.imp > 0 ? data.cost / data.imp * 1000 : 0;
          const ctr = data.imp > 0 ? (data.click / data.imp) * 100 : 0;
          const cvr = data.click > 0 ? (data.conv / data.click) * 100 : 0;
          const cac = data.conv > 0 ? data.cost / data.conv : 0;
          return [
            name,
            'Â¥' + Math.round(data.cost).toLocaleString(),
            'Â¥' + cpc.toFixed(1),
            data.imp.toLocaleString(),
            'Â¥' + Math.round(cpm),
            data.click.toLocaleString(),
            ctr.toFixed(2) + '%',
            data.conv,
            cvr.toFixed(2) + '%',
            data.conv > 0 ? 'Â¥' + Math.round(cac).toLocaleString() : '-',
            data.lpTransitions || 0,
            '',
            '', ''
          ];
        });
        sheet.getRange(rowCursor, startCol, values.length, 14).setValues(values);
        // LPé·ç§»ç‡ã®è¨ˆç®—å¼ã‚’è¨­å®šï¼ˆLPé·ç§»æ•°/Clickï¼‰
        const lpRateFormulas = campaigns.map(([name, data], i) => {
          const clickCol = startCol + 5; // Clickåˆ—ï¼ˆstartCol=2ã®å ´åˆã€7åˆ—ç›®=Gåˆ—ï¼‰
          const lpCol = startCol + 10; // LPé·ç§»æ•°åˆ—ï¼ˆstartCol=2ã®å ´åˆã€12åˆ—ç›®=Låˆ—ï¼‰
          const clickColLetter = String.fromCharCode(64 + clickCol);
          const lpColLetter = String.fromCharCode(64 + lpCol);
          return [`=IF(${clickColLetter}${rowCursor + i}>0, ${lpColLetter}${rowCursor + i}/${clickColLetter}${rowCursor + i}, "")`];
        });
        sheet.getRange(rowCursor, startCol + 11, values.length, 1).setFormulas(lpRateFormulas);
        rowCursor += values.length;
      }
      const tableRows = rowCursor - tableHeaderRow;
      sheet.getRange(tableHeaderRow, startCol, tableRows, 14)
        .setBorder(true, true, true, true, true, true);
      const leftBorderRange = sheet.getRange(tableHeaderRow, startCol - 1, tableRows, 1);
      leftBorderRange.setBorder(false, false, false, true, false, false).clearContent();
      sheet.getRange(tableHeaderRow, startCol, 1, 14).setHorizontalAlignment('center');
      const cpnDataRows = tableRows - 1;
      if (cpnDataRows > 0) {
        sheet.getRange(tableHeaderRow + 1, startCol, cpnDataRows, 1).setHorizontalAlignment('left');
        sheet.getRange(tableHeaderRow + 1, startCol + 1, cpnDataRows, 13).setHorizontalAlignment('right');
      }
      rowCursor += 2;
    }

    // CRåˆ¥é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡ºåŠ›
    for (const [weekKey, group] of sortedWeeks) {
      if (group.cr.length === 0) continue;
      
      const weekLabel = `${formatMd_(group.start)}~${formatMd_(group.end)}`;
      sheet.getRange(rowCursor, startCol, 1, 2).merge().setValue(`â–¼Outbrain CRåˆ¥é€²æ— (${weekLabel})`)
        .setBackground('#ea9999').setFontColor('#000000').setFontWeight('bold');
      rowCursor++;
      // 1è¡Œç©ºç™½ã‚’è¿½åŠ 
      rowCursor++;
      
      // CSVã®è¡Œé †ã§ãã®ã¾ã¾å‡ºåŠ›ï¼ˆé…ä¿¡é‡‘é¡ãŒ0ä»¥ä¸‹ã¯é™¤å¤–ï¼‰
      for (const item of group.cr) {
        const csv = item.file.getBlob().getDataAsString('UTF-8');
        const rows = Utilities.parseCsv(csv);
        if (!rows || rows.length < 2) continue;
        
        const header = rows[0];
        // Campaign Nameã‚’å–å¾—
        const idxCampaignName = header.findIndex(h => {
          if (!h) return false;
          const normalized = h.trim().toLowerCase().replace(/\s+/g, ' ');
          return normalized === 'campaign name';
        });
        const indices = findColumnIndices(header, CSV_COLUMN_TITLES);
        const idxImage = indices[0];
        const idxContentTitle = indices[1];
        const idxCost = indices[3];
        const idxImp = indices[4];
        const idxClick = indices[6];
        const idxConv = indices[8];
        
        // LPé·ç§»æ•°ã®åˆ—ã‚’å–å¾—
        const headerNormalized = header.map(normalizeHeader_);
        const idxLpTransitions = findColumnIndexByKeywords_(headerNormalized, [
          '01 lp gohobi conversions (click)',
          'lp gohobi conversions (click)',
          'lp conversions (click)',
          'lp transitions',
          'lpé·ç§»æ•°'
        ]);
        
        // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’å–å¾—ï¼ˆæœ€åˆã®ãƒ‡ãƒ¼ã‚¿è¡Œã‹ã‚‰ï¼‰
        let campaignName = '';
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];
          if (!row || row.length === 0) continue;
          const costRaw = cleanNumericValue(idxCost >= 0 ? row[idxCost] : null) || 0;
          if (costRaw > 0) {
            campaignName = idxCampaignName >= 0 ? String(row[idxCampaignName] || '') : '';
            break;
          }
        }
        
        // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’è¡¨ç¤º
        if (campaignName) {
          sheet.getRange(rowCursor, startCol).setValue(campaignName).setFontWeight('bold');
          rowCursor++;
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆAåˆ—: ç©ºã€Båˆ—: ç”»åƒè¡¨ç¤ºã€Cåˆ—: ãƒ†ã‚­ã‚¹ãƒˆ...ï¼‰
        const tableHeaderRow = rowCursor;
        sheet.getRange(rowCursor, 1, 1, 13).setValues([[
          '', 'ç”»åƒè¡¨ç¤º', 'ãƒ†ã‚­ã‚¹ãƒˆ', 'è»¸', 'é…ä¿¡é‡‘é¡', 'CPC', 'Imp', 'Click', 'CTR', 'CV', 'CVR', 'CAC', 'LPé·ç§»æ•°'
        ]]).setBackground('#000000').setFontColor('#FFFFFF').setFontWeight('bold').setHorizontalAlignment('center');
        // LPé·ç§»ç‡ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ï¼ˆ14åˆ—ç›®ï¼‰
        sheet.getRange(rowCursor, 14).setValue('LPé·ç§»ç‡').setBackground('#000000').setFontColor('#FFFFFF').setFontWeight('bold').setHorizontalAlignment('center');
        rowCursor++;
        
        const values = [];
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];
          if (!row || row.length === 0) continue;
          
          const contentTitle = idxContentTitle >= 0 ? String(row[idxContentTitle] || '') : '';
          const costRaw = cleanNumericValue(idxCost >= 0 ? row[idxCost] : null) || 0;
          if (!contentTitle || costRaw <= 0) continue;
          
          const cost = costRaw * AMOUNT_SPENT_ADJUSTMENT_RATE;
          const imp = cleanNumericValue(idxImp >= 0 ? row[idxImp] : null) || 0;
          const click = cleanNumericValue(idxClick >= 0 ? row[idxClick] : null) || 0;
          const conv = cleanNumericValue(idxConv >= 0 ? row[idxConv] : null) || 0;
          const image = idxImage >= 0 ? String(row[idxImage] || '') : '';
          const lpTransitions = cleanNumericValue(idxLpTransitions >= 0 ? row[idxLpTransitions] : null) || 0;
          
          const cpc = click > 0 ? cost / click : 0;
          const ctr = imp > 0 ? (click / imp) * 100 : 0;
          const cvr = click > 0 ? (conv / click) * 100 : 0;
          const cac = conv > 0 ? cost / conv : 0;
          
          values.push([
            image,
            '',
            contentTitle,
            '',
            'Â¥' + Math.round(cost).toLocaleString(),
            'Â¥' + cpc.toFixed(1),
            imp.toLocaleString(),
            click.toLocaleString(),
            ctr.toFixed(2) + '%',
            conv,
            cvr.toFixed(2) + '%',
            conv > 0 ? 'Â¥' + Math.round(cac).toLocaleString() : '-',
            lpTransitions,
            ''
          ]);
        }
        
        if (values.length > 0) {
          sheet.getRange(rowCursor, 1, values.length, 14).setValues(values);
          const imgFormulas = values.map((_, i) => [`=IF(A${rowCursor + i}<>"", IMAGE(A${rowCursor + i}, 1), "")`]);
          sheet.getRange(rowCursor, 2, values.length, 1).setFormulas(imgFormulas);
          const lpRateFormulas = values.map((_, i) => [`=IF(H${rowCursor + i}>0, M${rowCursor + i}/H${rowCursor + i}, "")`]);
          sheet.getRange(rowCursor, 14, values.length, 1).setFormulas(lpRateFormulas);
          rowCursor += values.length;
        }
        const tableRows = rowCursor - tableHeaderRow;
        sheet.getRange(tableHeaderRow, 1, tableRows, 14)
          .setBorder(true, true, true, true, true, true);
        sheet.getRange(tableHeaderRow, 1, 1, 14).setHorizontalAlignment('center');
        const crDataRows = tableRows - 1;
        if (crDataRows > 0) {
          sheet.getRange(tableHeaderRow + 1, 1, crDataRows, 3).setHorizontalAlignment('left');
          sheet.getRange(tableHeaderRow + 1, 4, crDataRows, 1).setHorizontalAlignment('center');
          sheet.getRange(tableHeaderRow + 1, 5, crDataRows, 10).setHorizontalAlignment('right');
        }
      }
      rowCursor += 1;
    }

    // ä½“è£
    sheet.getRange(1, 1, rowCursor, 1)
      .setBackground(null)
      .setFontColor('#FFFFFF');
    // A40:A77 ã®æ ç·šã‚’ã‚¯ãƒªã‚¢ï¼ˆBåˆ—å´ã®ç¸¦ç·šã¯ç¶­æŒï¼‰
    sheet.getRange(40, 1, 38, 1).setBorder(false, false, false, false, false, false);

    const lastCol = 17;
    for (let c = 1; c <= lastCol; c++) sheet.autoResizeColumn(c);
    // Aåˆ—ã®å¹…ã‚’è¨­å®š
    sheet.setColumnWidth(1, 70);
    // Båˆ—ï¼ˆç”»åƒè¡¨ç¤ºï¼‰ã®å¹…ã‚’è¨­å®š
    sheet.setColumnWidth(2, 120);
    // Dã€œQåˆ—ã®å¹…ã‚’80ã«è¨­å®š
    for (let c = 4; c <= 17; c++) {
      sheet.setColumnWidth(c, 80);
    }
  } catch (e) {
    Logger.log('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    sendErrorNotification(e);
    SpreadsheetApp.getUi().alert('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.toString());
  }
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã€Œé€±ã®é–‹å§‹æ—¥ï½çµ‚äº†æ—¥ã€ã‚’æ¨å®š
 * ä¾‹: "10/20~10/26", "2024-10-20~2024-10-26", "20241020-20241026", "10_20ã€œ10_26"
 */
function parseWeekFromFilename_(name) {
  if (!name) return null;
  const s = String(name);
  // åŒºåˆ‡ã‚Šï¼ˆ~, ã€œ, ï½, -, ãƒ¼, _, "to"ï¼‰
  const sep = '(?:~|ã€œ|ï½|\\-|ãƒ¼|to|_)';
  // æ—¥ä»˜åŒºåˆ‡ã‚Šï¼ˆ/, -, _, ., å…¨è§’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼, å…¨è§’ãƒã‚¤ãƒ•ãƒ³ï¼ï¼‰
  const dsep = '[\\./_\\-ï¼ï¼]?';
  // yyyy[-/_ï¼ï¼]?MM[-/_ï¼ï¼]?dd <sep> yyyy[-/_ï¼ï¼]?MM[-/_ï¼ï¼]?dd
  const reYmd = new RegExp('(20\\d{2})' + dsep + '(\\d{2})' + dsep + '(\\d{2})\\s*' + sep + '\\s*(20\\d{2})' + dsep + '(\\d{2})' + dsep + '(\\d{2})');
  let m = s.match(reYmd);
  if (m) {
    const start = new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00+09:00`);
    const end = new Date(`${m[4]}-${m[5]}-${m[6]}T00:00:00+09:00`);
    return { start, end };
  }
  // MM[sep]?dd <sep> MM[sep]?ddï¼ˆå¹´ã¯ä»Šå¹´ï¼‰
  const reMd = new RegExp('(\\d{1,2})' + dsep + '(\\d{1,2})\\s*' + sep + '\\s*(\\d{1,2})' + dsep + '(\\d{1,2})');
  m = s.match(reMd);
  if (m) {
    const now = new Date();
    const year = now.getFullYear();
    const start = new Date(`${year}-${pad2_(m[1])}-${pad2_(m[2])}T00:00:00+09:00`);
    const end = new Date(`${year}-${pad2_(m[3])}-${pad2_(m[4])}T00:00:00+09:00`);
    return { start, end };
  }
  return null;
}

function pad2_(n) {
  return ('0' + Number(n)).slice(-2);
}

function formatMd_(d) {
  return Utilities.formatDate(d, 'JST', 'MM/dd');
}

function renderMonthlySummary_(sheet, startRow, startCol, monthlyFiles) {
  if (!monthlyFiles || monthlyFiles.length === 0) {
    return startRow - 1;
  }
  const monthlyData = getMonthlySummaryData_(monthlyFiles);
  if (monthlyData.length === 0) {
    return startRow - 1;
  }
  let row = startRow;
  const width = 14;
  sheet.getRange(row, startCol, 1, width).merge().setValue('ï¼œæœˆåˆ¥é€²æ—ï¼').setFontWeight('bold').setHorizontalAlignment('left');
  row++;
  const headerLabels = ['æœˆ', 'é…ä¿¡é‡‘é¡', 'CPC', 'Imp', 'Click', 'CTR', 'ç®¡ç†CV', 'ç®¡ç†CVR', 'ç®¡ç†CAC', 'è²´ç¤¾CV', 'è²´ç¤¾CVR', 'è²´ç¤¾CAC', 'è»¢æ›ç‡', ''];
  const headerRow = row;
  sheet.getRange(row, startCol, 1, headerLabels.length).setValues([headerLabels])
    .setBackground('#000000').setFontColor('#FFFFFF').setFontWeight('bold');
  row++;
  monthlyData.forEach(item => {
    sheet.getRange(row, startCol, 1, headerLabels.length).setValues([[item.month, item.cost, item.cpc, item.imp, item.click, item.ctr, item.managerCv, item.managerCvr, item.managerCac, item.clientCv, item.clientCvr, item.clientCac, item.conversionRate, '']]);
    row++;
  });
  const tableRows = row - headerRow;
  sheet.getRange(headerRow, startCol, tableRows, headerLabels.length)
    .setBorder(true, true, true, true, true, true);
  sheet.getRange(headerRow, startCol - 1, tableRows, 1)
    .setBorder(false, false, false, true, false, false)
    .clearContent();
  const headerRange = sheet.getRange(headerRow, startCol, 1, headerLabels.length);
  headerRange.setHorizontalAlignment('center');
  headerRange.setBorder(true, true, true, true, true, true);
  const dataRowCount = tableRows - 1;
  if (dataRowCount > 0) {
    const centeredCols = Math.min(1, headerLabels.length);
    sheet.getRange(headerRow + 1, startCol, dataRowCount, centeredCols)
      .setHorizontalAlignment('center')
      .setBorder(true, true, true, true, true, true);
    if (headerLabels.length > centeredCols) {
      sheet.getRange(headerRow + 1, startCol + centeredCols, dataRowCount, headerLabels.length - centeredCols)
        .setHorizontalAlignment('right')
        .setBorder(true, true, true, true, true, true);
    }
  }
  return row;
}

function renderWeeklySummary_(sheet, startRow, startCol, sortedWeeks) {
  const weeklyData = getWeeklySummaryData_(sortedWeeks);
  if (weeklyData.length === 0) {
    return startRow - 1;
  }
  let row = startRow;
  const headerLabels = ['é€±', 'é…ä¿¡é‡‘é¡', 'CPC', 'Imp', 'Click', 'CTR', 'ç®¡ç†CV', 'ç®¡ç†CVR', 'ç®¡ç†CAC', 'è²´ç¤¾CV', 'è²´ç¤¾CVR', 'è²´ç¤¾CAC', 'è»¢æ›ç‡'];
  const tableWidth = headerLabels.length;
  sheet.getRange(row, startCol, 1, tableWidth).merge().setValue('ï¼œé€±åˆ¥é€²æ—ï¼').setFontWeight('bold').setHorizontalAlignment('left');
  row++;
  const headerRow = row;
  // é€±åˆ—ã‚’é–‹å§‹æ—¥ã€ã€œã€çµ‚äº†æ—¥ã®3åˆ—ã«åˆ†å‰²
  sheet.getRange(row, startCol, 1, tableWidth).setValues([headerLabels])
    .setBackground('#000000').setFontColor('#FFFFFF').setFontWeight('bold');
  row++;
  weeklyData.forEach(item => {
    // weekå½¢å¼ã¯ "10/20~10/26" ã®ã‚ˆã†ãªå½¢å¼ãªã®ã§ã€åˆ†å‰²ã™ã‚‹
    const weekParts = item.week.split(/[~ã€œï½]/);
    const startDate = weekParts[0] || '';
    const endDate = weekParts[1] || '';
    const periodLabel = `${startDate}ã€œ${endDate}`;
    sheet.getRange(row, startCol, 1, tableWidth).setValues([[
      periodLabel, item.cost, item.cpc, item.imp, item.click, item.ctr,
      item.managerCv, item.managerCvr, item.managerCac, item.clientCv, item.clientCvr, item.clientCac, item.conversionRate
    ]]);
    row++;
  });
  const tableRows = row - headerRow;
  sheet.getRange(headerRow, startCol, tableRows, tableWidth)
    .setBorder(true, true, true, true, true, true);
  sheet.getRange(headerRow, startCol - 1, tableRows, 1)
    .setBorder(false, false, false, true, false, false)
    .clearContent();
  sheet.getRange(headerRow, startCol, 1, tableWidth).setHorizontalAlignment('center');
  const weeklyDataRowCount = tableRows - 1;
  if (weeklyDataRowCount > 0) {
    sheet.getRange(headerRow + 1, startCol, weeklyDataRowCount, 1).setHorizontalAlignment('center');
    if (tableWidth > 1) {
      sheet.getRange(headerRow + 1, startCol + 1, weeklyDataRowCount, tableWidth - 1)
        .setHorizontalAlignment('right');
    }
  }
  return row;
}

function getMonthlySummaryData_(monthlyFiles) {
  const data = [];
  const sorted = [...monthlyFiles].sort((a, b) => a.name.localeCompare(b.name, 'ja'));
  const currentYear = new Date().getFullYear();
  sorted.forEach(fileInfo => {
    const summary = extractSummaryFromCsv_(fileInfo.file);
    if (summary) {
      let monthLabel = fileInfo.name.replace(/\.csv$/i, '');
      // ãƒ•ã‚¡ã‚¤ãƒ«åã«å¹´ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€ç¾åœ¨ã®å¹´ã‚’è¿½åŠ 
      if (!/^\d{4}å¹´/.test(monthLabel)) {
        monthLabel = `${currentYear}å¹´${monthLabel}`;
      }
      data.push({
        month: monthLabel,
        ...summary
      });
    }
  });
  return data;
}

function getWeeklySummaryData_(sortedWeeks) {
  const data = [];
  sortedWeeks.forEach(([weekKey, group]) => {
    if (!group.cpn || group.cpn.length === 0) return;
    const summary = extractSummaryFromCsv_(group.cpn[0].file);
    if (summary) {
      data.push({
        week: weekKey,
        ...summary
      });
    }
  });
  return data;
}

function extractSummaryFromCsv_(file) {
  try {
    const csv = file.getBlob().getDataAsString('UTF-8');
    const rows = Utilities.parseCsv(csv);
    if (!rows || rows.length < 2) return null;
    const header = rows[0];
    
    // CSV_COLUMN_TITLESã‚’ä½¿ç”¨ã—ã¦åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
    const indices = findColumnIndices(header, CSV_COLUMN_TITLES);
    const idxCampaignName = header.findIndex(h => {
      if (!h) return false;
      const normalized = h.trim().toLowerCase().replace(/\s+/g, ' ');
      return normalized === 'campaign name';
    });
    const idxCost = indices[3]; // Amount Spent
    const idxImp = indices[4];  // Impressions
    const idxCpc = indices[5];  // Avg. CPC
    const idxClick = indices[6]; // Clicks
    const idxCtr = indices[7];   // CTR
    const idxConv = indices[8];  // Conversions (Click)
    const idxCvr = indices[9];   // Conversion Rate (Click)
    const idxCac = indices[10];  // CPA (Click)
    
    // Totalè¡Œã‚’æ¢ã™ï¼ˆCampaign NameãŒ "Total" ã¾ãŸã¯ "åˆè¨ˆ" ã®è¡Œï¼‰
    let dataRow = null;
    let dataRowIndex = -1;
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (!row || row.length === 0) continue;
      
      const campaignName = idxCampaignName >= 0 ? String(row[idxCampaignName] || '').trim().toLowerCase() : '';
      if (campaignName === 'total' || campaignName === 'åˆè¨ˆ' || campaignName === 'totals') {
        dataRow = row;
        dataRowIndex = i;
        break;
      }
    }
    
    // Totalè¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€å¾Œã®è¡Œã‚’è©¦ã™ï¼ˆé›†è¨ˆè¡ŒãŒæœ€å¾Œã«ã‚ã‚‹å ´åˆï¼‰
    if (!dataRow && rows.length > 1) {
      dataRow = rows[rows.length - 1];
      dataRowIndex = rows.length - 1;
    }
    
    if (!dataRow) return null;
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const costRaw = cleanNumericValue(idxCost >= 0 ? dataRow[idxCost] : null) || 0;
    const cost = costRaw * AMOUNT_SPENT_ADJUSTMENT_RATE; // /0.8*1.1 ã®è¨ˆç®—
    const cpcRaw = cleanNumericValue(idxCpc >= 0 ? dataRow[idxCpc] : null);
    const impRaw = cleanNumericValue(idxImp >= 0 ? dataRow[idxImp] : null);
    const clickRaw = cleanNumericValue(idxClick >= 0 ? dataRow[idxClick] : null);
    const ctrRaw = idxCtr >= 0 ? String(dataRow[idxCtr] || '') : '';
    const managerCvRaw = cleanNumericValue(idxConv >= 0 ? dataRow[idxConv] : null);
    const managerCvrRaw = idxCvr >= 0 ? String(dataRow[idxCvr] || '') : '';
    const managerCacRaw = cleanNumericValue(idxCac >= 0 ? dataRow[idxCac] : null);
    
    // è²´ç¤¾è¨ˆæ¸¬ã®CV/CVR/CACã¯ã€ç¾æ™‚ç‚¹ã§ã¯CSVã«å«ã¾ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ç©ºã«ã™ã‚‹
    // è»¢æ›ç‡ã‚‚åŒæ§˜
    const clientCvRaw = null;
    const clientCvrRaw = '';
    const clientCacRaw = null;
    const conversionRateRaw = '';
    
    return {
      cost: formatCurrency_(cost),
      cpc: formatCurrencyDecimal_(cpcRaw),
      imp: formatInteger_(impRaw),
      click: formatInteger_(clickRaw),
      ctr: formatPercent_(ctrRaw),
      managerCv: formatInteger_(managerCvRaw),
      managerCvr: formatPercent_(managerCvrRaw),
      managerCac: formatCurrency_(managerCacRaw),
      clientCv: formatInteger_(clientCvRaw),
      clientCvr: formatPercent_(clientCvrRaw),
      clientCac: formatCurrency_(clientCacRaw),
      conversionRate: formatPercent_(conversionRateRaw)
    };
  } catch (e) {
    Logger.log('ã‚µãƒãƒªãƒ¼æŠ½å‡ºå¤±æ•—: ' + e.toString());
    return null;
  }
}

function normalizeHeader_(value) {
  return String(value || '').replace(/\s+/g, '').toLowerCase();
}

function findColumnIndexByKeywords_(header, keywords) {
  const normalizedKeywords = keywords.map(k => normalizeHeader_(k));
  for (let i = 0; i < header.length; i++) {
    const cell = header[i];
    if (normalizedKeywords.includes(cell)) {
      return i;
    }
  }
  return -1;
}

function formatCurrency_(value) {
  if (value === null || value === undefined) return '';
  const num = typeof value === 'number' ? value : cleanNumericValue(value);
  if (num === null || isNaN(num)) return '';
  return 'Â¥' + Math.round(num).toLocaleString();
}

function formatCurrencyDecimal_(value) {
  if (value === null || value === undefined) return '';
  const num = typeof value === 'number' ? value : cleanNumericValue(value);
  if (num === null || isNaN(num)) return '';
  return 'Â¥' + Number(num).toFixed(1);
}

function formatInteger_(value) {
  if (value === null || value === undefined) return '';
  const num = typeof value === 'number' ? value : cleanNumericValue(value);
  if (num === null || isNaN(num)) return '';
  return Math.round(num).toLocaleString();
}

function formatPercent_(value) {
  if (value === null || value === undefined || value === '') return '';
  const str = String(value);
  if (str.indexOf('%') !== -1) {
    return str;
  }
  const num = cleanNumericValue(str);
  if (num === null || isNaN(num)) return '';
  return Number(num).toFixed(2) + '%';
}

/**

 * å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’å–å¾—

 */

function getProcessedFiles() {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let logSheet = ss.getSheetByName('å‡¦ç†ãƒ­ã‚°');

  

  if (!logSheet) {

    logSheet = ss.insertSheet('å‡¦ç†ãƒ­ã‚°');

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å®‰å…¨ã«è¿½åŠ 

    const headers = ['ãƒ•ã‚¡ã‚¤ãƒ«ID', 'ãƒ•ã‚¡ã‚¤ãƒ«å', 'å‡¦ç†æ—¥æ™‚'];

    if (headers && headers.length > 0) {

      logSheet.appendRow(headers);

    }

  }

  

  const data = logSheet.getDataRange().getValues();

  return data.slice(1).map(row => row[0]); // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤ã

}

/**

 * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯

 */

function markFileAsProcessed(fileId, fileName) {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const logSheet = ss.getSheetByName('å‡¦ç†ãƒ­ã‚°');

  // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª

  const rowData = [fileId || '', fileName || '', new Date()];

  if (rowData && rowData.length > 0 && rowData.some(cell => cell !== '')) {

    logSheet.appendRow(rowData);

  }

}

/**

 * æ‰‹å‹•ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã¿

 */

function manualImportCSV() {

  const ui = SpreadsheetApp.getUi();

  

  if (!CSV_FOLDER_ID) {

    ui.alert('ã‚¨ãƒ©ãƒ¼', 'CSVãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆæœŸè¨­å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);

    return;

  }

  

  try {

    generatePeriodSummaries();

    ui.alert('Driveå†…ã®æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚');

  } catch (error) {

    ui.alert('ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString(), ui.ButtonSet.OK);

  }

}

/**

 * CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å–ã‚Šè¾¼ã¿ï¼ˆåˆ—ã‚¿ã‚¤ãƒˆãƒ«åã‹ã‚‰è‡ªå‹•æ¤œå‡ºï¼‰

 */

function importCSVToSheet(file) {

  try {

    const ss = SpreadsheetApp.getActiveSpreadsheet();

    let dataSheet = ss.getSheetByName('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

    

    // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿

    const csvContent = file.getBlob().getDataAsString('UTF-8');

    
    // ç©ºã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
    if (!csvContent || csvContent.trim() === '') {
      Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
      throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
    }
    
    const csvData = Utilities.parseCsv(csvContent);
    

    if (csvData.length === 0) {

      Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

      throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

    }

    

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‹ã‚‰åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—

    const headerRow = csvData[0];

    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
    if (!headerRow || headerRow.length === 0 || headerRow.join('').trim() === '') {
      Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒç©ºã§ã™');
      throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒç©ºã§ã™');
    }
    
    const columnIndices = findColumnIndices(headerRow, CSV_COLUMN_TITLES);

    

    // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸåˆ—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²

    const notFoundColumns = CSV_COLUMN_TITLES.filter((title, index) => columnIndices[index] === -1);

    if (notFoundColumns.length > 0) {

      Logger.log('è­¦å‘Š: ä»¥ä¸‹ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ' + notFoundColumns.join(', '));

    }

    

    // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ

    if (!dataSheet) {

      dataSheet = ss.insertSheet('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ ï¼ˆæ—¥æœ¬èªã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨ï¼‰

      // SHEET_HEADER_TITLESãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª

      if (SHEET_HEADER_TITLES && SHEET_HEADER_TITLES.length > 0) {

        dataSheet.appendRow(SHEET_HEADER_TITLES);

      } else {

        throw new Error('ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');

      }

      

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

      const headerRange = dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length);

      headerRange.setBackground('#4A86E8');

      headerRange.setFontColor('#FFFFFF');

      headerRange.setFontWeight('bold');

      headerRange.setHorizontalAlignment('center');

    } else {

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒæ­£ã—ã„ã‹ç¢ºèªãƒ»æ›´æ–°

      const currentHeaders = dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length).getValues()[0];

      const headersMatch = currentHeaders.every((header, index) => header === SHEET_HEADER_TITLES[index]);

      

      if (!headersMatch) {

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°

        dataSheet.getRange(1, 1, 1, SHEET_HEADER_TITLES.length).setValues([SHEET_HEADER_TITLES]);

      }

      

      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¯æ®‹ã™ï¼‰

      const lastRow = dataSheet.getLastRow();

      if (lastRow > 1) {

        dataSheet.getRange(2, 1, lastRow - 1, dataSheet.getLastColumn()).clearContent();

        dataSheet.getRange(2, 1, lastRow - 1, dataSheet.getLastColumn()).setBackground(null);

      }

    }

    

    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†ï¼ˆãƒãƒƒãƒå‡¦ç†ã§åŠ¹ç‡åŒ–ï¼‰

    const rowsToInsert = [];

    const imageUrls = [];

    for (let i = 1; i < csvData.length; i++) {

      const row = csvData[i];

      if (!row || row.length === 0) {

        continue;

      }

      const rowContent = row.join('').trim();

      if (rowContent === '') {

        continue;

      }

      const extractedData = columnIndices.map(colIndex => {

        if (colIndex !== -1 && colIndex < row.length) {

          const value = row[colIndex];

          return value !== null && value !== undefined ? String(value).trim() : '';

        }

        return '';

      });

      const hasValidData = extractedData.some(cell => cell !== '');

      if (!hasValidData || extractedData.length === 0) {

        continue;

      }

      const imageUrl = extractedData[0] || '';

      const contentTitle = extractedData[1] || '';

      const rawAmount = cleanNumericValue(extractedData[3]) || 0;

      if (rawAmount <= 0) {

        continue;

      }

      const adjustedAmount = rawAmount * AMOUNT_SPENT_ADJUSTMENT_RATE;

      const amountSpent = formatCurrencyWithDecimals_(adjustedAmount);

      const impressions = extractedData[4] || '';

      const avgCpc = extractedData[5] || '';

      const clicks = extractedData[6] || '';

      const ctr = extractedData[7] || '';

      const conversions = extractedData[8] || '';

      const cvr = extractedData[9] || '';

      const cpa = extractedData[10] || '';

      const rowValues = [

        '',

        contentTitle,

        adjustedAmount,

        impressions,

        avgCpc,

        clicks,

        ctr,

        conversions,

        cvr,

        cpa

      ];

      if (rowValues.length !== SHEET_HEADER_TITLES.length) {

        Logger.log(`importCSVToSheet length mismatch: data=${rowValues.length}, expected=${SHEET_HEADER_TITLES.length}, row=${JSON.stringify(rowValues)}`);

        throw new Error(`CSVåˆ—æ•°ãŒæƒ³å®šã¨ç•°ãªã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿åˆ—æ•°: ${rowValues.length}, æœŸå¾…å€¤: ${SHEET_HEADER_TITLES.length}\nè©²å½“è¡Œ: ${JSON.stringify(rowValues)}`);

      }

      rowsToInsert.push(rowValues);

      imageUrls.push(imageUrl);

    }

    if (rowsToInsert.length > 0) {

      const lastRow = dataSheet.getLastRow();

      const startRow = lastRow + 1;

      const targetRange = dataSheet.getRange(startRow, 1, rowsToInsert.length, SHEET_HEADER_TITLES.length);

      targetRange.setValues(rowsToInsert);

      const imageFormulas = imageUrls.map(url => {

        if (url && url.trim() !== '') {

          const safeUrl = url.replace(/"/g, '""');

          return [`=IF(LEN("${safeUrl}"), IMAGE("${safeUrl}", 1), "")`];

        }

        return [''];

      });

      dataSheet.getRange(startRow, 1, rowsToInsert.length, 1).setFormulas(imageFormulas);

      Logger.log(`${rowsToInsert.length}è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);

    } else {

      Logger.log('è¿½åŠ ã™ã‚‹æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

      throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“');

    }

    for (let i = 3; i <= SHEET_HEADER_TITLES.length; i++) {

      dataSheet.autoResizeColumn(i);

    }

    dataSheet.setColumnWidth(1, 120);

    dataSheet.setColumnWidth(2, 220);

    for (let i = 3; i <= SHEET_HEADER_TITLES.length; i++) {

      dataSheet.setColumnWidth(i, 90);

    }
    

    Logger.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ' + file.getName());

    
  } catch (error) {
    Logger.log('CSVå–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.toString());
    Logger.log('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ' + error.stack);
    throw error;
  }
}

/**

 * ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‹ã‚‰æŒ‡å®šã•ã‚ŒãŸåˆ—ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢

 * @param {Array} headerRow - CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ

 * @param {Array} targetTitles - æ¤œç´¢ã™ã‚‹åˆ—ã‚¿ã‚¤ãƒˆãƒ«ã®é…åˆ—

 * @return {Array} å„ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯-1ï¼‰

 */

function findColumnIndices(headerRow, targetTitles) {

  Logger.log('=== CSVåˆ—ã®æ¤œç´¢ã‚’é–‹å§‹ ===');

  Logger.log('CSVãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: ' + JSON.stringify(headerRow));

  

  const indices = targetTitles.map((targetTitle, idx) => {

    const candidates = [targetTitle, ...((CSV_COLUMN_ALIASES[targetTitle] || []))];

    let foundIndex = -1;

    for (let candidate of candidates) {

      if (!candidate) continue;

      foundIndex = headerRow.findIndex(header => header && header.trim() === candidate.trim());

      if (foundIndex !== -1) break;

      const loweredCandidate = candidate.trim().toLowerCase();

      foundIndex = headerRow.findIndex(header => header && header.trim().toLowerCase() === loweredCandidate);

      if (foundIndex !== -1) break;

    }

    if (foundIndex !== -1) {

      Logger.log(`âœ“ [${idx}] "${targetTitle}" â†’ CSVåˆ—${foundIndex + 1} (${headerRow[foundIndex]})`);

    } else {

      Logger.log(`âœ— [${idx}] "${targetTitle}" â†’ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (å€™è£œ: ${candidates.join(', ')})`);

    }

    return foundIndex;

  });

  

  Logger.log('=== åˆ—ã®æ¤œç´¢å®Œäº† ===');

  return indices;

}

/**

 * KPIã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š

 * @param {string} kpiType - 'CTR', 'CPC', 'CPA'

 * @param {number} value - åˆ¤å®šã™ã‚‹å€¤

 * @return {Object} statusæƒ…å ±ï¼ˆlevel, color, label, actionï¼‰

 */

function getKPIStatus(kpiType, value) {

  if (value === null || value === undefined) {

    return null;

  }

  

  const standards = KPI_STANDARDS[kpiType];

  const actions = IMPROVEMENT_ACTIONS[kpiType];

  

  // CTRã®åˆ¤å®š

  if (kpiType === 'CTR') {

    if (value >= standards.healthy.min) {

      return { level: 'healthy', color: standards.healthy.color, label: standards.healthy.label, action: actions.healthy };

    } else if (value >= standards.warning.min && value <= standards.warning.max) {

      return { level: 'warning', color: standards.warning.color, label: standards.warning.label, action: actions.warning };

    } else if (value <= standards.danger.max) {

      return { level: 'danger', color: standards.danger.color, label: standards.danger.label, action: actions.danger };

    }

  }

  

  // CPCã®åˆ¤å®š

  if (kpiType === 'CPC') {

    if (value <= standards.healthy.max) {

      return { level: 'healthy', color: standards.healthy.color, label: standards.healthy.label, action: actions.healthy };

    } else if (value >= standards.warning.min && value <= standards.warning.max) {

      return { level: 'warning', color: standards.warning.color, label: standards.warning.label, action: actions.warning };

    } else if (value >= standards.danger.min) {

      return { level: 'danger', color: standards.danger.color, label: standards.danger.label, action: actions.danger };

    }

  }

  

  // CPAã®åˆ¤å®š

  if (kpiType === 'CPA') {

    if (value <= standards.healthy.max) {

      return { level: 'healthy', color: standards.healthy.color, label: standards.healthy.label, action: actions.healthy };

    } else if (value >= standards.warning.min && value <= standards.warning.max) {

      return { level: 'warning', color: standards.warning.color, label: standards.warning.label, action: actions.warning };

    } else if (value >= standards.danger.min) {

      return { level: 'danger', color: standards.danger.color, label: standards.danger.label, action: actions.danger };

    }

  }

  

  return null;

}

/**

 * ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦KPIåŸºæº–ã«åŸºã¥ã„ã¦è‰²åˆ†ã‘ã¨æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º

 */

function analyzeData() {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const dataSheet = ss.getSheetByName('åºƒå‘Šãƒ‡ãƒ¼ã‚¿');

  

  if (!dataSheet || dataSheet.getLastRow() <= 1) {

    Logger.log('åˆ†æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

    return;

  }

  

  const lastRow = dataSheet.getLastRow();

  // ç”»åƒè¡¨ç¤ºåˆ—ãŒè¿½åŠ ã•ã‚ŒãŸãŸã‚ã€åˆ—æ•°ã¯SHEET_HEADER_TITLES.lengthã‚’ä½¿ç”¨
  const dataRange = dataSheet.getRange(2, 1, lastRow - 1, SHEET_HEADER_TITLES.length);

  const data = dataRange.getValues();

  

  const warnings = [];

  

  // åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆ0å§‹ã¾ã‚Š - SHEET_HEADER_TITLESã®é †åºã«å¯¾å¿œï¼‰

  const colContentTitle = 1;       // ãƒ†ã‚­ã‚¹ãƒˆ

  const colCTR = 6;                // CTR

  const colCPC = 4;                // CPC

  const colCPA = 9;                // CPA

  

  // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

  Logger.log(`=== ãƒ‡ãƒ¼ã‚¿åˆ†æé–‹å§‹ ===`);

  Logger.log(`å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ${data.length}`);

  Logger.log(`åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ - CTR:${colCTR}, CPC:${colCPC}, CPA:${colCPA}`);

  

  // å„è¡Œã‚’ãƒã‚§ãƒƒã‚¯

  for (let i = 0; i < data.length; i++) {

    const rowNum = i + 2; // å®Ÿéš›ã®è¡Œç•ªå·ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è€ƒæ…®ï¼‰

    const rowRange = dataSheet.getRange(rowNum, 1, 1, SHEET_HEADER_TITLES.length);
    rowRange.setBackground(null);

    const contentTitle = data[i][colContentTitle];  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒˆãƒ«

    

    // CTRã€CPCã€CPAã®å€¤ã‚’å–å¾—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¨˜å·ã‚„é€šè²¨è¨˜å·ã‚’é™¤å»ï¼‰

    const ctrValue = cleanNumericValue(data[i][colCTR]);

    const cpcValue = cleanNumericValue(data[i][colCPC]);

    const cpaValue = cleanNumericValue(data[i][colCPA]);

    

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆæœ€åˆã®3è¡Œã®ã¿ï¼‰

    if (i < 3) {

      Logger.log(`è¡Œ${rowNum}: ContentTitle=${contentTitle}`);

      Logger.log(`  CTRå…ƒãƒ‡ãƒ¼ã‚¿: "${data[i][colCTR]}" â†’ ${ctrValue}`);

      Logger.log(`  CPCå…ƒãƒ‡ãƒ¼ã‚¿: "${data[i][colCPC]}" â†’ ${cpcValue}`);

      Logger.log(`  CPAå…ƒãƒ‡ãƒ¼ã‚¿: "${data[i][colCPA]}" â†’ ${cpaValue}`);

    }

    

    let hasIssue = false;

    const issueDetails = [];

    const improvements = [];

    

    // CTRã®ãƒã‚§ãƒƒã‚¯ã¨è‰²åˆ†ã‘

    if (ctrValue !== null) {

      const ctrStatus = getKPIStatus('CTR', ctrValue);

      if (ctrStatus) {

        dataSheet.getRange(rowNum, colCTR + 1).setBackground(ctrStatus.color);

        

        // å¥åº·ä»¥å¤–ã®å ´åˆã¯ç™½æ–‡å­—ã«

        if (ctrStatus.level !== 'healthy') {

          dataSheet.getRange(rowNum, colCTR + 1).setFontColor('#000000');

          issueDetails.push(`CTR: ${ctrValue}% [${ctrStatus.label}]`);

          improvements.push(`ã€CTRã€‘${ctrStatus.action}`);

          hasIssue = true;

        } else {

          dataSheet.getRange(rowNum, colCTR + 1).setFontColor('#000000');

        }

      }

    }

    

    // CPCã®ãƒã‚§ãƒƒã‚¯ã¨è‰²åˆ†ã‘

    if (cpcValue !== null) {

      const cpcStatus = getKPIStatus('CPC', cpcValue);

      if (cpcStatus) {

        dataSheet.getRange(rowNum, colCPC + 1).setBackground(cpcStatus.color);

        

        if (cpcStatus.level !== 'healthy') {

          dataSheet.getRange(rowNum, colCPC + 1).setFontColor('#000000');

          issueDetails.push(`CPC: Â¥${cpcValue} [${cpcStatus.label}]`);

          improvements.push(`ã€CPCã€‘${cpcStatus.action}`);

          hasIssue = true;

        } else {

          dataSheet.getRange(rowNum, colCPC + 1).setFontColor('#000000');

        }

      }

    }

    

    // CPAã®ãƒã‚§ãƒƒã‚¯ã¨è‰²åˆ†ã‘

    if (cpaValue !== null) {

      const cpaStatus = getKPIStatus('CPA', cpaValue);

      if (cpaStatus) {

        dataSheet.getRange(rowNum, colCPA + 1).setBackground(cpaStatus.color);

        

        if (cpaStatus.level !== 'healthy') {

          dataSheet.getRange(rowNum, colCPA + 1).setFontColor('#000000');

          issueDetails.push(`CPA: Â¥${cpaValue} [${cpaStatus.label}]`);

          improvements.push(`ã€CPAã€‘${cpaStatus.action}`);

          hasIssue = true;

        } else {

          dataSheet.getRange(rowNum, colCPA + 1).setFontColor('#000000');

        }

      }

    }

    

    // è¦æ³¨æ„ãƒ»ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ãŒã‚ã‚‹å ´åˆã¯ãƒªã‚¹ãƒˆã«è¿½åŠ 

    if (hasIssue) {

      warnings.push({

        id: '',

        contentTitle: contentTitle,

        details: issueDetails,

        improvements: improvements

      });

    }

  }

  

  // Chatworkã«é€šçŸ¥

  if (warnings.length > 0) {

    sendChatworkNotification(warnings);

  } else {

    Logger.log('è­¦å‘Šå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

  }

  

  // åˆ†æçµæœã‚·ãƒ¼ãƒˆã‚’ä½œæˆ

  createSummarySheet(data);

  

  // KPIè¨ºæ–­ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ

  createKPIDiagnosisSheet(data);

}

/**

 * KPIè¨ºæ–­ã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆé‹ç”¨ãƒãƒ©ãƒ³ã‚¹è¨ºæ–­ï¼‰

 */

function createKPIDiagnosisSheet(data) {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let diagnosisSheet = ss.getSheetByName('KPIè¨ºæ–­');

  

  if (!diagnosisSheet) {

    diagnosisSheet = ss.insertSheet('KPIè¨ºæ–­');

  } else {

    diagnosisSheet.clear();

  }

  

  // åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  // æ³¨æ„: ç”»åƒè¡¨ç¤ºåˆ—ãŒè¿½åŠ ã•ã‚ŒãŸãŸã‚ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒ1ã¤ãšã¤ã‚·ãƒ•ãƒˆ

  const colCTR = 6;  // ç”»åƒè¡¨ç¤ºåˆ—è¿½åŠ ã«ã‚ˆã‚Š+1

  const colCPC = 4;  // ç”»åƒè¡¨ç¤ºåˆ—è¿½åŠ ã«ã‚ˆã‚Š+1

  const colCPA = 9;  // ç”»åƒè¡¨ç¤ºåˆ—è¿½åŠ ã«ã‚ˆã‚Š+1

  

  // å„KPIã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚«ã‚¦ãƒ³ãƒˆ

  const statusCount = {

    CTR: { healthy: 0, warning: 0, danger: 0 },

    CPC: { healthy: 0, warning: 0, danger: 0 },

    CPA: { healthy: 0, warning: 0, danger: 0 }

  };

  

  // å¹³å‡å€¤ã‚’è¨ˆç®—

  let ctrSum = 0, cpcSum = 0, cpaSum = 0;

  let ctrCount = 0, cpcCount = 0, cpaCount = 0;

  

  data.forEach(row => {

    const ctrValue = cleanNumericValue(row[colCTR]);

    const cpcValue = cleanNumericValue(row[colCPC]);

    const cpaValue = cleanNumericValue(row[colCPA]);

    

    // CTR

    if (ctrValue !== null) {

      const status = getKPIStatus('CTR', ctrValue);

      if (status) statusCount.CTR[status.level]++;

      ctrSum += ctrValue;

      ctrCount++;

    }

    

    // CPC

    if (cpcValue !== null) {

      const status = getKPIStatus('CPC', cpcValue);

      if (status) statusCount.CPC[status.level]++;

      cpcSum += cpcValue;

      cpcCount++;

    }

    

    // CPA

    if (cpaValue !== null) {

      const status = getKPIStatus('CPA', cpaValue);

      if (status) statusCount.CPA[status.level]++;

      cpaSum += cpaValue;

      cpaCount++;

    }

  });

  

  const avgCTR = ctrCount > 0 ? (ctrSum / ctrCount).toFixed(2) : 0;

  const avgCPC = cpcCount > 0 ? Math.round(cpcSum / cpcCount) : 0;

  const avgCPA = cpaCount > 0 ? Math.round(cpaSum / cpaCount) : 0;

  

  // å…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹åˆ¤å®š

  const overallCTRStatus = getKPIStatus('CTR', parseFloat(avgCTR));

  const overallCPCStatus = getKPIStatus('CPC', avgCPC);

  const overallCPAStatus = getKPIStatus('CPA', avgCPA);

  

  // ã‚¿ã‚¤ãƒˆãƒ«

  diagnosisSheet.appendRow(['ğŸ“Š é‹ç”¨ãƒãƒ©ãƒ³ã‚¹è¨ºæ–­']);

  diagnosisSheet.getRange(1, 1, 1, 5).merge().setBackground('#4A86E8').setFontColor('#FFFFFF').setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');

  

  // ç©ºè¡Œã‚’è¿½åŠ ï¼ˆç©ºé…åˆ—ã§ã¯ãªãç©ºæ–‡å­—åˆ—ã‚’å«ã‚€é…åˆ—ã‚’ä½¿ç”¨ï¼‰

  const lastRow = diagnosisSheet.getLastRow();

  diagnosisSheet.getRange(lastRow + 1, 1).setValue('');

  

  // ãƒ˜ãƒƒãƒ€ãƒ¼

  diagnosisSheet.appendRow(['KPI', 'å¹³å‡å€¤', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å¥åº·', 'è¦æ³¨æ„', 'ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³']);

  const headerRowNum = diagnosisSheet.getLastRow();

  const headerRange = diagnosisSheet.getRange(headerRowNum, 1, 1, 6);

  headerRange.setBackground('#4A86E8').setFontColor('#FFFFFF').setFontWeight('bold').setHorizontalAlignment('center');

  

  // CTR

  const ctrRow = ['CTR', `${avgCTR}%`, overallCTRStatus ? overallCTRStatus.label : '-', 

                  statusCount.CTR.healthy, statusCount.CTR.warning, statusCount.CTR.danger];

  // ctrRowãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª

  if (ctrRow && ctrRow.length > 0) {

    diagnosisSheet.appendRow(ctrRow);

    if (overallCTRStatus) {

      const ctrRowNum = diagnosisSheet.getLastRow();

      diagnosisSheet.getRange(ctrRowNum, 3).setBackground(overallCTRStatus.color).setFontWeight('bold');

    }

  }

  

  // CPC

  const cpcRow = ['CPC', `Â¥${avgCPC}`, overallCPCStatus ? overallCPCStatus.label : '-',

                  statusCount.CPC.healthy, statusCount.CPC.warning, statusCount.CPC.danger];

  // cpcRowãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª

  if (cpcRow && cpcRow.length > 0) {

    diagnosisSheet.appendRow(cpcRow);

    if (overallCPCStatus) {

      const cpcRowNum = diagnosisSheet.getLastRow();

      diagnosisSheet.getRange(cpcRowNum, 3).setBackground(overallCPCStatus.color).setFontWeight('bold');

    }

  }

  

  // CPA

  const cpaRow = ['CPA', `Â¥${avgCPA}`, overallCPAStatus ? overallCPAStatus.label : '-',

                  statusCount.CPA.healthy, statusCount.CPA.warning, statusCount.CPA.danger];

  // cpaRowãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª

  if (cpaRow && cpaRow.length > 0) {

    diagnosisSheet.appendRow(cpaRow);

    if (overallCPAStatus) {

      const cpaRowNum = diagnosisSheet.getLastRow();

      diagnosisSheet.getRange(cpaRowNum, 3).setBackground(overallCPAStatus.color).setFontWeight('bold');

    }

  }

  

  // ç©ºè¡Œã‚’è¿½åŠ ï¼ˆç©ºé…åˆ—ã§ã¯ãªãç©ºæ–‡å­—åˆ—ã‚’å«ã‚€é…åˆ—ã‚’ä½¿ç”¨ï¼‰

  const lastRowAfterCPA = diagnosisSheet.getLastRow();

  diagnosisSheet.getRange(lastRowAfterCPA + 1, 1).setValue('');

  

  // ç·åˆè¨ºæ–­

  diagnosisSheet.appendRow(['â–  ç·åˆè¨ºæ–­']);

  const diagnosisTitleRow = diagnosisSheet.getLastRow();

  diagnosisSheet.getRange(diagnosisTitleRow, 1).setFontWeight('bold').setFontSize(12);

  

  let overallMessage = '';

  const dangerCount = statusCount.CTR.danger + statusCount.CPC.danger + statusCount.CPA.danger;

  const warningCount = statusCount.CTR.warning + statusCount.CPC.warning + statusCount.CPA.warning;

  

  if (dangerCount > 0) {

    overallMessage = `âš ï¸ ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³åºƒå‘ŠãŒ${dangerCount}ä»¶ã‚ã‚Šã¾ã™ã€‚è‡³æ€¥ã€è¨´æ±‚ãƒ»ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ãƒ»LP ã®å…¨é¢è¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚`;

  } else if (warningCount > 0) {

    overallMessage = `âš  è¦æ³¨æ„åºƒå‘ŠãŒ${warningCount}ä»¶ã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã¨LP ã®æ”¹å–„ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`;

  } else {

    overallMessage = `âœ… å…¨ä½“çš„ã«å¥åº·ãªé‹ç”¨çŠ¶æ…‹ã§ã™ã€‚ç¾åœ¨ã®è¨´æ±‚è»¸ã‚’æ‹¡å¼µã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«é…ä¿¡ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚`;

  }

  

  // overallMessageãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª

  if (overallMessage && overallMessage.trim() !== '') {

    diagnosisSheet.appendRow([overallMessage]);

    const messageRow = diagnosisSheet.getLastRow();

    diagnosisSheet.getRange(messageRow, 1, 1, 6).merge().setWrap(true);

  }

  

  // ç©ºè¡Œã‚’è¿½åŠ ï¼ˆç©ºé…åˆ—ã§ã¯ãªãç©ºæ–‡å­—åˆ—ã‚’å«ã‚€é…åˆ—ã‚’ä½¿ç”¨ï¼‰

  const lastRowAfterMessage = diagnosisSheet.getLastRow();

  diagnosisSheet.getRange(lastRowAfterMessage + 1, 1).setValue('');

  

  // æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

  diagnosisSheet.appendRow(['ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³']);

  const actionTitleRow = diagnosisSheet.getLastRow();

  diagnosisSheet.getRange(actionTitleRow, 1).setFontWeight('bold').setFontSize(12);

  

  if (overallCTRStatus && overallCTRStatus.level !== 'healthy') {

    diagnosisSheet.appendRow([`ã€CTRã€‘${overallCTRStatus.action}`]);

  }

  if (overallCPCStatus && overallCPCStatus.level !== 'healthy') {

    diagnosisSheet.appendRow([`ã€CPCã€‘${overallCPCStatus.action}`]);

  }

  if (overallCPAStatus && overallCPAStatus.level !== 'healthy') {

    diagnosisSheet.appendRow([`ã€CPAã€‘${overallCPAStatus.action}`]);

  }

  

  // åˆ—å¹…ã‚’èª¿æ•´

  for (let i = 1; i <= 6; i++) {

    diagnosisSheet.autoResizeColumn(i);

  }

  

  Logger.log('KPIè¨ºæ–­ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');

}

/**

 * æ•°å€¤ã‹ã‚‰ä¸è¦ãªæ–‡å­—ã‚’é™¤å»ã—ã¦æ•°å€¤ã«å¤‰æ›

 * @param {string|number} value - å¤‰æ›ã™ã‚‹å€¤

 * @return {number|null} å¤‰æ›ã•ã‚ŒãŸæ•°å€¤ã€å¤‰æ›ã§ããªã„å ´åˆã¯null

 */

function cleanNumericValue(value) {

  if (value === null || value === undefined || value === '') {

    return null;

  }

  

  // æ—¢ã«æ•°å€¤ã®å ´åˆ

  if (typeof value === 'number') {

    return value;

  }

  

  // æ–‡å­—åˆ—ã®å ´åˆã€è¨˜å·ã‚’é™¤å»

  const cleaned = String(value)

    .replace(/[%$Â¥,å††]/g, '')  // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã€ãƒ‰ãƒ«è¨˜å·ã€å††è¨˜å·ã€ã‚«ãƒ³ãƒã‚’é™¤å»

    .trim();

  

  const num = parseFloat(cleaned);

  return isNaN(num) ? null : num;

}

/**

 * åˆ†æçµæœã®ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ

 */

function createSummarySheet(data) {

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let summarySheet = ss.getSheetByName('åˆ†æã‚µãƒãƒªãƒ¼');

  

  if (!summarySheet) {

    summarySheet = ss.insertSheet('åˆ†æã‚µãƒãƒªãƒ¼');

  } else {

    summarySheet.clear();

  }

  

  // ãƒ˜ãƒƒãƒ€ãƒ¼

  summarySheet.appendRow(['é …ç›®', 'å€¤']);

  summarySheet.getRange(1, 1, 1, 2).setBackground('#4A86E8').setFontColor('#FFFFFF').setFontWeight('bold');

  

  // åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆSHEET_HEADER_TITLESã®é †åºã«å¯¾å¿œï¼‰

  const colAmountSpent = 2;      // é…ä¿¡é‡‘é¡

  const colImpressions = 3;      // Imp

  const colClicks = 5;           // Clicks

  const colConversions = 7;      // CV

  

  // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—

  let totalClicks = 0;

  let totalImpressions = 0;

  let totalCost = 0;

  let totalConversions = 0;

  let validRows = 0;

  

  data.forEach(row => {

    const clicks = cleanNumericValue(row[colClicks]) || 0;

    const impressions = cleanNumericValue(row[colImpressions]) || 0;

    const cost = cleanNumericValue(row[colAmountSpent]) || 0;

    const conversions = cleanNumericValue(row[colConversions]) || 0;

    

    if (clicks > 0 || impressions > 0) {

      totalClicks += clicks;

      totalImpressions += impressions;

      totalCost += cost;

      totalConversions += conversions;

      validRows++;

    }

  });

  

  const avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions * 100).toFixed(2) : 0;

  const avgCPC = totalClicks > 0 ? (totalCost / totalClicks).toFixed(0) : 0;

  const avgCPA = totalConversions > 0 ? (totalCost / totalConversions).toFixed(0) : 0;

  

  summarySheet.appendRow(['ç·åºƒå‘Šæ•°', validRows]);

  summarySheet.appendRow(['ç·ã‚¯ãƒªãƒƒã‚¯æ•°', totalClicks.toLocaleString()]);

  summarySheet.appendRow(['ç·ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°', totalImpressions.toLocaleString()]);

  summarySheet.appendRow(['ç·ã‚³ã‚¹ãƒˆ', 'Â¥' + totalCost.toLocaleString()]);

  summarySheet.appendRow(['ç·ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•°', totalConversions.toLocaleString()]);

  summarySheet.appendRow(['å¹³å‡CTR', avgCTR + '%']);

  summarySheet.appendRow(['å¹³å‡CPC', 'Â¥' + Number(avgCPC).toLocaleString()]);

  summarySheet.appendRow(['å¹³å‡CPA', 'Â¥' + Number(avgCPA).toLocaleString()]);

  

  // åˆ—å¹…ã‚’èª¿æ•´

  summarySheet.autoResizeColumn(1);

  summarySheet.autoResizeColumn(2);

}

/**

 * Chatworkã«é€šçŸ¥ã‚’é€ä¿¡

 */

function sendChatworkNotification(warnings) {

  if (!CHATWORK_API_TOKEN || !CHATWORK_ROOM_ID) {

    Logger.log('Chatworkã®è¨­å®šãŒã•ã‚Œã¦ã„ã¾ã›ã‚“');

    return;

  }

  

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ

  let message = '[info][title]ğŸ“Š åºƒå‘ŠKPIè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ[/title]';

  message += 'è¦æ³¨æ„ãƒ»ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã®åºƒå‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\n';

  

  warnings.forEach((warning, index) => {

    const displayText = warning.id ? `ID: ${warning.id}` : (warning.contentTitle || '(ä¸æ˜)');

    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;

    message += `ã€${index + 1}ã€‘${displayText}\n`;

    if (warning.contentTitle && warning.id) {

      message += `ğŸ“ ${warning.contentTitle}\n`;

    }

    message += '\n';

    

    // KPIçŠ¶æ³

    message += `â–  KPIçŠ¶æ³\n`;

    warning.details.forEach(detail => {

      message += `  ${detail}\n`;

    });

    message += '\n';

    

    // æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

    if (warning.improvements && warning.improvements.length > 0) {

      message += `ğŸ’¡ æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n`;

      warning.improvements.forEach(improvement => {

        message += `  ${improvement}\n`;

      });

    }

    message += '\n';

  });

  

  message += `\nç¢ºèªæ—¥æ™‚: ${Utilities.formatDate(new Date(), 'JST', 'yyyy/MM/dd HH:mm:ss')}`;

  message += '[/info]';

  

  // Chatwork APIã‚’å‘¼ã³å‡ºã—

  const url = `https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`;

  const options = {

    'method': 'post',

    'headers': {

      'X-ChatWorkToken': CHATWORK_API_TOKEN

    },

    'payload': {

      'body': message

    }

  };

  

  try {

    UrlFetchApp.fetch(url, options);

    Logger.log('Chatworkã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ');

  } catch (error) {

    Logger.log('Chatworké€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—: ' + error.toString());

  }

}

/**

 * ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’é€ä¿¡

 */

function sendErrorNotification(error) {

  if (!CHATWORK_API_TOKEN || !CHATWORK_ROOM_ID) {

    return;

  }

  

  const message = `[info][title]åºƒå‘Šé‹ç”¨DXã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼[/title]ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.toString()}[/info]`;

  

  const url = `https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`;

  const options = {

    'method': 'post',

    'headers': {

      'X-ChatWorkToken': CHATWORK_API_TOKEN

    },

    'payload': {

      'body': message

    }

  };

  

  try {

    UrlFetchApp.fetch(url, options);

  } catch (e) {

    Logger.log('ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—: ' + e.toString());

  }

}

+
