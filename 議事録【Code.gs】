/**
 * è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ 
 * ä¼šç¤¾ã®Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰â˜…å°ãŒã¤ã„ãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æŠ½å‡ºã—ã€
 * MKã‚·ã‚¹ãƒ†ãƒ ã®è­°äº‹éŒ²ã«è‡ªå‹•ç™»éŒ²ã™ã‚‹
 */

/**
 * å–¶æ¥­æ—¥ãƒã‚§ãƒƒã‚¯ä»˜ããƒ¡ã‚¤ãƒ³å‡¦ç†
 */
function mainWithBusinessDayCheck() {
  const today = new Date();
  if (!isBusinessDay(today)) {
    Logger.log('æœ¬æ—¥ã¯å–¶æ¥­æ—¥ã§ã¯ãªã„ãŸã‚ã€å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    return;
  }
  
  main();
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¦ã‹ã‚‰MKã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²
 */
function main() {
  try {
    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
    const config = getConfig();
    
    // å¯¾è±¡æœŸé–“ï¼šå–¶æ¥­æ—¥ã‚’è€ƒæ…®ã—ãŸå‰å–¶æ¥­æ—¥ï¼ˆ00:00:00 ï½ 23:59:59ï¼‰
    const today = new Date();
    const targetDate = getPreviousBusinessDay(today);
    const startDate = new Date(targetDate);
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(startDate);
    endDate.setHours(23, 59, 59, 999);
    
    Logger.log(`å¯¾è±¡æœŸé–“: ${startDate.toLocaleString('ja-JP')} ï½ ${endDate.toLocaleString('ja-JP')}`);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const events = getCalendarEvents(startDate, endDate);
    
    // â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetEvents = filterMarketingEvents(events, config);
    
    Logger.log(`å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${targetEvents.length}`);
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
    const spreadsheet = getOrCreateSpreadsheet(config);
    const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰
    setupSheetHeaders(sheet);
    
    // ã™ã¹ã¦ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    const allMeetingData = [];
  for (const event of targetEvents) {
    const meetingData = extractMeetingData(event);
    if (!meetingData) {
      continue;
    }
    if (shouldSkipMeeting(meetingData, config)) {
      Logger.log(`æ‹…å½“è€…é™¤å¤–è¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName} - ${meetingData.date} æ‹…å½“è€…: ${meetingData.responsiblePersonEmail}`);
      continue;
    }
    allMeetingData.push(meetingData);
  }
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
    if (allMeetingData.length > 0) {
      writeToSpreadsheet(sheet, allMeetingData);
      Logger.log(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`);
      Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${spreadsheet.getUrl()}`);
    }
    
    synchronizeRegistrationStatus(sheet, config, spreadsheet);
    
    // MKã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²ï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ã¯å®Œäº†ã—ã¦ã„ã‚‹ï¼‰
    let mkSystemSuccessCount = 0;
    let mkSystemErrorCount = 0;
    
    if (allMeetingData.length > 0) {
      // MKã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
      if (config.MK_SYSTEM.API_ENDPOINT && 
          config.MK_SYSTEM.API_ENDPOINT !== 'https://mk-system.example.com/api/meetings') {
        Logger.log('MKã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™');
        for (const meetingData of allMeetingData) {
          try {
            const result = registerToMKSystem(meetingData, config.MK_SYSTEM);
            if (result && result.success) {
              mkSystemSuccessCount++;
            } else {
              mkSystemErrorCount++;
            }
          } catch (error) {
            mkSystemErrorCount++;
            Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ã¯ç¶šè¡Œã—ã¾ã™ï¼‰: ${meetingData.clientName} - ${error.toString()}`);
          }
        }
        Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²çµæœ: æˆåŠŸ ${mkSystemSuccessCount}ä»¶, å¤±æ•— ${mkSystemErrorCount}ä»¶`);
      } else {
        Logger.log('MKã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šãŒæœªè¨­å®šã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      }
    }
    
    Logger.log('å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
  } catch (error) {
    Logger.log(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.toString()}`);
    throw error;
  }
}

/**
 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ï¼ˆè¤‡æ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¯¾å¿œï¼‰
 * @param {Date} startDate - é–‹å§‹æ—¥æ™‚
 * @param {Date} endDate - çµ‚äº†æ—¥æ™‚
 * @return {Array} ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—
 */
function getCalendarEvents(startDate, endDate) {
  const config = getConfig();
  
  // è¨­å®šã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’å–å¾—
  const calendarIds = config.CALENDAR_ID;
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
  const calendarIdArray = Array.isArray(calendarIds) ? calendarIds : 
                          (calendarIds ? [calendarIds] : []);
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½¿ç”¨
  if (calendarIdArray.length === 0) {
    const defaultCalendar = CalendarApp.getDefaultCalendar();
    Logger.log(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½¿ç”¨: ${defaultCalendar.getName()}`);
    return defaultCalendar.getEvents(startDate, endDate);
  }
  
  Logger.log(`${calendarIdArray.length}ä»¶ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã™`);
  
  const allEvents = [];
  const eventIds = new Set(); // é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¿ã‘ã‚‹ãŸã‚ã®IDã‚»ãƒƒãƒˆ
  
  // å„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
  for (let i = 0; i < calendarIdArray.length; i++) {
    const calendarId = calendarIdArray[i];
    
    try {
      const calendar = CalendarApp.getCalendarById(calendarId);
      const calendarName = calendar.getName();
      Logger.log(`  ${i + 1}. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${calendarId}`);
      Logger.log(`     ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å: ${calendarName}`);
      
      const events = calendar.getEvents(startDate, endDate);
      Logger.log(`     â†’ ${events.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—`);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
      for (const event of events) {
        // ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä½¿ã£ã¦é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
        const eventId = event.getId();
        if (!eventIds.has(eventId)) {
          eventIds.add(eventId);
          allEvents.push(event);
        }
      }
    } catch (error) {
      Logger.log(`  ${i + 1}. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${calendarId}`);
      Logger.log(`     â†’ ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
      Logger.log(`     â†’ ã“ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ä»–ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç¶šè¡Œ
    }
  }
  
  Logger.log(`åˆè¨ˆ ${allEvents.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆé‡è¤‡é™¤å¤–æ¸ˆã¿ï¼‰`);
  return allEvents;
}

/**
 * â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
 * @param {Array} events - ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—
 * @param {Array} marketingTeam - ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ—
 * @return {Array} ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—
 */
function filterMarketingEvents(events, config) {
  // ã¾ãšã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  Logger.log(`å–å¾—ã—ãŸå…¨ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§:`);
  events.forEach((event, index) => {
    const title = event.getTitle();
    const description = event.getDescription() || '';
    Logger.log(`  ${index + 1}. ã‚¿ã‚¤ãƒˆãƒ«: "${title}"`);
    Logger.log(`     èª¬æ˜: "${description.substring(0, 50)}${description.length > 50 ? '...' : ''}"`);
    Logger.log(`     é–‹å§‹æ™‚åˆ»: ${event.getStartTime()}`);
  });
  
  // ã¾ãšâ˜…å°ãŒã¤ã„ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®å…ˆé ­ã«â˜…ã‚„â˜†ãŒã‚ã‚‹ã‚‚ã®ã®ã¿ï¼‰
  const starEvents = events.filter(event => {
    const title = event.getTitle();
    const description = event.getDescription() || '';
    
    // ğŸ’¬ãŒã¤ã„ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯é™¤å¤–ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§æ¤œå‡ºï¼‰
    const hasChatIcon = title.includes('ğŸ’¬') || 
                       title.includes('\uD83D\uDCAC') ||
                       (title.length >= 2 && title.charCodeAt(0) === 0xD83D && title.charCodeAt(1) === 0xDCAC);
    if (hasChatIcon) {
      Logger.log(`ğŸ’¬ãŒã¤ã„ã¦ã„ã‚‹ãŸã‚é™¤å¤–: "${title}"`);
      return false;
    }
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã®å…ˆé ­ã«â˜…ã‚„â˜†ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå³å¯†ã«ï¼‰
    const trimmedTitle = title.trim();
    const startsWithStar = trimmedTitle.startsWith('â˜…') || trimmedTitle.startsWith('â˜†');
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã®å…ˆé ­ã«â˜…ã‚„â˜†ãŒã‚ã‚‹ã‚‚ã®ã®ã¿ã‚’æŠ½å‡ºï¼ˆèª¬æ˜ã«å«ã¾ã‚Œã¦ã„ã‚‹ã ã‘ã§ã¯æŠ½å‡ºã—ãªã„ï¼‰
    const hasStar = startsWithStar;
    
    if (hasStar) {
      Logger.log(`â˜…å°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¦‹: "${title}" (${event.getStartTime()})`);
    } else {
      // â˜…ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã‚‚ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      Logger.log(`â˜…å°ãªã—: "${title}"`);
    }
    
    return hasStar;
  });
  
  Logger.log(`â˜…å°ãŒã¤ã„ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ: ${starEvents.length}ä»¶`);
  
  // â˜…å°ãŒã¤ã„ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  return starEvents.filter(event => {
    // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const attendees = event.getGuestList().map(guest => guest.getEmail());
    const organizers = event.getCreators(); // ä½œæˆè€…
    
    const allParticipants = [...organizers, ...attendees];
    
    // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒ1äººä»¥ä¸Šå‚åŠ ã—ã¦ã„ã‚‹ã‹
    const hasMarketingMember = allParticipants.some(participant => 
      isTeamMemberEmail(participant, config)
    );
    
    if (hasMarketingMember) {
      Logger.log(`ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ : ${event.getTitle()}`);
    }
    
    return hasMarketingMember;
  });
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
 * @param {CalendarEvent} event - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
 * @return {Object} ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function extractMeetingData(event) {
  let title = event.getTitle().replace('â˜…', '').trim(); // â˜…ã‚’é™¤å»
  title = removeEmojisAndIcons(title); // çµµæ–‡å­—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ã‚’é™¤å»
  
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã€ã¾ãŸã¯èª¬æ˜ã‹ã‚‰ï¼‰
  // ä¾‹: ã€Œâ˜…ABCæ ªå¼ä¼šç¤¾ã¨ã®æ‰“ã¡åˆã‚ã›ã€â†’ã€ŒABCæ ªå¼ä¼šç¤¾ã€
  const clientName = extractClientName(title, event.getDescription());
  
  // æ‹…å½“è€…ã‚’æ±ºå®šï¼ˆâ˜…ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã¦ç™»éŒ²ã—ã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã®ä¸­ã§ä¸€ç•ªä¸Šã«è¨˜è¼‰ãŒã‚ã‚‹æ–¹ï¼‰
  const config = getConfig();
  const responsiblePerson = getResponsiblePerson(event, config);
  
  // ã™ã¹ã¦ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨å‚åŠ è€…ã‚’å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
  const marketingAttendees = getAllMarketingAttendees(event, config);
  const marketingAttendeeNames = marketingAttendees.map(email => {
    return config.EMAIL_TO_NAME[email] || email;
  });
  
  // ã™ã¹ã¦ã®å‚åŠ è€…ã‚’å–å¾—ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ï¼‰
  const allAttendees = event.getGuestList().map(guest => guest.getEmail());
  
  return {
    date: Utilities.formatDate(event.getStartTime(), Session.getScriptTimeZone(), 'yyyy-MM-dd'),
    startTime: Utilities.formatDate(event.getStartTime(), Session.getScriptTimeZone(), 'HH:mm'),
    endTime: Utilities.formatDate(event.getEndTime(), Session.getScriptTimeZone(), 'HH:mm'),
    title: title,
    clientName: clientName,
    responsiblePerson: responsiblePerson.name, // æ‹…å½“è€…ï¼ˆæœ€åˆã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
    responsiblePersonEmail: responsiblePerson.email,
    marketingAttendees: marketingAttendeeNames.join(', '), // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨å‚åŠ è€…ä¸€è¦§
    attendees: allAttendees.join(', '), // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿
    description: event.getDescription() || '',
    location: event.getLocation() || ''
  };
}

/**
 * æ‹…å½“è€…ã‚’æ±ºå®šï¼ˆâ˜…ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã¦ç™»éŒ²ã—ã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã®ä¸­ã§ä¸€ç•ªä¸Šã«è¨˜è¼‰ãŒã‚ã‚‹æ–¹ï¼‰
 * @param {CalendarEvent} event - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Object} {name: æ‹…å½“è€…å, email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹}
 */
function getResponsiblePerson(event, config) {
  const creators = event.getCreators();
  const guestEmails = event.getGuestList().map(guest => guest.getEmail());
  
  const employeeCreator = findFirstMatch(creators, email => isEmployeeEmail(email, config));
  if (employeeCreator && !isExcludedResponsibleEmail(employeeCreator, config)) {
    return {
      name: config.EMAIL_TO_NAME[employeeCreator] || employeeCreator,
      email: employeeCreator
    };
  }
  
  const employeeGuest = findFirstMatch(guestEmails, email => isEmployeeEmail(email, config));
  if (employeeGuest && !isExcludedResponsibleEmail(employeeGuest, config)) {
    return {
      name: config.EMAIL_TO_NAME[employeeGuest] || employeeGuest,
      email: employeeGuest
    };
  }
  
  const teamMember = findFirstMatch([...creators, ...guestEmails], email => isTeamMemberEmail(email, config));
  if (teamMember && !isExcludedResponsibleEmail(teamMember, config)) {
    const fallbackEmployee = findFirstMatch(config.MARKETING_TEAM || [], email => !isExcludedResponsibleEmail(email, config));
    return {
      name: fallbackEmployee ? (config.EMAIL_TO_NAME[fallbackEmployee] || fallbackEmployee) : (config.EMAIL_TO_NAME[teamMember] || teamMember),
      email: fallbackEmployee || teamMember
    };
  }
  
  Logger.log(`è­¦å‘Š: ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™: ${event.getTitle()}`);
  const defaultMember = findFirstMatch(config.MARKETING_TEAM || [], email => !isExcludedResponsibleEmail(email, config)) ||
                        findFirstMatch(getAllTeamMembers(config), email => !isExcludedResponsibleEmail(email, config)) ||
                        'unknown@mirai-kirei.jp';
  return {
    name: config.EMAIL_TO_NAME[defaultMember] || defaultMember,
    email: defaultMember
  };
}

/**
 * ã™ã¹ã¦ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨å‚åŠ è€…ã‚’å–å¾—
 * @param {CalendarEvent} event - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Array} ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ—
 */
function getAllMarketingAttendees(event, config) {
  const marketingAttendees = [];
  const addEmailIfNeeded = (email) => {
    if (!email) {
      return;
    }
    if (isTeamMemberEmail(email, config) && !containsEmail(marketingAttendees, email)) {
      marketingAttendees.push(email);
    }
  };
  
  const creators = event.getCreators();
  creators.forEach(addEmailIfNeeded);
  
  const guests = event.getGuestList();
  guests.forEach(guest => addEmailIfNeeded(guest.getEmail()));
  
  return marketingAttendees;
}

/**
 * ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯èª¬æ˜ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’æŠ½å‡º
 * @param {String} title - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«
 * @param {String} description - ã‚¤ãƒ™ãƒ³ãƒˆèª¬æ˜
 * @return {String} ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
 */
function extractClientName(title, description) {
  // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œâ˜…ABCæ ªå¼ä¼šç¤¾ã¨ã®æ‰“ã¡åˆã‚ã›ã€â†’ã€ŒABCæ ªå¼ä¼šç¤¾ã€
  // ãƒ‘ã‚¿ãƒ¼ãƒ³2: èª¬æ˜ã«ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ABCæ ªå¼ä¼šç¤¾ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹
  
  // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰æŠ½å‡ºã‚’è©¦ã¿ã‚‹
  const titlePatterns = [
    /^â˜…?(.+?)(ã¨ã®|ã¨ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°|ã¨ã®æ‰“ã¡åˆã‚ã›|ã¨|ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°|æ‰“ã¡åˆã‚ã›)/,
    /^â˜…?(.+?)$/
  ];
  
  for (const pattern of titlePatterns) {
    const match = title.match(pattern);
    if (match && match[1]) {
      return match[1].trim();
    }
  }
  
  // èª¬æ˜ã‹ã‚‰æŠ½å‡ºã‚’è©¦ã¿ã‚‹
  if (description) {
    const descPatterns = [
      /ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ[ï¼š:]\s*(.+?)(\n|$)/,
      /é¡§å®¢[ï¼š:]\s*(.+?)(\n|$)/,
      /Client[ï¼š:]\s*(.+?)(\n|$)/
    ];
    
    for (const pattern of descPatterns) {
      const match = description.match(pattern);
      if (match && match[1]) {
        return match[1].trim();
      }
    }
  }
  
  // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆå¿µã®ãŸã‚å†åº¦ğŸ’¬ã‚’é™¤å»ï¼‰
  return removeEmojisAndIcons(title);
}

/**
 * ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰çµµæ–‡å­—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ç‰¹æ®Šæ–‡å­—ã‚’é™¤å»
 * @param {String} text - å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ
 * @return {String} ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
 */
function removeEmojisAndIcons(text) {
  if (!text) return text;
  
  let cleaned = text;
  
  // ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’æ˜ç¤ºçš„ã«é™¤å»ï¼ˆæœ€å„ªå…ˆãƒ»è¤‡æ•°ã®æ–¹æ³•ã§ç¢ºå®Ÿã«é™¤å»ï¼‰
  // æ–¹æ³•1: ç›´æ¥æ–‡å­—åˆ—ã¨ã—ã¦é™¤å»
  cleaned = cleaned.replace(/ğŸ’¬/g, '');
  // æ–¹æ³•2: Unicodeã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆES6å½¢å¼ï¼‰
  cleaned = cleaned.replace(/\u{1F4AC}/gu, '');
  // æ–¹æ³•3: ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢è¡¨ç¾ï¼ˆES5äº’æ›ï¼‰
  cleaned = cleaned.replace(/\uD83D\uDCAC/g, '');
  // æ–¹æ³•4: æ–‡å­—åˆ—ã‚’1æ–‡å­—ãšã¤ãƒã‚§ãƒƒã‚¯ã—ã¦é™¤å»ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
  let result = '';
  for (let i = 0; i < cleaned.length; i++) {
    const char = cleaned[i];
    const charCode = cleaned.charCodeAt(i);
    // ğŸ’¬ã®ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ï¼ˆ\uD83D\uDCACï¼‰ã‚’æ¤œå‡º
    if (charCode === 0xD83D && i + 1 < cleaned.length && cleaned.charCodeAt(i + 1) === 0xDCAC) {
      i++; // æ¬¡ã®æ–‡å­—ã‚‚ã‚¹ã‚­ãƒƒãƒ—
      continue;
    }
    // ğŸ’¬ã®æ–‡å­—åˆ—ã¨ã—ã¦æ¤œå‡º
    if (char === 'ğŸ’¬') {
      continue;
    }
    result += char;
  }
  cleaned = result;
  
  // çµµæ–‡å­—ã®Unicodeç¯„å›²ã‚’é™¤å»ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ã«ï¼‰
  // åŸºæœ¬çš„ãªçµµæ–‡å­—ç¯„å›²
  cleaned = cleaned.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
  // è¿½åŠ ã®çµµæ–‡å­—ç¯„å›²
  cleaned = cleaned.replace(/[\u{2600}-\u{26FF}]/gu, '');
  cleaned = cleaned.replace(/[\u{2700}-\u{27BF}]/gu, '');
  // é¡”æ–‡å­—ãƒ»æ„Ÿæƒ…è¡¨ç¾
  cleaned = cleaned.replace(/[\u{1F600}-\u{1F64F}]/gu, '');
  // è¿½åŠ ã®çµµæ–‡å­—ç¯„å›²
  cleaned = cleaned.replace(/[\u{1F900}-\u{1F9FF}]/gu, '');
  cleaned = cleaned.replace(/[\u{1FA00}-\u{1FA6F}]/gu, '');
  // è¨˜å·ãƒ»è¨˜å·ãƒ»çµµæ–‡å­—ï¼ˆMiscellaneous Symbols and Pictographsï¼‰
  cleaned = cleaned.replace(/[\u{1F300}-\u{1F5FF}]/gu, '');
  // è¿½åŠ ã®è¨˜å·ãƒ»çµµæ–‡å­—
  cleaned = cleaned.replace(/[\u{1F680}-\u{1F6FF}]/gu, '');
  // è£œåŠ©çµµæ–‡å­—
  cleaned = cleaned.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '');
  
  // çµµæ–‡å­—ä¿®é£¾å­ã‚„çµåˆæ–‡å­—ã‚’é™¤å»
  cleaned = cleaned.replace(/[\u{FE00}-\u{FE0F}]/gu, '');
  cleaned = cleaned.replace(/[\u{200D}]/gu, '');
  cleaned = cleaned.replace(/[\u{20E3}]/gu, ''); // çµåˆæ–‡å­—ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰
  
  // ãã®ä»–ã®ç‰¹æ®Šè¨˜å·ã‚’æ˜ç¤ºçš„ã«é™¤å»
  cleaned = cleaned.replace(/[\u{1F4E6}]/gu, ''); // ğŸ“¦
  cleaned = cleaned.replace(/[\u{1F4E7}]/gu, ''); // ğŸ“§
  cleaned = cleaned.replace(/[\u{1F4E8}]/gu, ''); // ğŸ“¨
  cleaned = cleaned.replace(/[\u{1F4E9}]/gu, ''); // ğŸ“©
  
  // ã™ã¹ã¦ã®çµµæ–‡å­—ã‚’é™¤å»ã™ã‚‹åŒ…æ‹¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
  // ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã‚’å«ã‚€çµµæ–‡å­—ã‚’é™¤å»ï¼ˆğŸ’¬ã‚’å«ã‚€ç¯„å›²ã‚’æ˜ç¤ºçš„ã«å«ã‚ã‚‹ï¼‰
  cleaned = cleaned.replace(/[\uD83C][\uDF00-\uDFFF]|[\uD83D][\uDC00-\uDE4F]|[\uD83D][\uDE80-\uDEFF]|[\u2600-\u26FF]|[\u2700-\u27BF]/g, '');
  // ğŸ’¬ã®ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã‚’å†åº¦æ˜ç¤ºçš„ã«é™¤å»ï¼ˆå¿µã®ãŸã‚ï¼‰
  cleaned = cleaned.replace(/\uD83D\uDCAC/g, '');
  
  // ğŸ’¬ã§å§‹ã¾ã‚‹å ´åˆã€å…ˆé ­ã‹ã‚‰é™¤å»ï¼ˆå¿µã®ãŸã‚å†åº¦å®Ÿè¡Œï¼‰
  if (cleaned.charCodeAt(0) === 0xD83D && cleaned.charCodeAt(1) === 0xDCAC) {
    cleaned = cleaned.substring(2);
  }
  // æ–‡å­—åˆ—ã¨ã—ã¦ã‚‚å†åº¦ãƒã‚§ãƒƒã‚¯
  if (cleaned.indexOf('ğŸ’¬') === 0) {
    cleaned = cleaned.substring(1);
  }
  
  // é€£ç¶šã™ã‚‹ç©ºç™½ã‚’1ã¤ã«çµ±ä¸€
  cleaned = cleaned.replace(/\s+/g, ' ').trim();
  
  return cleaned;
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Spreadsheet} ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function getOrCreateSpreadsheet(config) {
  if (config.SPREADSHEET_ID) {
    try {
      return SpreadsheetApp.openById(config.SPREADSHEET_ID);
    } catch (error) {
      Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™: ${error.toString()}`);
    }
  }
  
  // æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
  const spreadsheet = SpreadsheetApp.create(config.SPREADSHEET_NAME);
  Logger.log(`æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: ${spreadsheet.getId()}`);
  Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${spreadsheet.getUrl()}`);
  
  // Config.gsã®SPREADSHEET_IDã‚’æ›´æ–°ã™ã‚‹å ´åˆã®ã‚³ãƒ¡ãƒ³ãƒˆ
  // Logger.log(`æ¬¡å›ã‹ã‚‰ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Config.gsã®SPREADSHEET_IDã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„: ${spreadsheet.getId()}`);
  
  return spreadsheet;
}

/**
 * ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
 * @param {Spreadsheet} spreadsheet - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {String} sheetName - ã‚·ãƒ¼ãƒˆå
 * @return {Sheet} ã‚·ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function getOrCreateSheet(spreadsheet, sheetName) {
  let sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
    sheet = spreadsheet.insertSheet(sheetName);
    Logger.log(`æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: ${sheetName}`);
  }
  return sheet;
}

/**
 * ã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®š
 * @param {Sheet} sheet - ã‚·ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function setupSheetHeaders(sheet) {
  const config = getConfig();
  const statusHeader = config.REGISTRATION_STATUS_HEADER || 'MKç™»éŒ²çŠ¶æ³';
  const emailHeader = config.RESPONSIBLE_EMAIL_HEADER || 'æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹';
  const participantHeader = config.PARTICIPANT_HEADER || 'å‚åŠ è€…';
  const locationHeader = config.LOCATION_HEADER || 'å ´æ‰€';
  const baseHeaders = [
    'æ—¥ä»˜',
    'é–‹å§‹æ™‚åˆ»',
    'çµ‚äº†æ™‚åˆ»',
    'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå',
    'æ‹…å½“è€…',
    emailHeader,
    participantHeader,
    locationHeader,
    statusHeader
  ];
  
  const headerRange = sheet.getRange(1, 1, 1, baseHeaders.length);
  let headers = headerRange.getValues()[0];
  const isInitialized = headers[0] !== '';
  
  if (!isInitialized) {
    headerRange.setValues([baseHeaders]);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('#ffffff');
    Logger.log('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®šã—ã¾ã—ãŸ');
  } else {
    // æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«åˆ—ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°è¿½åŠ 
    if (headers.indexOf(emailHeader) === -1) {
      const responsibleIndex = headers.indexOf('æ‹…å½“è€…');
      if (responsibleIndex !== -1) {
        sheet.insertColumnAfter(responsibleIndex + 1);
        const emailCell = sheet.getRange(1, responsibleIndex + 2);
        emailCell.setValue(emailHeader);
        emailCell.setFontWeight('bold');
        emailCell.setBackground('#4285f4');
        emailCell.setFontColor('#ffffff');
        Logger.log(`ãƒ˜ãƒƒãƒ€ãƒ¼ã«${emailHeader}åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      }
    }
    
    headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // å‚åŠ è€…åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°ã¾ãŸã¯è¿½åŠ 
    if (headers.indexOf(participantHeader) === -1) {
      const oldParticipantIndex = headers.indexOf('ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨å‚åŠ è€…');
      if (oldParticipantIndex !== -1) {
        const participantCell = sheet.getRange(1, oldParticipantIndex + 1);
        participantCell.setValue(participantHeader);
        participantCell.setFontWeight('bold');
        participantCell.setBackground('#4285f4');
        participantCell.setFontColor('#ffffff');
        Logger.log(`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’${participantHeader}ã¸æ›´æ–°ã—ã¾ã—ãŸ`);
      } else {
        const emailIndex = headers.indexOf(emailHeader);
        const insertColumn = emailIndex !== -1 ? (emailIndex + 1) : sheet.getLastColumn();
        sheet.insertColumnAfter(insertColumn);
        const participantCell = sheet.getRange(1, insertColumn + 1);
        participantCell.setValue(participantHeader);
        participantCell.setFontWeight('bold');
        participantCell.setBackground('#4285f4');
        participantCell.setFontColor('#ffffff');
        Logger.log(`ãƒ˜ãƒƒãƒ€ãƒ¼ã«${participantHeader}åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      }
    }
    
    headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // å ´æ‰€åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
    const locationIndex = headers.indexOf(locationHeader);
    if (locationIndex === -1) {
      const oldNoteIndex = headers.indexOf('å‚™è€ƒ');
      if (oldNoteIndex !== -1) {
        const locationCell = sheet.getRange(1, oldNoteIndex + 1);
        locationCell.setValue(locationHeader);
        locationCell.setFontWeight('bold');
        locationCell.setBackground('#4285f4');
        locationCell.setFontColor('#ffffff');
        Logger.log(`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’${locationHeader}ã¸æ›´æ–°ã—ã¾ã—ãŸ`);
      } else {
        const insertPosition = headers.indexOf(participantHeader);
        const targetColumn = insertPosition !== -1 ? insertPosition + 1 : sheet.getLastColumn();
        sheet.insertColumnAfter(targetColumn);
        const locationCell = sheet.getRange(1, targetColumn + 1);
        locationCell.setValue(locationHeader);
        locationCell.setFontWeight('bold');
        locationCell.setBackground('#4285f4');
        locationCell.setFontColor('#ffffff');
        Logger.log(`ãƒ˜ãƒƒãƒ€ãƒ¼ã«${locationHeader}åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      }
    }
    
    headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    if (headers.indexOf(statusHeader) === -1) {
      const statusColumnIndex = sheet.getLastColumn() + 1;
      sheet.insertColumnAfter(sheet.getLastColumn());
      const statusCell = sheet.getRange(1, statusColumnIndex);
      statusCell.setValue(statusHeader);
      statusCell.setFontWeight('bold');
      statusCell.setBackground('#4285f4');
      statusCell.setFontColor('#ffffff');
      Logger.log(`ãƒ˜ãƒƒãƒ€ãƒ¼ã«${statusHeader}åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }
  }
  
  // åˆ—å¹…ã‚’æŒ‡å®š
  const columnWidths = [100, 100, 100, 280, 100, 260, 400, 350, 120]; // Aåˆ—ã‹ã‚‰Iåˆ—
  for (let i = 0; i < columnWidths.length; i++) {
    sheet.setColumnWidth(i + 1, columnWidths[i]);
  }
  
  backfillResponsibleEmails(sheet, config);
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
 * @param {Sheet} sheet - ã‚·ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {Array} meetingDataList - ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—
 */
function writeToSpreadsheet(sheet, meetingDataList) {
  if (meetingDataList.length === 0) {
    return;
  }
  
  // æ—¥ä»˜é †ï¼ˆå¤ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
  const sortedDataList = [...meetingDataList].sort((a, b) => {
    // æ—¥ä»˜ã§æ¯”è¼ƒ
    const dateA = new Date(a.date + ' ' + a.startTime);
    const dateB = new Date(b.date + ' ' + b.startTime);
    return dateA - dateB; // å¤ã„é †ï¼ˆæ˜‡é †ï¼‰
  });
  
  // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦é‡è¤‡ã‚’é¿ã‘ã‚‹
  const lastRow = sheet.getLastRow();
  let existingData = [];
  if (lastRow > 1) {
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ã„ãŸæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ—¥ä»˜ã€é–‹å§‹æ™‚åˆ»ã€çµ‚äº†æ™‚åˆ»ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã€æ‹…å½“è€…ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
    // 5åˆ—: æ—¥ä»˜ã€é–‹å§‹æ™‚åˆ»ã€çµ‚äº†æ™‚åˆ»ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã€æ‹…å½“è€…
    const dataRange = sheet.getRange(2, 1, lastRow - 1, 5);
    existingData = dataRange.getValues();
  }
  
  // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆé‡è¤‡ã‚’é™¤å¤–ï¼‰
  const newDataList = sortedDataList.filter(meetingData => {
    // åŒã˜æ—¥ä»˜ã€é–‹å§‹æ™‚åˆ»ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã€æ‹…å½“è€…ã®çµ„ã¿åˆã‚ã›ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    // ã‚ˆã‚Šå³å¯†ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã€æ™‚åˆ»ã®æ¯”è¼ƒã‚‚æ”¹å–„
    const isDuplicate = existingData.some(row => {
      const existingDate = Utilities.formatDate(row[0], Session.getScriptTimeZone(), 'yyyy-MM-dd');
      const existingStartTime = row[1] ? row[1].toString().trim() : '';
      const existingEndTime = row[2] ? row[2].toString().trim() : '';
      const existingClientName = row[3] ? row[3].toString().trim() : '';
      const existingResponsible = row[4] ? row[4].toString().trim() : ''; // æ‹…å½“è€…ã¯4åˆ—ç›®
      
      // æ—¥ä»˜ã€é–‹å§‹æ™‚åˆ»ã€çµ‚äº†æ™‚åˆ»ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã€æ‹…å½“è€…ãŒã™ã¹ã¦ä¸€è‡´ã™ã‚‹å ´åˆã«é‡è¤‡ã¨ã¿ãªã™
      return existingDate === meetingData.date &&
             existingStartTime === meetingData.startTime.trim() &&
             existingEndTime === meetingData.endTime.trim() &&
             existingClientName === meetingData.clientName.trim() &&
             existingResponsible === meetingData.responsiblePerson.trim();
    });
    
    if (isDuplicate) {
      Logger.log(`é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.date} ${meetingData.startTime} - ${meetingData.clientName} (${meetingData.responsiblePerson})`);
    }
    
    return !isDuplicate;
  });
  
  if (newDataList.length === 0) {
    Logger.log('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å­˜åœ¨ã—ã¾ã™');
    return;
  }
  
  // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®æœ€å¾Œã®è¡Œã‚’å–å¾—
  const startRow = lastRow + 1;
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’2æ¬¡å…ƒé…åˆ—ã«å¤‰æ›
  const values = newDataList.map(meetingData => [
    meetingData.date,
    meetingData.startTime,
    meetingData.endTime,
    meetingData.clientName,
    meetingData.responsiblePerson,
    meetingData.responsiblePersonEmail || '',
    meetingData.marketingAttendees,
    meetingData.location || '',
    ''
  ]);
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
  const range = sheet.getRange(startRow, 1, values.length, values[0].length);
  range.setValues(values);
  
  // æ—¥ä»˜åˆ—ã®æ›¸å¼è¨­å®š
  const dateColumn = 1;
  const dateRange = sheet.getRange(startRow, dateColumn, values.length, 1);
  dateRange.setNumberFormat('yyyy-mm-dd');
  
  Logger.log(`${values.length}è¡Œã®æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ã¾ã—ãŸï¼ˆ${meetingDataList.length - values.length}ä»¶ã¯é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰`);
}

/**
 * æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«åˆ—ã‚’æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦è£œå®Œ
 * @param {Sheet} sheet - è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function backfillResponsibleEmails(sheet, config) {
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) {
    return;
  }
  
  const headerRow = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const nameIndex = headerRow.indexOf('æ‹…å½“è€…');
  const emailHeader = config.RESPONSIBLE_EMAIL_HEADER || 'æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹';
  const emailIndex = headerRow.indexOf(emailHeader);
  
  if (nameIndex === -1 || emailIndex === -1) {
    return;
  }
  
  const nameRange = sheet.getRange(2, nameIndex + 1, lastRow - 1, 1).getValues();
  const emailRange = sheet.getRange(2, emailIndex + 1, lastRow - 1, 1);
  const emailValues = emailRange.getValues();
  const nameToEmail = getNameToEmailMap(config);
  let needsUpdate = false;
  
  for (let i = 0; i < nameRange.length; i++) {
    if (emailValues[i][0]) {
      continue;
    }
    
    const nameValue = nameRange[i][0] ? nameRange[i][0].toString().trim() : '';
    if (nameValue === '') {
      continue;
    }
    
    if (nameValue.includes('@')) {
      emailValues[i][0] = nameValue;
      needsUpdate = true;
      continue;
    }
    
    const email = nameToEmail[nameValue];
    if (email) {
      emailValues[i][0] = email;
      needsUpdate = true;
    }
  }
  
  if (needsUpdate) {
    emailRange.setValues(emailValues);
    Logger.log('æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«åˆ—ã‚’æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦è£œå®Œã—ã¾ã—ãŸ');
  }
}

/**
 * æ‹…å½“è€…åã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¼•ããƒãƒƒãƒ—ã‚’ç”Ÿæˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Object} åå‰â†’ãƒ¡ãƒ¼ãƒ«ã®ãƒãƒƒãƒ—
 */
function getNameToEmailMap(config) {
  const map = {};
  const emailToName = config.EMAIL_TO_NAME || {};
  for (const email in emailToName) {
    if (!emailToName.hasOwnProperty(email)) {
      continue;
    }
    const name = emailToName[email];
    if (name && !map[name]) {
      map[name] = email;
    }
  }
  return map;
}

/**
 * è¨­å®šã«ã‚ˆã‚Šç™»éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹
 * @param {Object} meetingData - æŠ½å‡ºæ¸ˆã¿ä¼šè­°ãƒ‡ãƒ¼ã‚¿
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Boolean}
 */
function shouldSkipMeeting(meetingData, config) {
  if (!meetingData) {
    return true;
  }
  
  if (isExcludedResponsibleEmail(meetingData.responsiblePersonEmail, config)) {
    Logger.log(`æ‹…å½“è€…é™¤å¤–ã«ã‚ˆã‚Šã‚¹ã‚­ãƒƒãƒ—: ${meetingData.title || meetingData.clientName}`);
    return true;
  }
  
  if (isExcludedTitle(meetingData.title || meetingData.clientName || '', config)) {
    Logger.log(`ã‚¿ã‚¤ãƒˆãƒ«é™¤å¤–ã«ã‚ˆã‚Šã‚¹ã‚­ãƒƒãƒ—: ${meetingData.title || meetingData.clientName}`);
    return true;
  }
  
  return false;
}

/**
 * ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆç¤¾å“¡+ãƒ‘ãƒ¼ãƒˆï¼‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§ã‚’å–å¾—
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Array} ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ—
 */
function getAllTeamMembers(config) {
  const marketingTeam = config.MARKETING_TEAM || [];
  const partTimerTeam = config.PART_TIMER_TEAM || [];
  const merged = [...marketingTeam, ...partTimerTeam];
  const unique = [];
  merged.forEach(email => {
    if (email && !containsEmail(unique, email)) {
      unique.push(email);
    }
  });
  return unique;
}

/**
 * ãƒ¡ãƒ¼ãƒ«ãŒç¤¾å“¡ã‹ã©ã†ã‹ã‚’åˆ¤å®š
 * @param {String} email - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Boolean}
 */
function isEmployeeEmail(email, config) {
  return containsEmail(config.MARKETING_TEAM || [], email);
}

/**
 * ãƒ¡ãƒ¼ãƒ«ãŒç¤¾å“¡ã¾ãŸã¯ãƒ‘ãƒ¼ãƒˆã®ã„ãšã‚Œã‹ã‹ã‚’åˆ¤å®š
 * @param {String} email - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Boolean}
 */
function isTeamMemberEmail(email, config) {
  if (!email) {
    return false;
  }
  const teamMembers = getAllTeamMembers(config);
  return containsEmail(teamMembers, email);
}

/**
 * æ‹…å½“è€…ã¨ã—ã¦ä½¿ç”¨ã—ãŸããªã„ãƒ¡ãƒ¼ãƒ«ã‹åˆ¤å®š
 * @param {String} email - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Boolean}
 */
function isExcludedResponsibleEmail(email, config) {
  if (!email) {
    return false;
  }
  const excluded = config.EXCLUDED_RESPONSIBLE_EMAILS || [];
  return containsEmail(excluded, email);
}

/**
 * ã‚¿ã‚¤ãƒˆãƒ«ã«é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®š
 * @param {String} title - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Boolean}
 */
function isExcludedTitle(title, config) {
  if (!title) {
    return false;
  }
  const keywords = config.EXCLUDED_TITLE_KEYWORDS || [];
  const lowerTitle = title.toLowerCase();
  return keywords.some(keyword => {
    if (!keyword) {
      return false;
    }
    return lowerTitle.includes(keyword.toLowerCase());
  });
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ—ã«åŒã˜ãƒ¡ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼ˆå¤§å°æ–‡å­—ç„¡è¦–ï¼‰
 * @param {Array} list - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ—
 * @param {String} email - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @return {Boolean}
 */
function containsEmail(list, email) {
  if (!email || !Array.isArray(list)) {
    return false;
  }
  const normalized = normalizeEmail(email);
  return list.some(item => normalizeEmail(item) === normalized);
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ­£è¦åŒ–
 * @param {String} email - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @return {String}
 */
function normalizeEmail(email) {
  return email ? email.toString().trim().toLowerCase() : '';
}

/**
 * ãƒ¡ãƒ¼ãƒ«é…åˆ—ã‹ã‚‰æ¡ä»¶ã«ãƒãƒƒãƒã™ã‚‹æœ€åˆã®ãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—
 * @param {Array} emails - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é…åˆ—
 * @param {Function} predicate - åˆ¤å®šé–¢æ•°
 * @return {String|null} ãƒãƒƒãƒã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 */
function findFirstMatch(emails, predicate) {
  if (!Array.isArray(emails)) {
    return null;
  }
  for (const email of emails) {
    if (email && predicate(email)) {
      return email;
    }
  }
  return null;
}

/**
 * MKã‚·ã‚¹ãƒ†ãƒ ã®ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ—ã‚’æ›´æ–°
 * @param {Sheet} sheet - è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function synchronizeRegistrationStatus(sheet, config, targetSpreadsheet) {
  const registeredMeetings = getRegisteredMeetingsFromSpreadsheet(config, targetSpreadsheet);
  if (registeredMeetings === null) {
    return;
  }
  updateRegistrationStatusColumn(sheet, registeredMeetings, config);
}

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡
 */
function sendChatworkReminders() {
  // å–¶æ¥­æ—¥ãƒã‚§ãƒƒã‚¯
  const today = new Date();
  if (!isBusinessDay(today)) {
    Logger.log('æœ¬æ—¥ã¯å–¶æ¥­æ—¥ã§ã¯ãªã„ãŸã‚ã€ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    return;
  }
  
  const config = getConfig();
  const chatworkConfig = getChatworkConfig();
  
  if (!chatworkConfig.ENABLED) {
    Logger.log('ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€£æºãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™');
    return;
  }
  
  if (!chatworkConfig.API_TOKEN || !chatworkConfig.ROOM_ID) {
    Logger.log('ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    Logger.log('å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: CHATWORK_API_TOKEN, CHATWORK_ROOM_ID');
    return;
  }
  
  const spreadsheet = getOrCreateSpreadsheet(config);
  const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
  setupSheetHeaders(sheet);
  
  // æœ€æ–°ã®ç™»éŒ²çŠ¶æ³ã‚’åæ˜ 
  synchronizeRegistrationStatus(sheet, config, spreadsheet);
  
  const pendingMeetings = getPendingMeetings(sheet, config);
  if (pendingMeetings.length === 0) {
    Logger.log('ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡ã®æœªç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const messageBody = buildChatworkMessage(pendingMeetings, config);
  postChatworkMessage(messageBody, chatworkConfig);
  Logger.log(`ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸æœªç™»éŒ²ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆ${pendingMeetings.length}ä»¶ï¼‰`);
}

/**
 * ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸€è¦§ã‚’å–å¾—
 * @param {Sheet} sheet - è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆ
 * @param {Object} config - è¨­å®š
 * @return {Array<Object>} æœªç™»éŒ²ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°
 */
function getPendingMeetings(sheet, config) {
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) {
    return [];
  }
  
  const lastColumn = sheet.getLastColumn();
  const headers = sheet.getRange(1, 1, 1, lastColumn).getValues()[0];
  const statusHeader = config.REGISTRATION_STATUS_HEADER || 'MKç™»éŒ²çŠ¶æ³';
  const emailHeader = config.RESPONSIBLE_EMAIL_HEADER || 'æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹';
  const indexes = {
    date: headers.indexOf('æ—¥ä»˜'),
    start: headers.indexOf('é–‹å§‹æ™‚åˆ»'),
    end: headers.indexOf('çµ‚äº†æ™‚åˆ»'),
    client: headers.indexOf('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå'),
    responsible: headers.indexOf('æ‹…å½“è€…'),
    email: headers.indexOf(emailHeader),
    status: headers.indexOf(statusHeader)
  };
  
  if (indexes.date === -1 || indexes.start === -1 || indexes.end === -1 ||
      indexes.client === -1 || indexes.responsible === -1 || indexes.email === -1 ||
      indexes.status === -1) {
    Logger.log('ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡æŠ½å‡ºã«å¿…è¦ãªåˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    return [];
  }
  
  const dataRange = sheet.getRange(2, 1, lastRow - 1, lastColumn).getValues();
  const timezone = config.TIMEZONE || Session.getScriptTimeZone();
  const pending = [];
  
  // 2025/11/26ä»¥é™ã®æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®åŸºæº–æ—¥
  const filterDate = new Date(2025, 10, 26); // 2025å¹´11æœˆ26æ—¥ï¼ˆæœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
  filterDate.setHours(0, 0, 0, 0);
  
  dataRange.forEach(row => {
    const statusValue = row[indexes.status];
    if (statusValue && statusValue.toString().trim() !== '') {
      return;
    }
    
    const dateValue = formatDateCell(row[indexes.date], timezone);
    const startValue = formatTimeCell(row[indexes.start], timezone);
    const endValue = formatTimeCell(row[indexes.end], timezone);
    const clientValue = row[indexes.client] ? row[indexes.client].toString().trim() : '';
    const responsibleName = row[indexes.responsible] ? row[indexes.responsible].toString().trim() : '';
    const responsibleEmail = row[indexes.email] ? row[indexes.email].toString().trim() : '';
    
    if (!dateValue || !startValue) {
      return;
    }
    
    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼š2025/11/26ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å¯¾è±¡
    try {
      const meetingDate = new Date(dateValue);
      meetingDate.setHours(0, 0, 0, 0);
      
      if (meetingDate < filterDate) {
        return; // 2025/11/26ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã¯ã‚¹ã‚­ãƒƒãƒ—
      }
    } catch (error) {
      Logger.log(`æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼‰: ${dateValue} - ${error.toString()}`);
      return;
    }
    
    // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã«é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    const excludedKeywords = config.EXCLUDED_TITLE_KEYWORDS || [];
    if (excludedKeywords.some(keyword => clientValue.includes(keyword))) {
      Logger.log(`é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã‚¹ã‚­ãƒƒãƒ—: ${clientValue}`);
      return;
    }
    
    pending.push({
      date: dateValue,
      startTime: startValue,
      endTime: endValue,
      clientName: clientValue,
      responsibleName: responsibleName,
      responsibleEmail: responsibleEmail
    });
  });
  
  return pending;
}

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€ä¿¡ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
 * @param {Array<Object>} meetings - æœªç™»éŒ²ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸€è¦§
 * @param {Object} config - è¨­å®š
 * @return {String} ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
 */
function buildChatworkMessage(meetings, config) {
  // MKç™»éŒ²æ¸ˆã¿ä¸€è¦§ã‚·ãƒ¼ãƒˆã‹ã‚‰æ­£å¼ãªé¡§å®¢åä¸€è¦§ã‚’å–å¾—
  const clientData = getClientNameMap(config);
  const formalNames = clientData.formalNames || [];
  
  const details = meetings.map(meeting => {
    const responsible = meeting.responsibleName || 'æ‹…å½“è€…æœªè¨­å®š';
    const responsibleEmail = meeting.responsibleEmail || '';
    const clientOriginal = meeting.clientName || 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªè¨­å®š';
    
    // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯æ­£å¼åç§°ã®ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—
    const excludedKeywords = config.EXCLUDED_TITLE_KEYWORDS || [];
    const shouldSkipMatching = excludedKeywords.some(keyword => clientOriginal.includes(keyword));
    
    // é¡ä¼¼åº¦ãƒãƒƒãƒãƒ³ã‚°ã§æ­£å¼ãªé¡§å®¢åã‚’æ¤œç´¢ï¼ˆé™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å…ƒã®åå‰ã‚’ä½¿ç”¨ï¼‰
    const clientFormal = shouldSkipMatching ? clientOriginal : findSimilarClientName(clientOriginal, formalNames);
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å¤‰æ›´ï¼ˆ11/26(æ°´)å½¢å¼ï¼‰
    const dateFormatted = formatDateForChatwork(meeting.date);
    
    // ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯IDã‚’å–å¾—
    const chatworkId = config.EMAIL_TO_CHATWORK_ID && config.EMAIL_TO_CHATWORK_ID[responsibleEmail];
    const responsibleWithId = chatworkId ? `${chatworkId}${responsible}` : responsible;
    
    return `${responsibleWithId}ã•ã‚“\n\n${dateFormatted}ã€€${meeting.startTime}ï½ã€€ã€€${clientFormal} æ§˜`;
  }).join('\n\n');
  
  const template = (config.CHATWORK && config.CHATWORK.REMINDER_TEMPLATE) ||
    'ãŠç–²ã‚Œæ§˜ã§ã™ã€‚\n\nè­°äº‹éŒ²ã®ã‚¢ãƒƒãƒ—ãŒç¢ºèªã§ãã¦ãŠã‚Šã¾ã›ã‚“ã€‚\n\nã¾ãŸã€å¯¾å¿œå®Œäº†ã—ã¦ã„ã‚‹ã®ã«ã€ã“ã¡ã‚‰ã®ãƒãƒ£ãƒƒãƒˆã§é€£çµ¡ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã¯ã€\n\nè¦‹è½ã¨ã—ã®å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€æã‚Œå…¥ã‚Šã¾ã™ãŒã€ã”é€£çµ¡ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚\n\nâ€»è­°äº‹éŒ²ä¸è¦ã®å ´åˆã«ã‚‚ã€ãŠæ‰‹æ•°ã§ã™ãŒãã®æ—¨ãŠä¼ãˆãã ã•ã„ã€‚\n\n----------------------------------------------------------------------------\n\n%DETAILS%\n\n------------------------------------------------------------------';
  
  return template.replace('%DETAILS%', details);
}

/**
 * é¡§å®¢ä¸€è¦§_importã‚·ãƒ¼ãƒˆã‹ã‚‰é¡§å®¢åãƒãƒƒãƒ—ã‚’å–å¾—ï¼ˆé¡ä¼¼åº¦ãƒãƒƒãƒãƒ³ã‚°å¯¾å¿œï¼‰
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Object} å…ƒã®é¡§å®¢åâ†’æ­£å¼é¡§å®¢åã®ãƒãƒƒãƒ—
 */
function getClientNameMap(config) {
  try {
    const spreadsheet = SpreadsheetApp.openById(config.SPREADSHEET_ID);
    const clientSheet = spreadsheet.getSheetByName('é¡§å®¢ä¸€è¦§_import');
    
    if (!clientSheet) {
      Logger.log('é¡§å®¢ä¸€è¦§_importã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return { formalNames: [] };
    }
    
    const lastRow = clientSheet.getLastRow();
    if (lastRow <= 1) {
      Logger.log('é¡§å®¢ä¸€è¦§_importã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return { formalNames: [] };
    }
    
    const formalClientColumnIndex = 1; // Båˆ—ï¼ˆ0ãƒ™ãƒ¼ã‚¹ã§1ï¼‰
    const dataRange = clientSheet.getRange(2, 1, lastRow - 1, clientSheet.getLastColumn()).getValues();
    
    // Båˆ—ã‹ã‚‰æ­£å¼ãªé¡§å®¢åä¸€è¦§ã‚’å–å¾—
    const formalClientNames = [];
    dataRange.forEach(row => {
      const formalClient = row[formalClientColumnIndex] ? row[formalClientColumnIndex].toString().trim() : '';
      if (formalClient && !formalClientNames.includes(formalClient)) {
        formalClientNames.push(formalClient);
      }
    });
    
    Logger.log(`é¡§å®¢ä¸€è¦§_importã‚·ãƒ¼ãƒˆã‹ã‚‰${formalClientNames.length}ä»¶ã®é¡§å®¢åã‚’å–å¾—ã—ã¾ã—ãŸ`);
    return { formalNames: formalClientNames };
  } catch (error) {
    Logger.log(`é¡§å®¢åãƒãƒƒãƒ—å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    return { formalNames: [] };
  }
}

/**
 * æ‰‹æ›¸ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã«æœ€ã‚‚é¡ä¼¼ã™ã‚‹æ­£å¼åç§°ã‚’æ¤œç´¢
 * @param {String} handwrittenName - æ‰‹æ›¸ãã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
 * @param {Array} formalNames - æ­£å¼åç§°ã®é…åˆ—
 * @return {String} æœ€ã‚‚é¡ä¼¼ã™ã‚‹æ­£å¼åç§°ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®åå‰ï¼‰
 */
function findSimilarClientName(handwrittenName, formalNames) {
  if (!handwrittenName || !formalNames || formalNames.length === 0) {
    return handwrittenName;
  }
  
  // å®Œå…¨ä¸€è‡´ãƒã‚§ãƒƒã‚¯
  const exactMatch = formalNames.find(name => name === handwrittenName);
  if (exactMatch) {
    return exactMatch;
  }
  
  // éƒ¨åˆ†ä¸€è‡´ãƒã‚§ãƒƒã‚¯ï¼ˆæ‰‹æ›¸ãåãŒæ­£å¼åç§°ã«å«ã¾ã‚Œã‚‹ï¼‰
  const partialMatch = formalNames.find(name => name.includes(handwrittenName));
  if (partialMatch) {
    Logger.log(`éƒ¨åˆ†ä¸€è‡´ç™ºè¦‹: "${handwrittenName}" â†’ "${partialMatch}"`);
    return partialMatch;
  }
  
  // é€†éƒ¨åˆ†ä¸€è‡´ãƒã‚§ãƒƒã‚¯ï¼ˆæ­£å¼åç§°ãŒæ‰‹æ›¸ãåã«å«ã¾ã‚Œã‚‹ï¼‰
  const reverseMatch = formalNames.find(name => handwrittenName.includes(name));
  if (reverseMatch) {
    Logger.log(`é€†éƒ¨åˆ†ä¸€è‡´ç™ºè¦‹: "${handwrittenName}" â†’ "${reverseMatch}"`);
    return reverseMatch;
  }
  
  // ä¼šç¤¾åã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
  const companyKeywords = extractCompanyKeywords(handwrittenName);
  if (companyKeywords.length > 0) {
    for (const keyword of companyKeywords) {
      const keywordMatch = formalNames.find(name => name.includes(keyword));
      if (keywordMatch) {
        Logger.log(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ç™ºè¦‹: "${handwrittenName}" (${keyword}) â†’ "${keywordMatch}"`);
        return keywordMatch;
      }
    }
  }
  
  // é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ãƒ™ãƒ¼ã‚¹ï¼‰
  let bestMatch = handwrittenName;
  let bestScore = 0;
  const threshold = 0.6; // é¡ä¼¼åº¦ã®é–¾å€¤
  
  formalNames.forEach(formalName => {
    const similarity = calculateSimilarity(handwrittenName, formalName);
    if (similarity > bestScore && similarity >= threshold) {
      bestScore = similarity;
      bestMatch = formalName;
    }
  });
  
  if (bestMatch !== handwrittenName) {
    Logger.log(`é¡ä¼¼åº¦ãƒãƒƒãƒãƒ³ã‚°ç™ºè¦‹: "${handwrittenName}" â†’ "${bestMatch}" (é¡ä¼¼åº¦: ${bestScore.toFixed(2)})`);
  }
  
  return bestMatch;
}

/**
 * ä¼šç¤¾åã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
 * @param {String} companyName - ä¼šç¤¾å
 * @return {Array} ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…åˆ—
 */
function extractCompanyKeywords(companyName) {
  const keywords = [];
  
  // ã€Œæ ªå¼ä¼šç¤¾ã€ã€Œæœ‰é™ä¼šç¤¾ã€ã€ŒåˆåŒä¼šç¤¾ã€ãªã©ã‚’é™¤å»
  let cleanName = companyName
    .replace(/æ ªå¼ä¼šç¤¾|æœ‰é™ä¼šç¤¾|åˆåŒä¼šç¤¾|åˆè³‡ä¼šç¤¾|ä¸€èˆ¬ç¤¾å›£æ³•äºº|å…¬ç›Šç¤¾å›£æ³•äºº|ä¸€èˆ¬è²¡å›£æ³•äºº|å…¬ç›Šè²¡å›£æ³•äºº/g, '')
    .replace(/\s+/g, '') // ç©ºç™½é™¤å»
    .trim();
  
  // ã‚«ã‚¿ã‚«ãƒŠãƒ»ã²ã‚‰ãŒãªãƒ»æ¼¢å­—ãƒ»è‹±æ•°å­—ã®é€£ç¶šéƒ¨åˆ†ã‚’æŠ½å‡º
  const matches = cleanName.match(/[ã‚¡-ãƒ¶ãƒ¼]+|[ã‚-ã‚“]+|[ä¸€-é¾¯]+|[A-Za-z0-9]+/g);
  if (matches) {
    matches.forEach(match => {
      if (match.length >= 2) { // 2æ–‡å­—ä»¥ä¸Šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿
        keywords.push(match);
      }
    });
  }
  
  return keywords;
}

/**
 * æ–‡å­—åˆ—ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ï¼ˆ0-1ã®ç¯„å›²ï¼‰
 * @param {String} str1 - æ–‡å­—åˆ—1
 * @param {String} str2 - æ–‡å­—åˆ—2
 * @return {Number} é¡ä¼¼åº¦ï¼ˆ0-1ï¼‰
 */
function calculateSimilarity(str1, str2) {
  if (str1 === str2) return 1;
  if (!str1 || !str2) return 0;
  
  const maxLength = Math.max(str1.length, str2.length);
  const distance = levenshteinDistance(str1, str2);
  
  return (maxLength - distance) / maxLength;
}

/**
 * ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—
 * @param {String} str1 - æ–‡å­—åˆ—1
 * @param {String} str2 - æ–‡å­—åˆ—2
 * @return {Number} ç·¨é›†è·é›¢
 */
function levenshteinDistance(str1, str2) {
  const matrix = [];
  
  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }
  
  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }
  
  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  
  return matrix[str2.length][str1.length];
}

/**
 * å–¶æ¥­æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆåœŸæ—¥ç¥ã‚’é™¤å¤–ï¼‰
 * @param {Date} date - åˆ¤å®šã™ã‚‹æ—¥ä»˜
 * @return {Boolean} å–¶æ¥­æ—¥ã®å ´åˆtrue
 */
function isBusinessDay(date) {
  const dayOfWeek = date.getDay();
  
  // åœŸæ›œæ—¥(6)ã¾ãŸã¯æ—¥æ›œæ—¥(0)ã¯å–¶æ¥­æ—¥ã§ã¯ãªã„
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    return false;
  }
  
  // ç¥æ—¥ãƒã‚§ãƒƒã‚¯
  if (isJapaneseHoliday(date)) {
    return false;
  }
  
  return true;
}

/**
 * å‰å–¶æ¥­æ—¥ã‚’å–å¾—ï¼ˆæœˆæ›œæ—¥ã®å ´åˆã¯å‰é€±é‡‘æ›œæ—¥ï¼‰
 * @param {Date} date - åŸºæº–æ—¥
 * @return {Date} å‰å–¶æ¥­æ—¥
 */
function getPreviousBusinessDay(date) {
  const previousDay = new Date(date);
  previousDay.setDate(previousDay.getDate() - 1);
  
  // å‰æ—¥ãŒå–¶æ¥­æ—¥ã§ãªã„å ´åˆã¯ã€ã•ã‚‰ã«å‰ã®å–¶æ¥­æ—¥ã‚’æ¢ã™
  while (!isBusinessDay(previousDay)) {
    previousDay.setDate(previousDay.getDate() - 1);
  }
  
  return previousDay;
}

/**
 * æ—¥æœ¬ã®ç¥æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®š
 * @param {Date} date - åˆ¤å®šã™ã‚‹æ—¥ä»˜
 * @return {Boolean} ç¥æ—¥ã®å ´åˆtrue
 */
function isJapaneseHoliday(date) {
  const year = date.getFullYear();
  const month = date.getMonth() + 1; // 0ãƒ™ãƒ¼ã‚¹ãªã®ã§+1
  const day = date.getDate();
  
  // å›ºå®šç¥æ—¥
  const fixedHolidays = [
    { month: 1, day: 1 },   // å…ƒæ—¥
    { month: 2, day: 11 },  // å»ºå›½è¨˜å¿µã®æ—¥
    { month: 2, day: 23 },  // å¤©çš‡èª•ç”Ÿæ—¥
    { month: 4, day: 29 },  // æ˜­å’Œã®æ—¥
    { month: 5, day: 3 },   // æ†²æ³•è¨˜å¿µæ—¥
    { month: 5, day: 4 },   // ã¿ã©ã‚Šã®æ—¥
    { month: 5, day: 5 },   // ã“ã©ã‚‚ã®æ—¥
    { month: 8, day: 11 },  // å±±ã®æ—¥
    { month: 11, day: 3 },  // æ–‡åŒ–ã®æ—¥
    { month: 11, day: 23 }, // å‹¤åŠ´æ„Ÿè¬ã®æ—¥
  ];
  
  // å›ºå®šç¥æ—¥ãƒã‚§ãƒƒã‚¯
  for (const holiday of fixedHolidays) {
    if (month === holiday.month && day === holiday.day) {
      return true;
    }
  }
  
  // ç§»å‹•ç¥æ—¥ï¼ˆç°¡æ˜“ç‰ˆï¼‰
  // æˆäººã®æ—¥ï¼ˆ1æœˆç¬¬2æœˆæ›œæ—¥ï¼‰
  if (month === 1) {
    const secondMonday = getNthWeekdayOfMonth(year, 1, 1, 2); // 1æœˆã®ç¬¬2æœˆæ›œæ—¥
    if (day === secondMonday) return true;
  }
  
  // æµ·ã®æ—¥ï¼ˆ7æœˆç¬¬3æœˆæ›œæ—¥ï¼‰
  if (month === 7) {
    const thirdMonday = getNthWeekdayOfMonth(year, 7, 1, 3); // 7æœˆã®ç¬¬3æœˆæ›œæ—¥
    if (day === thirdMonday) return true;
  }
  
  // æ•¬è€ã®æ—¥ï¼ˆ9æœˆç¬¬3æœˆæ›œæ—¥ï¼‰
  if (month === 9) {
    const thirdMonday = getNthWeekdayOfMonth(year, 9, 1, 3); // 9æœˆã®ç¬¬3æœˆæ›œæ—¥
    if (day === thirdMonday) return true;
  }
  
  // ä½“è‚²ã®æ—¥/ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥ï¼ˆ10æœˆç¬¬2æœˆæ›œæ—¥ï¼‰
  if (month === 10) {
    const secondMonday = getNthWeekdayOfMonth(year, 10, 1, 2); // 10æœˆã®ç¬¬2æœˆæ›œæ—¥
    if (day === secondMonday) return true;
  }
  
  // æ˜¥åˆ†ã®æ—¥ãƒ»ç§‹åˆ†ã®æ—¥ï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰
  if (month === 3) {
    const vernalEquinox = Math.floor(20.8431 + 0.242194 * (year - 1851) - Math.floor((year - 1851) / 4));
    if (day === vernalEquinox) return true;
  }
  
  if (month === 9) {
    const autumnalEquinox = Math.floor(23.2488 + 0.242194 * (year - 1851) - Math.floor((year - 1851) / 4));
    if (day === autumnalEquinox) return true;
  }
  
  return false;
}

/**
 * æŒ‡å®šæœˆã®ç¬¬Næ›œæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
 * @param {Number} year - å¹´
 * @param {Number} month - æœˆï¼ˆ1-12ï¼‰
 * @param {Number} dayOfWeek - æ›œæ—¥ï¼ˆ0=æ—¥æ›œæ—¥, 1=æœˆæ›œæ—¥, ...ï¼‰
 * @param {Number} nth - ç¬¬ä½•é€±ç›®ï¼ˆ1-5ï¼‰
 * @return {Number} æ—¥ä»˜
 */
function getNthWeekdayOfMonth(year, month, dayOfWeek, nth) {
  const firstDay = new Date(year, month - 1, 1);
  const firstDayOfWeek = firstDay.getDay();
  
  let targetDate = 1 + (dayOfWeek - firstDayOfWeek + 7) % 7;
  targetDate += (nth - 1) * 7;
  
  return targetDate;
}

/**
 * æ—¥ä»˜ã‚’ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
 * @param {String} dateStr - æ—¥ä»˜æ–‡å­—åˆ—ï¼ˆYYYY/MM/DDå½¢å¼ï¼‰
 * @return {String} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿æ—¥ä»˜ï¼ˆMM/DD(æ›œæ—¥)å½¢å¼ï¼‰
 */
function formatDateForChatwork(dateStr) {
  try {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    const weekday = weekdays[date.getDay()];
    
    return `${month}/${day}(${weekday})`;
  } catch (error) {
    Logger.log(`æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    return dateStr;
  }
}

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡
 * @param {String} messageBody - é€ä¿¡ã™ã‚‹æœ¬æ–‡
 * @param {Object} chatworkConfig - ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
 */
function postChatworkMessage(messageBody, chatworkConfig) {
  const url = `https://api.chatwork.com/v2/rooms/${chatworkConfig.ROOM_ID}/messages`;
  const options = {
    method: 'post',
    headers: {
      'X-ChatWorkToken': chatworkConfig.API_TOKEN
    },
    payload: {
      body: messageBody
    },
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(url, options);
  const code = response.getResponseCode();
  const text = response.getContentText();
  
  if (code < 200 || code >= 300) {
    throw new Error(`ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ (${code}): ${text}`);
  }
  
  Logger.log(`ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€ä¿¡æˆåŠŸ: ${text}`);
}

/**
 * MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²æ¸ˆã¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Set|null} ç™»éŒ²æ¸ˆã¿ä¼šè­°ã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆï¼ˆè¨­å®šä¸è¶³ã®å ´åˆã¯nullï¼‰
 */
function getRegisteredMeetingsFromSpreadsheet(config, targetSpreadsheet) {
  const registrationConfig = config.MK_REGISTRATION_SHEET || {};
  const timezone = config.TIMEZONE || Session.getScriptTimeZone();
  let dataSheet = null;
  let sourceType = '';
  
  if (registrationConfig.SPREADSHEET_ID) {
    try {
      const externalSpreadsheet = SpreadsheetApp.openById(registrationConfig.SPREADSHEET_ID);
      dataSheet = externalSpreadsheet.getSheetByName(registrationConfig.SHEET_NAME);
      if (!dataSheet) {
        Logger.log(`ç™»éŒ²æ¸ˆã¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€æ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™: ${registrationConfig.SHEET_NAME}`);
      } else {
        sourceType = 'external';
      }
    } catch (error) {
      Logger.log(`ç™»éŒ²æ¸ˆã¿ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ${error.toString()}`);
    }
  }
  
  if (!dataSheet && targetSpreadsheet && registrationConfig.LOCAL_SHEET_NAME) {
    dataSheet = targetSpreadsheet.getSheetByName(registrationConfig.LOCAL_SHEET_NAME);
    if (!dataSheet) {
      Logger.log(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ãƒ¼ãƒˆã€Œ${registrationConfig.LOCAL_SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      return null;
    }
    sourceType = 'local';
  }
  
  if (!dataSheet) {
    Logger.log('MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ããªã„ãŸã‚ã€æ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    return null;
  }
  
  const values = dataSheet.getDataRange().getValues();
  if (values.length <= 1) {
    Logger.log('ç™»éŒ²æ¸ˆã¿ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€æ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    return new Set();
  }
  
  const headers = values[0];
  const dateHeader = registrationConfig.DATE_COLUMN || 'å®Ÿæ–½æ—¥';
  const employeeHeader = registrationConfig.EMPLOYEE_NAME_COLUMN || 'å¾“æ¥­å“¡å';
  
  const dateIndex = headers.indexOf(dateHeader);
  const employeeIndex = headers.indexOf(employeeHeader);
  
  if (dateIndex === -1 || employeeIndex === -1) {
    Logger.log(`ç™»éŒ²æ¸ˆã¿ã‚·ãƒ¼ãƒˆã«å¿…è¦ãªåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å¿…è¦: ${dateHeader}, ${employeeHeader}`);
    return null;
  }
  
  const registeredMeetings = new Set();
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const dateValue = normalizeDateValue(row[dateIndex], timezone);
    const employeeName = normalizeEmployeeName(row[employeeIndex]);
    
    if (dateValue && employeeName) {
      registeredMeetings.add(buildMeetingKeyByDateAndEmployee(dateValue, employeeName));
    }
  }
  
  Logger.log(`${sourceType === 'local' ? 'ãƒ­ãƒ¼ã‚«ãƒ«' : 'å¤–éƒ¨'}ã‚·ãƒ¼ãƒˆã‹ã‚‰${registeredMeetings.size}ä»¶ã®ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
  return registeredMeetings;
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ—ã‚’æ›´æ–°
 * @param {Sheet} sheet - è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆ
 * @param {Set} registeredMeetings - ç™»éŒ²æ¸ˆã¿ä¼šè­°ã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆ
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateRegistrationStatusColumn(sheet, registeredMeetings, config) {
  if (!registeredMeetings) {
    return;
  }
  
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) {
    Logger.log('è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    return;
  }
  
  const headerRow = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const dateIndex = headerRow.indexOf('æ—¥ä»˜');                    // è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆã®Aåˆ—
  const participantIndex = headerRow.indexOf('å‚åŠ è€…');           // è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆã®Gåˆ—
  const statusHeader = config.REGISTRATION_STATUS_HEADER || 'MKç™»éŒ²çŠ¶æ³';
  const statusIndex = headerRow.indexOf(statusHeader);           // è­°äº‹éŒ²ã‚·ãƒ¼ãƒˆã®Iåˆ—
  
  if (dateIndex === -1 || participantIndex === -1 || statusIndex === -1) {
    Logger.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¿…è¦ãªåˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
    Logger.log(`å¿…è¦ãªåˆ—: æ—¥ä»˜(${dateIndex}), å‚åŠ è€…(${participantIndex}), ${statusHeader}(${statusIndex})`);
    return;
  }
  
  const timezone = config.TIMEZONE || Session.getScriptTimeZone();
  const statusRange = sheet.getRange(2, statusIndex + 1, lastRow - 1, 1);
  const statusValues = statusRange.getValues();
  const dateRange = sheet.getRange(2, dateIndex + 1, lastRow - 1, 1).getValues();
  const participantRange = sheet.getRange(2, participantIndex + 1, lastRow - 1, 1).getValues();
  const statusValueText = (config.MK_REGISTRATION_SHEET && config.MK_REGISTRATION_SHEET.STATUS_VALUE) || 'æ¸ˆ';
  
  for (let i = 0; i < statusValues.length; i++) {
    const dateValue = normalizeDateValue(dateRange[i][0], timezone);
    const participantList = participantRange[i][0] ? participantRange[i][0].toString() : '';
    
    if (dateValue && participantList) {
      // å‚åŠ è€…ãƒªã‚¹ãƒˆã‹ã‚‰å€‹åˆ¥ã®åå‰ã‚’æŠ½å‡º
      const participants = participantList.split(',').map(name => normalizeEmployeeName(name));
      
      // å„å‚åŠ è€…ã«ã¤ã„ã¦ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      let isRegistered = false;
      for (const participant of participants) {
        if (participant) {
          const key = buildMeetingKeyByDateAndEmployee(dateValue, participant);
          if (registeredMeetings.has(key)) {
            isRegistered = true;
            break;
          }
        }
      }
      
      statusValues[i][0] = isRegistered ? statusValueText : '';
    } else {
      statusValues[i][0] = '';
    }
  }
  
  statusRange.setValues(statusValues);
  Logger.log('MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²çŠ¶æ³ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ');
}

/**
 * æ—¥ä»˜ã‚’yyyy-MM-ddå½¢å¼ã«å¤‰æ›
 * @param {any} value - æ—¥ä»˜å€¤
 * @param {String} timezone - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
 * @return {String} æ­£è¦åŒ–ã•ã‚ŒãŸæ—¥ä»˜æ–‡å­—åˆ—
 */
function formatDateCell(value, timezone) {
  const normalized = normalizeDateValue(value, timezone);
  if (!normalized) {
    return '';
  }
  const dateObj = new Date(normalized);
  if (isNaN(dateObj.getTime())) {
    return normalized;
  }
  return Utilities.formatDate(dateObj, timezone || Session.getScriptTimeZone(), 'yyyy/MM/dd');
}

function formatTimeCell(value, timezone) {
  const normalized = normalizeTimeValue(value, timezone);
  if (!normalized) {
    return '';
  }
  return normalized;
}

function normalizeDateValue(value, timezone) {
  if (!value) {
    return '';
  }
  
  if (value instanceof Date) {
    return Utilities.formatDate(value, timezone || Session.getScriptTimeZone(), 'yyyy-MM-dd');
  }
  
  const str = value.toString().trim();
  if (str === '') {
    return '';
  }
  
  // æ–‡å­—åˆ—ã‚’æ—¥ä»˜ã«å¤‰æ›
  const parsed = new Date(str);
  if (!isNaN(parsed.getTime())) {
    return Utilities.formatDate(parsed, timezone || Session.getScriptTimeZone(), 'yyyy-MM-dd');
  }
  
  // yyyy/mm/dd ã¾ãŸã¯ yyyy-mm-dd ã®å½¢å¼ã‚’è£œæ­£
  const match = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (match) {
    const month = match[2].padStart(2, '0');
    const day = match[3].padStart(2, '0');
    return `${match[1]}-${month}-${day}`;
  }
  
  return str;
}

/**
 * æ™‚åˆ»ã‚’HH:mmå½¢å¼ã«å¤‰æ›
 * @param {any} value - æ™‚åˆ»å€¤
 * @param {String} timezone - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
 * @return {String} æ­£è¦åŒ–ã•ã‚ŒãŸæ™‚åˆ»æ–‡å­—åˆ—
 */
function normalizeTimeValue(value, timezone) {
  if (!value) {
    return '';
  }
  
  if (value instanceof Date) {
    return Utilities.formatDate(value, timezone || Session.getScriptTimeZone(), 'HH:mm');
  }
  
  const str = value.toString().trim();
  if (str === '') {
    return '';
  }
  
  const match = str.match(/(\d{1,2}):(\d{2})/);
  if (match) {
    return `${match[1].padStart(2, '0')}:${match[2]}`;
  }
  
  const parsed = new Date(str);
  if (!isNaN(parsed.getTime())) {
    return Utilities.formatDate(parsed, timezone || Session.getScriptTimeZone(), 'HH:mm');
  }
  
  return str;
}

/**
 * ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆæ—¥ä»˜ï¼‹æ‹…å½“è€…åï¼‰
 * @param {String} date - æ—¥ä»˜ï¼ˆyyyy-MM-ddï¼‰
 * @param {String} employeeName - æ‹…å½“è€…å
 * @return {String} ã‚­ãƒ¼æ–‡å­—åˆ—
 */
function buildMeetingKeyByDateAndEmployee(date, employeeName) {
  return [date, normalizeEmployeeName(employeeName)].join('::');
}

/**
 * å¾“æ¥­å“¡åã‚’æ­£è¦åŒ–
 * @param {any} value - å¾“æ¥­å“¡å
 * @return {String} æ­£è¦åŒ–ã•ã‚ŒãŸå¾“æ¥­å“¡å
 */
function normalizeEmployeeName(value) {
  if (!value) {
    return '';
  }
  return value.toString().trim();
}

/**
 * ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆæ—§ç‰ˆï¼šæ—¥ä»˜ï¼‹æ™‚åˆ»ï¼‹ãƒ¡ãƒ¼ãƒ«ï¼‰
 * @param {String} date - æ—¥ä»˜ï¼ˆyyyy-MM-ddï¼‰
 * @param {String} startTime - é–‹å§‹æ™‚åˆ»ï¼ˆHH:mmï¼‰
 * @param {String} email - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @return {String} ã‚­ãƒ¼æ–‡å­—åˆ—
 */
function buildMeetingKey(date, startTime, email) {
  return [date, startTime, normalizeEmail(email)].join('::');
}

function isChatworkConfigured() {
  const chatworkConfig = getChatworkConfig();
  return !!(chatworkConfig.ENABLED && chatworkConfig.API_TOKEN && chatworkConfig.ROOM_ID);
}

/**
 * MKã‚·ã‚¹ãƒ†ãƒ ã«è­°äº‹éŒ²ã‚’ç™»éŒ²
 * @param {Object} meetingData - ä¼šè­°ãƒ‡ãƒ¼ã‚¿
 * @param {Object} mkSystemConfig - MKã‚·ã‚¹ãƒ†ãƒ è¨­å®š
 */
function registerToMKSystem(meetingData, mkSystemConfig) {
  try {
    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ç™»éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—
    const config = getConfig();
    if (config.TEST_MODE) {
      Logger.log(`[ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰] ç™»éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName} - ${meetingData.date}`);
      Logger.log(`ç™»éŒ²ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(meetingData, null, 2)}`);
      return { success: true, testMode: true };
    }
    
    // MKã‚·ã‚¹ãƒ†ãƒ ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨èªè¨¼æ–¹æ³•ã‚’è¨­å®š
    const url = mkSystemConfig.API_ENDPOINT;
    
    // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæœªè¨­å®šã¾ãŸã¯example.comã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (!url || url.includes('example.com')) {
      Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šãŒæœªè¨­å®šã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName}`);
      return { success: false, skipped: true, reason: 'API endpoint not configured' };
    }
    
    const apiKey = mkSystemConfig.API_KEY;
    const authType = mkSystemConfig.AUTH_TYPE || 'bearer';
    
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨
    const fieldMapping = mkSystemConfig.FIELD_MAPPING || {};
    const mapField = (originalField) => {
      return fieldMapping[originalField] || originalField;
    };
    
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
    const payload = {
      [mapField('date')]: meetingData.date,
      [mapField('start_time')]: meetingData.startTime,
      [mapField('end_time')]: meetingData.endTime,
      [mapField('client_name')]: meetingData.clientName,
      [mapField('responsible_person')]: meetingData.responsiblePerson, // æ‹…å½“è€…ï¼ˆæœ€åˆã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
      [mapField('attendees')]: meetingData.attendees,
      [mapField('description')]: meetingData.description,
      [mapField('location')]: meetingData.location
    };
    
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¿½åŠ 
    if (mkSystemConfig.ADDITIONAL_FIELDS) {
      Object.assign(payload, mkSystemConfig.ADDITIONAL_FIELDS);
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
    const headers = {
      'Content-Type': 'application/json',
      ...mkSystemConfig.ADDITIONAL_HEADERS || {}
    };
    
    // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
    if (authType === 'bearer') {
      headers['Authorization'] = `Bearer ${apiKey}`;
    } else if (authType === 'apikey') {
      headers['X-API-Key'] = apiKey;
    }
    
    // HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    const options = {
      method: 'POST',
      headers: headers,
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²ä¸­: ${meetingData.clientName} - ${meetingData.date}`);
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();
    
    if (responseCode >= 200 && responseCode < 300) {
      Logger.log(`ç™»éŒ²æˆåŠŸ: ${meetingData.clientName} - ${meetingData.date}`);
      Logger.log(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${responseText}`);
    } else {
      Logger.log(`ç™»éŒ²å¤±æ•— (${responseCode}): ${meetingData.clientName} - ${meetingData.date}`);
      Logger.log(`ã‚¨ãƒ©ãƒ¼å†…å®¹: ${responseText}`);
    }
    
    return {
      success: responseCode >= 200 && responseCode < 300,
      statusCode: responseCode,
      response: responseText
    };
  } catch (error) {
    Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

// æ³¨æ„: getConfig() é–¢æ•°ã¯ Config.gs ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™
// ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€Config.gsã®getSecureConfig()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

/**
 * æ¯æ—¥æœ6:00ã«è‡ªå‹•å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 * ã“ã®é–¢æ•°ã‚’1å›å®Ÿè¡Œã™ã‚‹ã¨ã€æ¯æ—¥æœ6:00ã«main()é–¢æ•°ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
 */
function setupDailyTrigger() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'main' || trigger.getHandlerFunction() === 'mainWithBusinessDayCheck') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // æ–°ã—ã„ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆï¼ˆæ¯æ—¥æœ6:00ã€å–¶æ¥­æ—¥ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
  ScriptApp.newTrigger('mainWithBusinessDayCheck')
    .timeBased()
    .everyDays(1)
    .atHour(6)
    .create();
  
  Logger.log('æ¯æ—¥æœ6:00ã«è‡ªå‹•å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
  SpreadsheetApp.getActiveSpreadsheet().toast('ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚æ¯æ—¥æœ6:00ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
}

/**
 * ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
 */
function deleteTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'main') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  Logger.log('ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  SpreadsheetApp.getActiveSpreadsheet().toast('ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 3);
}

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’æ¯æ—¥10:00ã«å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
 */
function setupChatworkReminderTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'sendChatworkReminders') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  ScriptApp.newTrigger('sendChatworkReminders')
    .timeBased()
    .everyDays(1)
    .atHour(10)
    .create();
  
  Logger.log('ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’æ¯æ—¥10:00ã«å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆå–¶æ¥­æ—¥ã®ã¿ï¼‰');
  SpreadsheetApp.getActiveSpreadsheet().toast('ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’æ¯æ—¥10:00ã«å®Ÿè¡Œã—ã¾ã™ï¼ˆå–¶æ¥­æ—¥ã®ã¿ï¼‰', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
}

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
 */
function deleteChatworkReminderTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'sendChatworkReminders') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  Logger.log('ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  SpreadsheetApp.getActiveSpreadsheet().toast('ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 3);
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
 * ã“ã®é–¢æ•°ã¯ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸã¨ãã«è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã¾ã™
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²')
    .addItem('è­°äº‹éŒ²ã‚’ç™»éŒ²ï¼ˆå‰æ—¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰', 'runMain')
    .addItem('æœªç™»éŒ²è€…ã«ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡', 'runSendChatworkReminders')
    .addSeparator()
    .addItem('è‡ªå‹•å®Ÿè¡Œã‚’è¨­å®šï¼ˆæ¯æ—¥6:00ï¼‰', 'setupDailyTrigger')
    .addItem('è‡ªå‹•å®Ÿè¡Œã‚’è§£é™¤', 'deleteTrigger')
    .addSeparator()
    .addItem('ãƒªãƒã‚¤ãƒ³ãƒ‰è‡ªå‹•é€ä¿¡ã‚’è¨­å®šï¼ˆæ¯æ—¥10:00ï¼‰', 'setupChatworkReminderTrigger')
    .addItem('ãƒªãƒã‚¤ãƒ³ãƒ‰è‡ªå‹•é€ä¿¡ã‚’è§£é™¤', 'deleteChatworkReminderTrigger')
    .addToUi();
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
function runMain() {
  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 2);
    main();
    SpreadsheetApp.getActiveSpreadsheet().toast('å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString(), 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 10);
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡å‡¦ç†ã‚’å®Ÿè¡Œ
 */
function runSendChatworkReminders() {
  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™...', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 2);
    sendChatworkReminders();
    SpreadsheetApp.getActiveSpreadsheet().toast('ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast('ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ã§ã‚¨ãƒ©ãƒ¼: ' + error.toString(), 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 10);
    Logger.log(`ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

/**
 * æœŸé–“ã‚’æŒ‡å®šã—ã¦è­°äº‹éŒ²ã‚’ç™»éŒ²ï¼ˆ2025/11/1ï½11/14ï¼‰
 */
function runDateRange() {
  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 2);
    
    const config = getConfig();
    
    // 2025å¹´11æœˆ1æ—¥ã‹ã‚‰11æœˆ14æ—¥ã¾ã§
    const startDate = new Date(2025, 10, 1); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§11æœˆã¯10
    startDate.setHours(0, 0, 0, 0); // 00:00:00
    
    const endDate = new Date(2025, 10, 14); // 11æœˆ14æ—¥
    endDate.setHours(23, 59, 59, 999); // 23:59:59
    
    Logger.log(`å¯¾è±¡æœŸé–“: ${startDate.toLocaleString('ja-JP')} ï½ ${endDate.toLocaleString('ja-JP')}`);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const events = getCalendarEvents(startDate, endDate);
    
    // â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetEvents = filterMarketingEvents(events, config);
    
    Logger.log(`å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${targetEvents.length}`);
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
    const spreadsheet = getOrCreateSpreadsheet(config);
    const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰
    setupSheetHeaders(sheet);
    
    // ã™ã¹ã¦ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    const allMeetingData = [];
    for (const event of targetEvents) {
      const meetingData = extractMeetingData(event);
      if (!meetingData || shouldSkipMeeting(meetingData, config)) {
        if (meetingData) {
          Logger.log(`æ‹…å½“è€…é™¤å¤–è¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName} - ${meetingData.date} æ‹…å½“è€…: ${meetingData.responsiblePersonEmail}`);
        }
        continue;
      }
      allMeetingData.push(meetingData);
    }
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
    if (allMeetingData.length > 0) {
      writeToSpreadsheet(sheet, allMeetingData);
      Logger.log(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`);
      Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${spreadsheet.getUrl()}`);
    }
    
    // MKã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²ï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ã¯å®Œäº†ã—ã¦ã„ã‚‹ï¼‰
    let mkSystemSuccessCount = 0;
    let mkSystemErrorCount = 0;
    
    if (allMeetingData.length > 0) {
      // MKã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
      if (config.MK_SYSTEM.API_ENDPOINT && 
          config.MK_SYSTEM.API_ENDPOINT !== 'https://mk-system.example.com/api/meetings') {
        Logger.log('MKã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™');
        for (const meetingData of allMeetingData) {
          try {
            const result = registerToMKSystem(meetingData, config.MK_SYSTEM);
            if (result && result.success) {
              mkSystemSuccessCount++;
            } else {
              mkSystemErrorCount++;
            }
          } catch (error) {
            mkSystemErrorCount++;
            Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ã¯ç¶šè¡Œã—ã¾ã™ï¼‰: ${meetingData.clientName} - ${error.toString()}`);
          }
        }
        Logger.log(`MKã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²çµæœ: æˆåŠŸ ${mkSystemSuccessCount}ä»¶, å¤±æ•— ${mkSystemErrorCount}ä»¶`);
      } else {
        Logger.log('MKã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šãŒæœªè¨­å®šã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      }
    }
    
    Logger.log('å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
    SpreadsheetApp.getActiveSpreadsheet().toast(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`, 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString(), 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 10);
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆå‡¦ç†
 */
function runTest() {
  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 2);
    testSingleEvent();
    SpreadsheetApp.getActiveSpreadsheet().toast('ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString(), 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 10);
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
  }
}

/**
 * ç‰¹å®šã®æ—¥ä»˜ï¼ˆ2025/11/12ï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
 */
function testSpecificDate() {
  const config = getConfig();
  
  try {
    // 2025å¹´11æœˆ12æ—¥ã‚’æŒ‡å®š
    const targetDate = new Date(2025, 10, 12); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§11æœˆã¯10
    targetDate.setHours(0, 0, 0, 0); // 00:00:00
    
    const startDate = new Date(targetDate);
    const endDate = new Date(targetDate);
    endDate.setHours(23, 59, 59, 999); // 23:59:59
    
    Logger.log(`ãƒ†ã‚¹ãƒˆå¯¾è±¡æ—¥: ${startDate.toLocaleString('ja-JP')} ï½ ${endDate.toLocaleString('ja-JP')}`);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const events = getCalendarEvents(startDate, endDate);
    Logger.log(`å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${events.length}ä»¶`);
    
    // ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    Logger.log(`å–å¾—ã—ãŸå…¨ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§:`);
    events.forEach((event, index) => {
      const title = event.getTitle();
      const description = event.getDescription() || '';
      Logger.log(`  ${index + 1}. ã‚¿ã‚¤ãƒˆãƒ«: "${title}"`);
      Logger.log(`     èª¬æ˜: "${description.substring(0, 50)}${description.length > 50 ? '...' : ''}"`);
      Logger.log(`     é–‹å§‹æ™‚åˆ»: ${event.getStartTime()}`);
      Logger.log(`     ä½œæˆè€…: ${event.getCreators().join(', ')}`);
      const attendees = event.getGuestList().map(guest => guest.getEmail());
      Logger.log(`     å‚åŠ è€…: ${attendees.join(', ')}`);
    });
    
    // â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetEvents = filterMarketingEvents(events, config);
    Logger.log(`å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${targetEvents.length}ä»¶`);
    
    if (targetEvents.length > 0) {
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
      const spreadsheet = getOrCreateSpreadsheet(config);
      const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
      setupSheetHeaders(sheet);
      
      // ã™ã¹ã¦ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const allMeetingData = [];
      for (const event of targetEvents) {
        const meetingData = extractMeetingData(event);
        if (!meetingData || shouldSkipMeeting(meetingData, config)) {
          if (meetingData) {
            Logger.log(`æ‹…å½“è€…é™¤å¤–è¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName} - ${meetingData.date} æ‹…å½“è€…: ${meetingData.responsiblePersonEmail}`);
          }
          continue;
        }
        allMeetingData.push(meetingData);
        Logger.log(`æŠ½å‡ºã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ: ${meetingData.clientName} - ${meetingData.date} ${meetingData.startTime} - æ‹…å½“è€…: ${meetingData.responsiblePerson}`);
      }
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
      if (allMeetingData.length > 0) {
        writeToSpreadsheet(sheet, allMeetingData);
        Logger.log(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`);
        Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${spreadsheet.getUrl()}`);
        SpreadsheetApp.getActiveSpreadsheet().toast(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`, 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
      }
      
      synchronizeRegistrationStatus(sheet, config, spreadsheet);
      
      synchronizeRegistrationStatus(sheet, config, spreadsheet);
      
      synchronizeRegistrationStatus(sheet, config, spreadsheet);
    } else {
      Logger.log('â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      Logger.log('ãƒ’ãƒ³ãƒˆ: ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯èª¬æ˜ã«â˜…ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      Logger.log('ãƒ’ãƒ³ãƒˆ: ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆè€…ã¾ãŸã¯å‚åŠ è€…ã«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      SpreadsheetApp.getActiveSpreadsheet().toast('å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
    }
  } catch (error) {
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    SpreadsheetApp.getActiveSpreadsheet().toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString(), 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 10);
    throw error;
  }
}

/**
 * æœŸé–“ã‚’æŒ‡å®šã—ã¦ãƒ†ã‚¹ãƒˆï¼ˆ2025/11/1ï½11/14ï¼‰
 */
function testDateRange() {
  const config = getConfig();
  
  try {
    // 2025å¹´11æœˆ1æ—¥ã‹ã‚‰11æœˆ14æ—¥ã¾ã§
    const startDate = new Date(2025, 10, 1); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§11æœˆã¯10
    startDate.setHours(0, 0, 0, 0); // 00:00:00
    
    const endDate = new Date(2025, 10, 14); // 11æœˆ14æ—¥
    endDate.setHours(23, 59, 59, 999); // 23:59:59
    
    Logger.log(`ãƒ†ã‚¹ãƒˆæœŸé–“: ${startDate.toLocaleString('ja-JP')} ï½ ${endDate.toLocaleString('ja-JP')}`);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const events = getCalendarEvents(startDate, endDate);
    Logger.log(`å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${events.length}ä»¶`);
    
    // â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetEvents = filterMarketingEvents(events, config);
    Logger.log(`å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${targetEvents.length}ä»¶`);
    
    if (targetEvents.length > 0) {
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
      const spreadsheet = getOrCreateSpreadsheet(config);
      const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
      setupSheetHeaders(sheet);
      
      // ã™ã¹ã¦ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const allMeetingData = [];
      for (const event of targetEvents) {
        const meetingData = extractMeetingData(event);
        if (!meetingData || shouldSkipMeeting(meetingData, config)) {
          if (meetingData) {
            Logger.log(`æ‹…å½“è€…é™¤å¤–è¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName} - ${meetingData.date} æ‹…å½“è€…: ${meetingData.responsiblePersonEmail}`);
          }
          continue;
        }
        allMeetingData.push(meetingData);
        Logger.log(`æŠ½å‡ºã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ: ${meetingData.clientName} - ${meetingData.date} ${meetingData.startTime} - æ‹…å½“è€…: ${meetingData.responsiblePerson}`);
      }
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
      if (allMeetingData.length > 0) {
        writeToSpreadsheet(sheet, allMeetingData);
        Logger.log(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`);
        Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${spreadsheet.getUrl()}`);
        SpreadsheetApp.getActiveSpreadsheet().toast(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`, 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
      }
    } else {
      Logger.log('â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      SpreadsheetApp.getActiveSpreadsheet().toast('å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 3);
    }
  } catch (error) {
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    SpreadsheetApp.getActiveSpreadsheet().toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString(), 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 10);
    throw error;
  }
}

/**
 * ãƒ†ã‚¹ãƒˆç”¨ï¼šâ˜…å°ãŒã¤ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²ã‚’ãƒ†ã‚¹ãƒˆ
 * å‰æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
 */
function testSingleEvent() {
  const config = getConfig();
  
  try {
    // ãƒ†ã‚¹ãƒˆæœŸé–“ï¼šå‰æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§
    const today = new Date();
    today.setHours(23, 59, 59, 999); // ä»Šæ—¥ã®23:59:59
    
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0); // å‰æ—¥ã®00:00:00
    
    Logger.log(`ãƒ†ã‚¹ãƒˆæœŸé–“: ${yesterday.toLocaleString('ja-JP')} ï½ ${today.toLocaleString('ja-JP')}`);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    const events = getCalendarEvents(yesterday, today);
    Logger.log(`å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${events.length}ä»¶`);
    
    // â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetEvents = filterMarketingEvents(events, config);
    Logger.log(`å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${targetEvents.length}ä»¶`);
    
    if (targetEvents.length > 0) {
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
      const spreadsheet = getOrCreateSpreadsheet(config);
      const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
      setupSheetHeaders(sheet);
      
      // ã™ã¹ã¦ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const allMeetingData = [];
      for (const event of targetEvents) {
        const meetingData = extractMeetingData(event);
        if (!meetingData || shouldSkipMeeting(meetingData, config)) {
          if (meetingData) {
            Logger.log(`æ‹…å½“è€…é™¤å¤–è¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${meetingData.clientName} - ${meetingData.date} æ‹…å½“è€…: ${meetingData.responsiblePersonEmail}`);
          }
          continue;
        }
        allMeetingData.push(meetingData);
        Logger.log(`æŠ½å‡ºã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ: ${meetingData.clientName} - ${meetingData.date} ${meetingData.startTime}`);
      }
      
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
      if (allMeetingData.length > 0) {
        writeToSpreadsheet(sheet, allMeetingData);
        Logger.log(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`);
        Logger.log(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${spreadsheet.getUrl()}`);
        SpreadsheetApp.getActiveSpreadsheet().toast(`${allMeetingData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ`, 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 5);
      }
    } else {
      Logger.log('â˜…å°ãŒã¤ã„ã¦ã„ã¦ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      SpreadsheetApp.getActiveSpreadsheet().toast('å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'è­°äº‹éŒ²è‡ªå‹•ç™»éŒ²', 3);
    }
  } catch (error) {
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

/**
 * ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡ã¨ã—ã¦æ‹¾ã‚ã‚Œã¦ã„ã‚‹ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
 */
function debugPendingReminders() {
  try {
    const config = getConfig();
    const spreadsheet = getOrCreateSpreadsheet(config);
    const sheet = getOrCreateSheet(spreadsheet, config.SHEET_NAME);
    const pending = getPendingMeetings(sheet, config);
    
    Logger.log('=== ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ ===');
    Logger.log(`åˆè¨ˆ: ${pending.length}ä»¶`);
    Logger.log('');
    
    pending.forEach((meeting, index) => {
      Logger.log(`--- ${index + 1}ä»¶ç›® ---`);
      Logger.log(`æ—¥ä»˜: ${meeting.date}`);
      Logger.log(`é–‹å§‹æ™‚åˆ»: ${meeting.startTime}`);
      Logger.log(`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå: ${meeting.clientName}`);
      Logger.log(`æ‹…å½“è€…: ${meeting.responsiblePerson}`);
      Logger.log(`æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«: ${meeting.responsibleEmail}`);
      Logger.log(`å‚åŠ è€…: ${meeting.participants}`);
      Logger.log('');
    });
    
    Logger.log('=== ãƒ‡ãƒãƒƒã‚°å®Œäº† ===');
    
    // ã‚¨ã‚¤ãƒãƒ¼ãƒ ã‚¦ã‚§ãƒ«ãƒã‚¹ã‚’æ¤œç´¢
    const hitamune = pending.filter(m => 
      m.clientName && (
        m.clientName.includes('ã‚¨ã‚¤ãƒãƒ¼ãƒ ') || 
        m.clientName.includes('ã‚¦ã‚§ãƒ«ãƒã‚¹') ||
        m.clientName.includes('hitamune') ||
        m.clientName.includes('HITAMUNE')
      )
    );
    
    if (hitamune.length > 0) {
      Logger.log('âš ï¸ ã‚¨ã‚¤ãƒãƒ¼ãƒ ã‚¦ã‚§ãƒ«ãƒã‚¹é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:');
      hitamune.forEach(m => {
        Logger.log(`  - ${m.date} ${m.startTime} ${m.clientName} (æ‹…å½“è€…: ${m.responsiblePerson})`);
      });
    } else {
      Logger.log('âœ“ ã‚¨ã‚¤ãƒãƒ¼ãƒ ã‚¦ã‚§ãƒ«ãƒã‚¹é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
    
  } catch (error) {
    Logger.log(`ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    Logger.log(error.stack);
  }
}

